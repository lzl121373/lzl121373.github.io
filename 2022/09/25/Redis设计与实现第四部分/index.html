<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>&lt;Redisè®¾è®¡ä¸å®ç°&gt;ç¬¬å››éƒ¨åˆ† | ğŸ˜Š</title><meta name="keywords" content="Redis,Redisè®¾è®¡ä¸å®ç°,ç‹¬ç«‹åŠŸèƒ½çš„å®ç°,å‘å¸ƒä¸è®¢é˜…,äº‹åŠ¡,Luaè„šæœ¬,æ’åº,äºŒè¿›åˆ¶ä½æ•°ç»„,æ…¢æŸ¥è¯¢æ—¥å¿—,ç›‘è§†å™¨"><meta name="author" content="lzl121373"><meta name="copyright" content="lzl121373"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="ç¬¬å››éƒ¨åˆ†ï¼ŒRedisç›¸å…³ç‹¬ç«‹åŠŸèƒ½çš„å®ç°">
<meta property="og:type" content="article">
<meta property="og:title" content="&lt;Redisè®¾è®¡ä¸å®ç°&gt;ç¬¬å››éƒ¨åˆ†">
<meta property="og:url" content="http://example.com/2022/09/25/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86/index.html">
<meta property="og:site_name" content="ğŸ˜Š">
<meta property="og:description" content="ç¬¬å››éƒ¨åˆ†ï¼ŒRedisç›¸å…³ç‹¬ç«‹åŠŸèƒ½çš„å®ç°">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-09-24T16:00:00.000Z">
<meta property="article:modified_time" content="2022-09-24T16:00:00.000Z">
<meta property="article:author" content="lzl121373">
<meta property="article:tag" content="Redis">
<meta property="article:tag" content="Redisè®¾è®¡ä¸å®ç°">
<meta property="article:tag" content="ç‹¬ç«‹åŠŸèƒ½çš„å®ç°">
<meta property="article:tag" content="å‘å¸ƒä¸è®¢é˜…">
<meta property="article:tag" content="äº‹åŠ¡">
<meta property="article:tag" content="Luaè„šæœ¬">
<meta property="article:tag" content="æ’åº">
<meta property="article:tag" content="äºŒè¿›åˆ¶ä½æ•°ç»„">
<meta property="article:tag" content="æ…¢æŸ¥è¯¢æ—¥å¿—">
<meta property="article:tag" content="ç›‘è§†å™¨">
<meta name="twitter:card" content="summary"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2022/09/25/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '<Redisè®¾è®¡ä¸å®ç°>ç¬¬å››éƒ¨åˆ†',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-09-25 00:00:00'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ğŸ˜Š" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">11</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">51</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">2</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-images"></i><span> Photo</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">ğŸ˜Š</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-images"></i><span> Photo</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">&lt;Redisè®¾è®¡ä¸å®ç°&gt;ç¬¬å››éƒ¨åˆ†</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2022-09-24T16:00:00.000Z" title="å‘è¡¨äº 2022-09-25 00:00:00">2022-09-25</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2022-09-24T16:00:00.000Z" title="æ›´æ–°äº 2022-09-25 00:00:00">2022-09-25</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">Redisè®¾è®¡ä¸å®ç°è¯»ä¹¦ç¬”è®°</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">24.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>81åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="&lt;Redisè®¾è®¡ä¸å®ç°&gt;ç¬¬å››éƒ¨åˆ†"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="ç‹¬ç«‹åŠŸèƒ½çš„å®ç°"><a href="#ç‹¬ç«‹åŠŸèƒ½çš„å®ç°" class="headerlink" title="ç‹¬ç«‹åŠŸèƒ½çš„å®ç°"></a>ç‹¬ç«‹åŠŸèƒ½çš„å®ç°</h1><h2 id="å‘å¸ƒä¸è®¢é˜…"><a href="#å‘å¸ƒä¸è®¢é˜…" class="headerlink" title="å‘å¸ƒä¸è®¢é˜…"></a>å‘å¸ƒä¸è®¢é˜…</h2><p>Redisçš„å‘å¸ƒä¸è®¢é˜…åŠŸèƒ½ç”±PUBLISHã€SUBSCRIBEã€PSUBSCRIBEç­‰å‘½ä»¤ç»„æˆã€‚</p>
<p>é€šè¿‡æ‰§è¡ŒSUBSCRIBEå‘½ä»¤ï¼Œå®¢æˆ·ç«¯å¯ä»¥è®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªé¢‘é“ï¼Œä»è€Œæˆä¸ºè¿™äº›é¢‘é“çš„è®¢é˜…è€…ï¼ˆsubscriberï¼‰ï¼šæ¯å½“æœ‰å…¶ä»–å®¢æˆ·ç«¯å‘è¢«è®¢é˜…çš„é¢‘é“å‘é€æ¶ˆæ¯ï¼ˆmessageï¼‰æ—¶ï¼Œé¢‘é“çš„æ‰€æœ‰è®¢é˜…è€…éƒ½ä¼šæ”¶åˆ°è¿™æ¡æ¶ˆæ¯ã€‚</p>
<p>é™¤äº†è®¢é˜…é¢‘é“ä¹‹å¤–ï¼Œå®¢æˆ·ç«¯è¿˜å¯ä»¥é€šè¿‡æ‰§è¡ŒPSUBSCRIBEå‘½ä»¤è®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªæ¨¡å¼ï¼Œä»è€Œæˆä¸ºè¿™äº›æ¨¡å¼çš„è®¢é˜…è€…ï¼šæ¯å½“æœ‰å…¶ä»–å®¢æˆ·ç«¯å‘æŸä¸ªé¢‘é“å‘é€æ¶ˆæ¯æ—¶ï¼Œæ¶ˆæ¯ä¸ä»…ä¼šè¢«å‘é€ç»™è¿™ä¸ªé¢‘é“çš„æ‰€æœ‰è®¢é˜…è€…ï¼Œå®ƒè¿˜ä¼šè¢«å‘é€ç»™æ‰€æœ‰ä¸è¿™ä¸ªé¢‘é“ç›¸åŒ¹é…çš„æ¨¡å¼çš„è®¢é˜…è€…ã€‚</p>
<h3 id="é¢‘é“çš„è®¢é˜…ä¸é€€è®¢"><a href="#é¢‘é“çš„è®¢é˜…ä¸é€€è®¢" class="headerlink" title="é¢‘é“çš„è®¢é˜…ä¸é€€è®¢"></a>é¢‘é“çš„è®¢é˜…ä¸é€€è®¢</h3><p>å½“ä¸€ä¸ªå®¢æˆ·ç«¯æ‰§è¡ŒSUBSCRIBEå‘½ä»¤è®¢é˜…æŸä¸ªæˆ–æŸäº›é¢‘é“çš„æ—¶å€™ï¼Œè¿™ä¸ªå®¢æˆ·ç«¯ä¸è¢«è®¢é˜…é¢‘é“ä¹‹é—´å°±å»ºç«‹èµ·äº†ä¸€ç§è®¢é˜…å…³ç³»ã€‚</p>
<p>Rediså°†æ‰€æœ‰é¢‘é“çš„è®¢é˜…å…³ç³»éƒ½ä¿å­˜åœ¨æœåŠ¡å™¨çŠ¶æ€çš„pubsub_channelså­—å…¸é‡Œé¢ï¼Œè¿™ä¸ªå­—å…¸çš„é”®æ˜¯æŸä¸ªè¢«è®¢é˜…çš„é¢‘é“ï¼Œè€Œé”®çš„å€¼åˆ™æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œé“¾è¡¨é‡Œé¢è®°å½•äº†æ‰€æœ‰è®¢é˜…è¿™ä¸ªé¢‘é“çš„å®¢æˆ·ç«¯ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisServer</span> &#123;</span></span><br><span class="line">	</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">	<span class="comment">//ä¿å­˜æ‰€æœ‰é¢‘é“çš„è®¢é˜…å…³ç³»</span></span><br><span class="line">    dict *pubsub_channels;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><img src="/..%5Cimg%5CRedis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%5Cpubsub_channels%E5%AD%97%E5%85%B8%E7%A4%BA%E4%BE%8B.png" alt="pubsub_channelså­—å…¸ç¤ºä¾‹"></p>
<h4 id="è®¢é˜…é¢‘é“"><a href="#è®¢é˜…é¢‘é“" class="headerlink" title="è®¢é˜…é¢‘é“"></a>è®¢é˜…é¢‘é“</h4><p>æ¯å½“å®¢æˆ·ç«¯æ‰§è¡ŒSUBSCRIBEå‘½ä»¤è®¢é˜…æŸä¸ªæˆ–æŸäº›é¢‘é“çš„æ—¶å€™ï¼ŒæœåŠ¡å™¨éƒ½ä¼šå°†å®¢æˆ·ç«¯ä¸è¢«è®¢é˜…çš„é¢‘é“åœ¨pubsub_channelså­—å…¸ä¸­è¿›è¡Œå…³è”ã€‚</p>
<p>æ ¹æ®é¢‘é“æ˜¯å¦å·²ç»æœ‰å…¶ä»–è®¢é˜…è€…ï¼Œå…³è”æ“ä½œåˆ†ä¸ºä¸¤ç§æƒ…å†µæ‰§è¡Œï¼š</p>
<ul>
<li>å¦‚æœé¢‘é“å·²ç»æœ‰å…¶ä»–è®¢é˜…è€…ï¼Œé‚£ä¹ˆå®ƒåœ¨pubsub_channelså­—å…¸ä¸­å¿…ç„¶æœ‰ç›¸åº”çš„è®¢é˜…è€…é“¾è¡¨ï¼Œç¨‹åºå”¯ä¸€è¦åšçš„å°±æ˜¯å°†å®¢æˆ·ç«¯æ·»åŠ åˆ°è®¢é˜…è€…é“¾è¡¨çš„æœ«å°¾ã€‚</li>
<li>å¦‚æœé¢‘é“è¿˜æœªæœ‰ä»»ä½•è®¢é˜…è€…ï¼Œé‚£ä¹ˆå®ƒå¿…ç„¶ä¸å­˜åœ¨äºpubsub_channelså­—å…¸ï¼Œç¨‹åºé¦–å…ˆè¦åœ¨pubsub_channelså­—å…¸ä¸­ä¸ºé¢‘é“åˆ›å»ºä¸€ä¸ªé”®ï¼Œå¹¶å°†è¿™ä¸ªé”®çš„å€¼è®¾ç½®ä¸ºç©ºé“¾è¡¨ï¼Œç„¶åå†å°†å®¢æˆ·ç«¯æ·»åŠ åˆ°é“¾è¡¨ï¼Œæˆä¸ºé“¾è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚</li>
</ul>
<p>SUBSCRIBEå‘½ä»¤çš„å®ç°å¯ä»¥ç”¨ä»¥ä¸‹ä¼ªä»£ç æ¥æè¿°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">def subscribe (*all_input_channels):</span><br><span class="line">	# éå†è¾“å…¥çš„æ‰€æœ‰é¢‘é“</span><br><span class="line">	for channel in all_input_channels:</span><br><span class="line">		#å¦‚æœchannelä¸å­˜åœ¨äºpubsub_channelså­—å…¸ï¼ˆæ²¡æœ‰ä»»ä½•è®¢é˜…è€…ï¼‰</span><br><span class="line">		#é‚£ä¹ˆåœ¨å­—å…¸ä¸­æ·»åŠ channelé”®ï¼Œå¹¶è®¾ç½®å®ƒçš„å€¼ä¸ºç©ºé“¾è¡¨</span><br><span class="line">		if channel not in server.pubsub_channels:</span><br><span class="line">			server.pubsub_channels[channel] = []</span><br><span class="line"></span><br><span class="line">		#å°†è®¢é˜…è€…æ·»åŠ åˆ°é¢‘é“æ‰€å¯¹åº”çš„é“¾è¡¨çš„æœ«å°¾</span><br><span class="line">		server.pubsub_channels[channel].append(client)</span><br></pre></td></tr></table></figure>

<h4 id="é€€è®¢é¢‘é“"><a href="#é€€è®¢é¢‘é“" class="headerlink" title="é€€è®¢é¢‘é“"></a>é€€è®¢é¢‘é“</h4><p>UNSUBSCRIBEå‘½ä»¤çš„è¡Œä¸ºå’ŒSUBSCRIBEå‘½ä»¤çš„è¡Œä¸ºæ­£å¥½ç›¸åï¼Œå½“ä¸€ä¸ªå®¢æˆ·ç«¯é€€è®¢æŸä¸ªæˆ–æŸäº›é¢‘é“çš„æ—¶å€™ï¼ŒæœåŠ¡å™¨å°†ä»pubsub_channelsä¸­è§£é™¤å®¢æˆ·ç«¯ä¸è¢«é€€è®¢é¢‘é“ä¹‹é—´çš„å…³è”ï¼š</p>
<ul>
<li>ç¨‹åºä¼šæ ¹æ®è¢«é€€è®¢é¢‘é“çš„åå­—ï¼Œåœ¨pubsub_channelså­—å…¸ä¸­æ‰¾åˆ°é¢‘é“å¯¹åº”çš„è®¢é˜…è€…é“¾è¡¨ï¼Œç„¶åä»è®¢é˜…è€…é“¾è¡¨ä¸­åˆ é™¤é€€è®¢å®¢æˆ·ç«¯çš„ä¿¡æ¯ã€‚</li>
<li>å¦‚æœåˆ é™¤é€€è®¢å®¢æˆ·ç«¯ä¹‹åï¼Œé¢‘é“çš„è®¢é˜…è€…é“¾è¡¨å˜æˆäº†ç©ºé“¾è¡¨ï¼Œé‚£ä¹ˆè¯´æ˜è¿™ä¸ªé¢‘é“å·²ç»æ²¡æœ‰ä»»ä½•è®¢é˜…è€…äº†ï¼Œç¨‹åºå°†ä»pubsub_channelså­—å…¸ä¸­åˆ é™¤é¢‘é“å¯¹åº”çš„é”®ã€‚</li>
</ul>
<p>UNSUBSCRIBEå‘½ä»¤çš„å®ç°å¯ä»¥ç”¨ä»¥ä¸‹ä¼ªä»£ç æ¥æè¿°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">def unsubscribe(*all_input_channels):</span><br><span class="line">	#éå†è¦é€€è®¢çš„æ‰€æœ‰é¢‘é“</span><br><span class="line">	for channel in all_input_channels:</span><br><span class="line">		#åœ¨è®¢é˜…è€…é“¾è¡¨ä¸­åˆ é™¤é€€è®¢çš„å®¢æˆ·ç«¯</span><br><span class="line">		server.pubsub_channels[channel].remove(client)</span><br><span class="line">		#å¦‚æœé¢‘é“å·²ç»æ²¡æœ‰ä»»ä½•è®¢é˜…è€…äº†ï¼ˆè®¢é˜…è€…é“¾è¡¨ä¸ºç©ºï¼‰</span><br><span class="line">		#é‚£ä¹ˆå°†é¢‘é“ä»å­—å…¸ä¸­åˆ é™¤</span><br><span class="line">		if len(server.pubsub_channels[channel]) == 0:</span><br><span class="line">			server.pubsub_channels.remove (channel)</span><br></pre></td></tr></table></figure>

<h3 id="æ¨¡å¼çš„è®¢é˜…ä¸é€€è®¢"><a href="#æ¨¡å¼çš„è®¢é˜…ä¸é€€è®¢" class="headerlink" title="æ¨¡å¼çš„è®¢é˜…ä¸é€€è®¢"></a>æ¨¡å¼çš„è®¢é˜…ä¸é€€è®¢</h3><p>å‰é¢è¯´è¿‡ï¼ŒæœåŠ¡å™¨å°†æ‰€æœ‰é¢‘é“çš„è®¢é˜…å…³ç³»éƒ½ä¿å­˜åœ¨æœåŠ¡å™¨çŠ¶æ€çš„pubsub_channelså±æ€§é‡Œé¢ï¼Œä¸æ­¤ç±»ä¼¼ï¼ŒæœåŠ¡å™¨ä¹Ÿå°†æ‰€æœ‰æ¨¡å¼çš„è®¢é˜…å…³ç³»éƒ½ä¿å­˜åœ¨æœåŠ¡å™¨çŠ¶æ€çš„pubsub_patternså±æ€§é‡Œé¢ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisServer</span> &#123;</span></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä¿å­˜æ‰€æœ‰æ¨¡å¼è®¢é˜…å…³ç³»</span></span><br><span class="line">    <span class="built_in">list</span> *pubsub_patterns;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


<p>pubsub_patternså±æ€§æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œé“¾è¡¨ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½åŒ…å«ç€ä¸€ä¸ªpubsubPatternç»“æ„ï¼Œè¿™ä¸ªç»“æ„çš„patternå±æ€§è®°å½•äº†è¢«è®¢é˜…çš„æ¨¡å¼ï¼Œè€Œclientå±æ€§åˆ™è®°å½•äº†è®¢é˜…æ¨¡å¼çš„å®¢æˆ·ç«¯ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">pubsubPattern</span> &#123;</span></span><br><span class="line">	</span><br><span class="line">    <span class="comment">//è®¢é˜…æ¨¡å¼çš„å®¢æˆ·ç«¯</span></span><br><span class="line">    redisClient *client;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">//è¢«è®¢é˜…çš„æ¨¡å¼</span></span><br><span class="line">	robj *pattern;</span><br><span class="line">&#125; pubsubPattern;</span><br></pre></td></tr></table></figure>

<h4 id="è®¢é˜…æ¨¡å¼"><a href="#è®¢é˜…æ¨¡å¼" class="headerlink" title="è®¢é˜…æ¨¡å¼"></a>è®¢é˜…æ¨¡å¼</h4><p>æ¯å½“å®¢æˆ·ç«¯æ‰§è¡ŒPSUBSCRIBEå‘½ä»¤è®¢é˜…æŸä¸ªæˆ–æŸäº›æ¨¡å¼çš„æ—¶å€™ï¼ŒæœåŠ¡å™¨ä¼šå¯¹æ¯ä¸ªè¢«è®¢é˜…çš„æ¨¡å¼æ‰§è¡Œä»¥ä¸‹ä¸¤ä¸ªæ“ä½œï¼š</p>
<ol>
<li>æ–°å»ºä¸€ä¸ªpubsubPatternç»“æ„ï¼Œå°†ç»“æ„çš„patternå±æ€§è®¾ç½®ä¸ºè¢«è®¢é˜…çš„æ¨¡å¼ï¼Œclientå±æ€§è®¾ç½®ä¸ºè®¢é˜…æ¨¡å¼çš„å®¢æˆ·ç«¯ã€‚</li>
<li>å°†pubsubPatternç»“æ„æ·»åŠ åˆ°pubsub_patternsé“¾è¡¨çš„è¡¨å°¾ã€‚</li>
</ol>
<p>PSUBSCRIBEå‘½ä»¤çš„å®ç°åŸç†å¯ä»¥ç”¨ä»¥ä¸‹ä¼ªä»£ç æ¥æè¿°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">def psubscribe(*all_input_patterns):</span><br><span class="line">	#éå†è¾“å…¥çš„æ‰€æœ‰æ¨¡å¼</span><br><span class="line">	for pattern in all_input_patterns:</span><br><span class="line">		#åˆ›å»ºæ–°çš„pubsubPatternç»“æ„</span><br><span class="line">		#è®°å½•è¢«è®¢é˜…çš„æ¨¡å¼ï¼Œä»¥åŠè®¢é˜…æ¨¡å¼çš„å®¢æˆ·ç«¯</span><br><span class="line">		pubsubPattern = create_new_pubsubPattern()</span><br><span class="line">		pubsubPattern.client = client</span><br><span class="line">		pubsubPattern.pattern = pattern</span><br><span class="line"></span><br><span class="line">		#å°†æ–°çš„pubsubPatternè¿½åŠ åˆ°pubsub_patternsé“¾è¡¨æœ«å°¾</span><br><span class="line">		server.pubsub_patterns.append(pubsubPattern)</span><br></pre></td></tr></table></figure>

<h4 id="é€€è®¢æ¨¡å¼"><a href="#é€€è®¢æ¨¡å¼" class="headerlink" title="é€€è®¢æ¨¡å¼"></a>é€€è®¢æ¨¡å¼</h4><p>æ¨¡å¼çš„é€€è®¢å‘½ä»¤PUNSUBSCRIBEæ˜¯PSUBSCRIBEå‘½ä»¤çš„åæ“ä½œï¼šå½“ä¸€ä¸ªå®¢æˆ·ç«¯é€€è®¢æŸä¸ªæˆ–æŸäº›æ¨¡å¼çš„æ—¶å€™ï¼ŒæœåŠ¡å™¨å°†åœ¨pubsub_patternsé“¾è¡¨ä¸­æŸ¥æ‰¾å¹¶åˆ é™¤é‚£äº›patternå±æ€§ä¸ºè¢«é€€è®¢æ¨¡å¼ï¼Œå¹¶ä¸”clientå±æ€§ä¸ºæ‰§è¡Œé€€è®¢å‘½ä»¤çš„å®¢æˆ·ç«¯çš„pubsubPatternç»“æ„ã€‚</p>
<p>PUNSUBSCRIBEå‘½ä»¤çš„å®ç°åŸç†å¯ä»¥ç”¨ä»¥ä¸‹ä¼ªä»£ç æ¥æè¿°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">def punsubscribe(*all_input_patterns):</span><br><span class="line">	#éå†æ‰€æœ‰è¦é€€è®¢çš„æ¨¡å¼</span><br><span class="line">	for pattern in all_input_patterns:</span><br><span class="line">		#éå†pubsub_patternsé“¾è¡¨ä¸­çš„æ‰€æœ‰pubsubPatternç»“æ„</span><br><span class="line">		for pubsubPattern in server.pubsub_patterns:</span><br><span class="line">		</span><br><span class="line">			#å¦‚æœå½“å‰å®¢æˆ·ç«¯å’ŒpubsubPatternè®°å½•çš„å®¢æˆ·ç«¯ç›¸åŒ</span><br><span class="line">			#å¹¶ä¸”è¦é€€è®¢çš„æ¨¡å¼ä¹Ÿå’ŒpubsubPatternè®°å½•çš„æ¨¡å¼ç›¸åŒ</span><br><span class="line">			if client == pubsubPattern.client and \</span><br><span class="line">				pattern == pubsubPattern.pattern:</span><br><span class="line"></span><br><span class="line">				#é‚£ä¹ˆå°†è¿™ä¸ªpubsubPatternä»é“¾è¡¨ä¸­åˆ é™¤</span><br><span class="line">				server.pubsub_patterns.remove(pubsubPattern)</span><br></pre></td></tr></table></figure>

<h3 id="å‘é€æ¶ˆæ¯"><a href="#å‘é€æ¶ˆæ¯" class="headerlink" title="å‘é€æ¶ˆæ¯"></a>å‘é€æ¶ˆæ¯</h3><p>å½“ä¸€ä¸ªRediså®¢æˆ·ç«¯æ‰§è¡ŒPUBLISH &lt;channel&gt; &lt;message&gt;å‘½ä»¤å°†æ¶ˆæ¯messageå‘é€ç»™é¢‘é“channelçš„æ—¶å€™ï¼ŒæœåŠ¡å™¨éœ€è¦æ‰§è¡Œä»¥ä¸‹ä¸¤ä¸ªåŠ¨ä½œï¼š</p>
<ol>
<li>å°†æ¶ˆæ¯messageå‘é€ç»™channelé¢‘é“çš„æ‰€æœ‰è®¢é˜…è€…ã€‚</li>
<li>å¦‚æœæœ‰ä¸€ä¸ªæˆ–å¤šä¸ªæ¨¡å¼patternä¸é¢‘é“channelç›¸åŒ¹é…ï¼Œé‚£ä¹ˆå°†æ¶ˆæ¯messageå‘é€ç»™patternæ¨¡å¼çš„è®¢é˜…è€…ã€‚</li>
</ol>
<h4 id="å°†æ¶ˆæ¯å‘é€ç»™é¢‘é“è®¢é˜…è€…"><a href="#å°†æ¶ˆæ¯å‘é€ç»™é¢‘é“è®¢é˜…è€…" class="headerlink" title="å°†æ¶ˆæ¯å‘é€ç»™é¢‘é“è®¢é˜…è€…"></a>å°†æ¶ˆæ¯å‘é€ç»™é¢‘é“è®¢é˜…è€…</h4><p>å› ä¸ºæœåŠ¡å™¨çŠ¶æ€ä¸­çš„pubsub_channelså­—å…¸è®°å½•äº†æ‰€æœ‰é¢‘é“çš„è®¢é˜…å…³ç³»ï¼Œæ‰€ä»¥ä¸ºäº†å°†æ¶ˆæ¯å‘é€ç»™channelé¢‘é“çš„æ‰€æœ‰è®¢é˜…è€…ï¼ŒPUBLISHå‘½ä»¤è¦åšçš„å°±æ˜¯åœ¨pubsub_channelså­—å…¸é‡Œæ‰¾åˆ°é¢‘é“channelçš„è®¢é˜…è€…åå•ï¼ˆä¸€ä¸ªé“¾è¡¨ï¼‰ï¼Œç„¶åå°†æ¶ˆæ¯å‘é€ç»™åå•ä¸Šçš„æ‰€æœ‰å®¢æˆ·ç«¯ã€‚</p>
<p>PUBLISHå‘½ä»¤å°†æ¶ˆæ¯å‘é€ç»™é¢‘é“è®¢é˜…è€…çš„æ–¹æ³•å¯ä»¥ç”¨ä»¥ä¸‹ä¼ªä»£ç æ¥æè¿°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">def channel_publish(channel, message):</span><br><span class="line">	#å¦‚æœchannelé”®ä¸å­˜åœ¨äºpubsub_channelså­—å…¸ä¸­</span><br><span class="line">	#é‚£ä¹ˆè¯´æ˜channelé¢‘é“æ²¡æœ‰ä»»ä½•è®¢é˜…è€…</span><br><span class="line">	#ç¨‹åºä¸åšå‘é€åŠ¨ä½œï¼Œç›´æ¥è¿”å›</span><br><span class="line">	if channel not in server.pubsub_channels:</span><br><span class="line">		return</span><br><span class="line"></span><br><span class="line">	#è¿è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜channelé¢‘é“è‡³å°‘æœ‰ä¸€ä¸ªè®¢é˜…è€…</span><br><span class="line">	#ç¨‹åºéå†channelé¢‘é“çš„è®¢é˜…è€…é“¾è¡¨</span><br><span class="line">	#å°†æ¶ˆæ¯å‘é€ç»™æ‰€æœ‰è®¢é˜…è€…</span><br><span class="line">	for subscriber in server.pubsub_channels[channel]:</span><br><span class="line">		send_message(subscriber, message)</span><br></pre></td></tr></table></figure>

<h4 id="å°†æ¶ˆæ¯å‘é€ç»™æ¨¡å¼è®¢é˜…è€…"><a href="#å°†æ¶ˆæ¯å‘é€ç»™æ¨¡å¼è®¢é˜…è€…" class="headerlink" title="å°†æ¶ˆæ¯å‘é€ç»™æ¨¡å¼è®¢é˜…è€…"></a>å°†æ¶ˆæ¯å‘é€ç»™æ¨¡å¼è®¢é˜…è€…</h4><p>å› ä¸ºæœåŠ¡å™¨çŠ¶æ€ä¸­çš„pubsub_patternsé“¾è¡¨è®°å½•äº†æ‰€æœ‰æ¨¡å¼çš„è®¢é˜…å…³ç³»ï¼Œæ‰€ä»¥ä¸ºäº†å°†æ¶ˆæ¯å‘é€ç»™æ‰€æœ‰ä¸channelé¢‘é“ç›¸åŒ¹é…çš„æ¨¡å¼çš„è®¢é˜…è€…ï¼ŒPUBLISHå‘½ä»¤è¦åšçš„å°±æ˜¯éå†æ•´ä¸ªpubsub_patternsé“¾è¡¨ï¼ŒæŸ¥æ‰¾é‚£äº›ä¸channelé¢‘é“ç›¸åŒ¹é…çš„æ¨¡å¼ï¼Œå¹¶å°†æ¶ˆæ¯å‘é€ç»™è®¢é˜…äº†è¿™äº›æ¨¡å¼çš„å®¢æˆ·ç«¯ã€‚</p>
<p>PUBLISHå‘½ä»¤å°†æ¶ˆæ¯å‘é€ç»™æ¨¡å¼è®¢é˜…è€…çš„æ–¹æ³•å¯ä»¥ç”¨ä»¥ä¸‹ä¼ªä»£ç æ¥æè¿°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">def pattern_publish(channel, message):</span><br><span class="line">	#éå†æ‰€æœ‰æ¨¡å¼è®¢é˜…æ¶ˆæ¯</span><br><span class="line">	for pubsubPattern in server.pubsub_patterns:</span><br><span class="line">		#å¦‚æœé¢‘é“å’Œæ¨¡å¼ç›¸åŒ¹é…</span><br><span class="line">		if match(channel, pubsubPattern.pattern):</span><br><span class="line">			#é‚£ä¹ˆå°†æ¶ˆæ¯å‘é€ç»™è®¢é˜…è¯¥æ¨¡å¼çš„å®¢æˆ·ç«¯</span><br><span class="line">			send_message(pubsubPattern.client, message)</span><br></pre></td></tr></table></figure>


<p>æœ€åï¼ŒPUBLISHå‘½ä»¤çš„å®ç°å¯ä»¥ç”¨ä»¥ä¸‹ä¼ªä»£ç æ¥æè¿°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">def publish(channel, message):</span><br><span class="line">	#å°†æ¶ˆæ¯å‘é€ç»™channelé¢‘é“çš„æ‰€æœ‰è®¢é˜…è€…</span><br><span class="line">	channel_publish(channel, message)</span><br><span class="line">	#å°†æ¶ˆæ¯å‘é€ç»™æ‰€æœ‰å’Œchannelé¢‘é“ç›¸åŒ¹é…çš„æ¨¡å¼çš„è®¢é˜…è€…</span><br><span class="line">	pattern_publish(channel,message)</span><br></pre></td></tr></table></figure>

<h3 id="æŸ¥çœ‹è®¢é˜…æ¶ˆæ¯"><a href="#æŸ¥çœ‹è®¢é˜…æ¶ˆæ¯" class="headerlink" title="æŸ¥çœ‹è®¢é˜…æ¶ˆæ¯"></a>æŸ¥çœ‹è®¢é˜…æ¶ˆæ¯</h3><p>PUBSUBå‘½ä»¤æ˜¯Redis 2.8æ–°å¢åŠ çš„å‘½ä»¤ä¹‹ä¸€ï¼Œå®¢æˆ·ç«¯å¯ä»¥é€šè¿‡è¿™ä¸ªå‘½ä»¤æ¥æŸ¥çœ‹é¢‘é“æˆ–è€…æ¨¡å¼çš„ç›¸å…³ä¿¡æ¯ï¼Œæ¯”å¦‚æŸä¸ªé¢‘é“ç›®å‰æœ‰å¤šå°‘è®¢é˜…è€…ï¼Œåˆæˆ–è€…æŸä¸ªæ¨¡å¼ç›®å‰æœ‰å¤šå°‘è®¢é˜…è€…ï¼Œè¯¸å¦‚æ­¤ç±»ã€‚</p>
<h4 id="PUBSUB-CHANNELS"><a href="#PUBSUB-CHANNELS" class="headerlink" title="PUBSUB CHANNELS"></a>PUBSUB CHANNELS</h4><p>PUBSUB CHANNELS [pattern]å­å‘½ä»¤ç”¨äºè¿”å›æœåŠ¡å™¨å½“å‰è¢«è®¢é˜…çš„é¢‘é“ï¼Œå…¶ä¸­patternå‚æ•°æ˜¯å¯é€‰çš„ï¼š</p>
<ul>
<li>å¦‚æœä¸ç»™å®špatternå‚æ•°ï¼Œé‚£ä¹ˆå‘½ä»¤è¿”å›æœåŠ¡å™¨å½“å‰è¢«è®¢é˜…çš„æ‰€æœ‰é¢‘é“ã€‚</li>
<li>å¦‚æœç»™å®špatternå‚æ•°ï¼Œé‚£ä¹ˆå‘½ä»¤è¿”å›æœåŠ¡å™¨å½“å‰è¢«è®¢é˜…çš„é¢‘é“ä¸­é‚£äº›ä¸patternæ¨¡å¼ç›¸åŒ¹é…çš„é¢‘é“ã€‚</li>
</ul>
<p>è¿™ä¸ªå­å‘½ä»¤æ˜¯é€šè¿‡éå†æœåŠ¡å™¨pubsub_channelså­—å…¸çš„æ‰€æœ‰é”®ï¼ˆæ¯ä¸ªé”®éƒ½æ˜¯ä¸€ä¸ªè¢«è®¢é˜…çš„é“é“)ï¼Œç„¶åè®°å½•å¹¶è¿”å›æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„é¢‘é“æ¥å®ç°çš„ï¼Œè¿™ä¸ªè¿‡ç¨‹å¯ä»¥ç”¨ä»¥ä¸‹ä¼ªä»£ç æ¥æè¿°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">def pubsub_channels(pattern=None):</span><br><span class="line">	#ä¸€ä¸ªåˆ—è¡¨ï¼Œç”¨äºè®°å½•æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„é¢‘é“</span><br><span class="line">	channel_list = []</span><br><span class="line">	</span><br><span class="line">	#éå†æœåŠ¡å™¨ä¸­çš„æ‰€æœ‰é¢‘é“</span><br><span class="line">	#ï¼ˆä¹Ÿå³æ˜¯pubsub_channelså­—å…¸çš„æ‰€æœ‰é”®ï¼‰</span><br><span class="line">	for channel in server.pubsub_channels:</span><br><span class="line">		#å½“ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶çš„ä»»æ„ä¸€ä¸ªæ»¡è¶³æ—¶ï¼Œå°†é¢‘é“æ·»åŠ åˆ°é“¾è¡¨é‡Œé¢:</span><br><span class="line">		#1)ç”¨æˆ·æ²¡æœ‰æŒ‡å®špatternå‚æ•°</span><br><span class="line">		#2)ç”¨æˆ·æŒ‡å®šäº†patternå‚æ•°ï¼Œå¹¶ä¸”channelå’ŒpatternåŒ¹é…</span><br><span class="line">		if (pattern is None) or match (channel, pattern):</span><br><span class="line">			channel_list.append(channel)</span><br><span class="line"></span><br><span class="line">	#å‘å®¢æˆ·ç«¯è¿”å›é¢‘é“åˆ—è¡¨</span><br><span class="line">	return channel_list</span><br></pre></td></tr></table></figure>

<h4 id="PUBSUB-NUMSUB"><a href="#PUBSUB-NUMSUB" class="headerlink" title="PUBSUB NUMSUB"></a>PUBSUB NUMSUB</h4><p>PUBSUB NUMSUB [channel-1 channel-2 â€¦ channel-n]å­å‘½ä»¤æ¥å—ä»»æ„å¤šä¸ªé¢‘é“ä½œä¸ºè¾“å…¥å‚æ•°ï¼Œå¹¶è¿”å›è¿™äº›é¢‘é“çš„è®¢é˜…è€…æ•°é‡ã€‚</p>
<p>è¿™ä¸ªå­å‘½ä»¤æ˜¯é€šè¿‡åœ¨pubsub_channelså­—å…¸ä¸­æ‰¾åˆ°é¢‘é“å¯¹åº”çš„è®¢é˜…è€…é“¾è¡¨ï¼Œç„¶åè¿”å›è®¢é˜…è€…é“¾è¡¨çš„é•¿åº¦æ¥å®ç°çš„ï¼ˆè®¢é˜…è€…é“¾è¡¨çš„é•¿åº¦å°±æ˜¯é¢‘é“è®¢é˜…è€…çš„æ•°é‡ï¼‰ï¼Œè¿™ä¸ªè¿‡ç¨‹å¯ä»¥ç”¨ä»¥ä¸‹ä¼ªä»£ç æ¥æè¿°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">def pubsub_numsub(*all_input_channels):</span><br><span class="line">	#éå†è¾“å…¥çš„æ‰€æœ‰é¢‘é“</span><br><span class="line">	for channel in all_input_channels:</span><br><span class="line">		#å¦‚æœpubsub_channelså­—å…¸ä¸­æ²¡æœ‰channelè¿™ä¸ªé”®</span><br><span class="line">		#é‚£ä¹ˆè¯´æ˜channelé¢‘é“æ²¡æœ‰ä»»ä½•è®¢é˜…è€…</span><br><span class="line">		if channel not in server.pubsub_channels:</span><br><span class="line">			#è¿”å›é¢‘é“å</span><br><span class="line">			reply_channel_name(channel)</span><br><span class="line">			#è®¢é˜…è€…æ•°é‡ä¸º0</span><br><span class="line">			reply_subscribe_count(0)</span><br><span class="line"></span><br><span class="line">		#å¦‚æœpubsub_channelså­—å…¸ä¸­å­˜åœ¨channelé”®</span><br><span class="line">		#é‚£ä¹ˆè¯´æ˜channelé¢‘é“è‡³å°‘æœ‰ä¸€ä¸ªè®¢é˜…è€…</span><br><span class="line">		else:</span><br><span class="line">			#è¿”å›é¢‘é“å</span><br><span class="line">			reply_channel_name(channel)</span><br><span class="line">			#è®¢é˜…è€…é“¾è¡¨çš„é•¿åº¦å°±æ˜¯è®¢é˜…è€…æ•°é‡</span><br><span class="line">			reply_subscribe_count(len(server.pubsub_channels[channel]))</span><br></pre></td></tr></table></figure>

<h4 id="PUBSUB-NUMPAT"><a href="#PUBSUB-NUMPAT" class="headerlink" title="PUBSUB NUMPAT"></a>PUBSUB NUMPAT</h4><p>PUBSUB NUMPATå­å‘½ä»¤ç”¨äºè¿”å›æœåŠ¡å™¨å½“å‰è¢«è®¢é˜…æ¨¡å¼çš„æ•°é‡ã€‚</p>
<p>è¿™ä¸ªå­å‘½ä»¤æ˜¯é€šè¿‡è¿”å›pubsub_patternsé“¾è¡¨çš„é•¿åº¦æ¥å®ç°çš„ï¼Œå› ä¸ºè¿™ä¸ªé“¾è¡¨çš„é•¿åº¦å°±æ˜¯æœåŠ¡å™¨è¢«è®¢é˜…æ¨¡å¼çš„æ•°é‡ï¼Œè¿™ä¸ªè¿‡ç¨‹å¯ä»¥ç”¨ä»¥ä¸‹ä¼ªä»£ç æ¥æè¿°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">def pubsub_numpat():</span><br><span class="line">	# pubsub_patternsé“¾è¡¨çš„é•¿åº¦å°±æ˜¯è¢«è®¢é˜…æ¨¡å¼çš„æ•°é‡</span><br><span class="line">	reply_pattern_count(len(server.pubsub_patterns))</span><br></pre></td></tr></table></figure>

<h2 id="äº‹åŠ¡"><a href="#äº‹åŠ¡" class="headerlink" title="äº‹åŠ¡"></a>äº‹åŠ¡</h2><p>Redisé€šè¿‡MULTIã€EXECã€WATCHç­‰å‘½ä»¤æ¥å®ç°äº‹åŠ¡ï¼ˆtransactionï¼‰åŠŸèƒ½ã€‚äº‹åŠ¡æä¾›äº†ä¸€ç§å°†å¤šä¸ªå‘½ä»¤è¯·æ±‚æ‰“åŒ…ï¼Œç„¶åä¸€æ¬¡æ€§ã€æŒ‰é¡ºåºåœ°æ‰§è¡Œå¤šä¸ªå‘½ä»¤çš„æœºåˆ¶ï¼Œå¹¶ä¸”åœ¨äº‹åŠ¡æ‰§è¡ŒæœŸé—´ï¼ŒæœåŠ¡å™¨ä¸ä¼šä¸­æ–­äº‹åŠ¡è€Œæ”¹å»æ‰§è¡Œå…¶ä»–å®¢æˆ·ç«¯çš„å‘½ä»¤è¯·æ±‚ï¼Œå®ƒä¼šå°†äº‹åŠ¡ä¸­çš„æ‰€æœ‰å‘½ä»¤éƒ½æ‰§è¡Œå®Œæ¯•ï¼Œç„¶åæ‰å»å¤„ç†å…¶ä»–å®¢æˆ·ç«¯çš„å‘½ä»¤è¯·æ±‚ã€‚</p>
<p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œçš„è¿‡ç¨‹ï¼Œè¯¥äº‹åŠ¡é¦–å…ˆä»¥ä¸€ä¸ªMULTIå‘½ä»¤ä¸ºå¼€å§‹ï¼Œæ¥ç€å°†å¤šä¸ªå‘½ä»¤æ”¾å…¥äº‹åŠ¡å½“ä¸­ï¼Œæœ€åç”±EXECå‘½ä»¤å°†è¿™ä¸ªäº‹åŠ¡æäº¤ï¼ˆcommitï¼‰ç»™æœåŠ¡å™¨æ‰§è¡Œï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">redis&gt; MULTI</span><br><span class="line">OK</span><br><span class="line">redis&gt; SET &quot;name&quot; &quot;Practical Common Lisp&quot;</span><br><span class="line">QUEUED</span><br><span class="line">redis&gt; GET &quot;name&quot;</span><br><span class="line">QUEUED</span><br><span class="line">redis&gt; SET &quot;author&quot; &quot;Peter seibel&quot;</span><br><span class="line">QUEUED</span><br><span class="line">redis&gt; GET &quot;author&quot;</span><br><span class="line">QUEUED</span><br><span class="line">redis&gt; EXEC</span><br><span class="line">1)OK</span><br><span class="line">2)&quot;Practical Common Lisp&quot;</span><br><span class="line">3)OK</span><br><span class="line">4)&quot;Peter seibel&quot;</span><br></pre></td></tr></table></figure>

<h3 id="äº‹åŠ¡çš„å®ç°"><a href="#äº‹åŠ¡çš„å®ç°" class="headerlink" title="äº‹åŠ¡çš„å®ç°"></a>äº‹åŠ¡çš„å®ç°</h3><p>ä¸€ä¸ªäº‹åŠ¡ä»å¼€å§‹åˆ°ç»“æŸé€šå¸¸ä¼šç»å†ä»¥ä¸‹ä¸‰ä¸ªé˜¶æ®µï¼š</p>
<ol>
<li>äº‹åŠ¡å¼€å§‹ã€‚</li>
<li>å‘½ä»¤å…¥é˜Ÿã€‚</li>
<li>äº‹åŠ¡æ‰§è¡Œã€‚</li>
</ol>
<h4 id="äº‹åŠ¡å¼€å§‹"><a href="#äº‹åŠ¡å¼€å§‹" class="headerlink" title="äº‹åŠ¡å¼€å§‹"></a>äº‹åŠ¡å¼€å§‹</h4><p>MULTIå‘½ä»¤çš„æ‰§è¡Œæ ‡å¿—ç€äº‹åŠ¡çš„å¼€å§‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis&gt; MULTI</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>


<p>MULTIå‘½ä»¤å¯ä»¥å°†æ‰§è¡Œè¯¥å‘½ä»¤çš„å®¢æˆ·ç«¯ä»éäº‹åŠ¡çŠ¶æ€åˆ‡æ¢è‡³äº‹åŠ¡çŠ¶æ€ï¼Œè¿™ä¸€åˆ‡æ¢æ˜¯é€šè¿‡åœ¨å®¢æˆ·ç«¯çŠ¶æ€çš„flagså±æ€§ä¸­æ‰“å¼€REDIS_MULTIæ ‡è¯†æ¥å®Œæˆçš„ï¼ŒMULTIå‘½ä»¤çš„å®ç°å¯ä»¥ç”¨ä»¥ä¸‹ä¼ªä»£ç æ¥è¡¨ç¤ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">def MULTI():</span><br><span class="line">	#æ‰“å¼€äº‹åŠ¡æ ‡è¯†</span><br><span class="line">	client.flags |= REDIS_MULTI</span><br><span class="line">	#è¿”å›OKå›å¤</span><br><span class="line">	replyOK()</span><br></pre></td></tr></table></figure>

<h4 id="å‘½ä»¤å…¥é˜Ÿ"><a href="#å‘½ä»¤å…¥é˜Ÿ" class="headerlink" title="å‘½ä»¤å…¥é˜Ÿ"></a>å‘½ä»¤å…¥é˜Ÿ</h4><p>å½“ä¸€ä¸ªå®¢æˆ·ç«¯å¤„äºéäº‹åŠ¡çŠ¶æ€æ—¶ï¼Œè¿™ä¸ªå®¢æˆ·ç«¯å‘é€çš„å‘½ä»¤ä¼šç«‹å³è¢«æœåŠ¡å™¨æ‰§è¡Œã€‚</p>
<p>ä¸æ­¤ä¸åŒçš„æ˜¯ï¼Œå½“ä¸€ä¸ªå®¢æˆ·ç«¯åˆ‡æ¢åˆ°äº‹åŠ¡çŠ¶æ€ä¹‹åï¼ŒæœåŠ¡å™¨ä¼šæ ¹æ®è¿™ä¸ªå®¢æˆ·ç«¯å‘æ¥çš„ä¸åŒå‘½ä»¤æ‰§è¡Œä¸åŒçš„æ“ä½œï¼š</p>
<ul>
<li>å¦‚æœå®¢æˆ·ç«¯å‘é€çš„å‘½ä»¤ä¸ºEXECã€DISCARDã€WATCHã€MULTIå››ä¸ªå‘½ä»¤çš„å…¶ä¸­ä¸€ä¸ªï¼Œé‚£ä¹ˆæœåŠ¡å™¨ç«‹å³æ‰§è¡Œè¿™ä¸ªå‘½ä»¤ã€‚</li>
<li>ä¸æ­¤ç›¸åï¼Œå¦‚æœå®¢æˆ·ç«¯å‘é€çš„å‘½ä»¤æ˜¯EXECã€DISCARDã€WATCHã€MULTIå››ä¸ªå‘½ä»¤ä»¥å¤–çš„å…¶ä»–å‘½ä»¤ï¼Œé‚£ä¹ˆæœåŠ¡å™¨å¹¶ä¸ç«‹å³æ‰§è¡Œè¿™ä¸ªå‘½ä»¤ï¼Œè€Œæ˜¯å°†è¿™ä¸ªå‘½ä»¤æ”¾å…¥ä¸€ä¸ªäº‹åŠ¡é˜Ÿåˆ—é‡Œé¢ï¼Œç„¶åå‘å®¢æˆ·ç«¯è¿”å›QUEUEDå›å¤ã€‚</li>
</ul>
<h4 id="äº‹åŠ¡é˜Ÿåˆ—"><a href="#äº‹åŠ¡é˜Ÿåˆ—" class="headerlink" title="äº‹åŠ¡é˜Ÿåˆ—"></a>äº‹åŠ¡é˜Ÿåˆ—</h4><p>æ¯ä¸ªRediså®¢æˆ·ç«¯éƒ½æœ‰è‡ªå·±çš„äº‹åŠ¡çŠ¶æ€ï¼Œè¿™ä¸ªäº‹åŠ¡çŠ¶æ€ä¿å­˜åœ¨å®¢æˆ·ç«¯çŠ¶æ€çš„mstateå±æ€§é‡Œé¢ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisClient</span> &#123;</span></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	</span><br><span class="line">    <span class="comment">//äº‹åŠ¡çŠ¶æ€</span></span><br><span class="line">	multiState mstate;	<span class="comment">/* MULTI/EXEC state */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125; redisClient;</span><br></pre></td></tr></table></figure>


<p>äº‹åŠ¡çŠ¶æ€åŒ…å«ä¸€ä¸ªäº‹åŠ¡é˜Ÿåˆ—ï¼Œä»¥åŠä¸€ä¸ªå·²äººé˜Ÿå‘½ä»¤çš„è®¡æ•°å™¨ï¼ˆä¹Ÿå¯ä»¥è¯´æ˜¯äº‹åŠ¡é˜Ÿåˆ—çš„é•¿åº¦ï¼‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">multiState</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//äº‹åŠ¡é˜Ÿåˆ—ï¼ŒFIFOé¡ºåº</span></span><br><span class="line">    multiCmd *commands;</span><br><span class="line">    <span class="comment">//å·²å…¥é˜Ÿå‘½ä»¤è®¡æ•°</span></span><br><span class="line">    <span class="type">int</span> count;</span><br><span class="line"></span><br><span class="line">&#125; multiState;</span><br></pre></td></tr></table></figure>

<p>äº‹åŠ¡é˜Ÿåˆ—æ˜¯ä¸€ä¸ªmultiCmdç±»å‹çš„æ•°ç»„ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸ªmultiCmdç»“æ„éƒ½ä¿å­˜äº†ä¸€ä¸ªå·²å…¥é˜Ÿå‘½ä»¤çš„ç›¸å…³ä¿¡æ¯ï¼ŒåŒ…æ‹¬æŒ‡å‘å‘½ä»¤å®ç°å‡½æ•°çš„æŒ‡é’ˆã€å‘½ä»¤çš„å‚æ•°ï¼Œä»¥åŠå‚æ•°çš„æ•°é‡ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">multiCmd</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//å‚æ•°</span></span><br><span class="line">	robj **argv;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å‚æ•°æ•°é‡</span></span><br><span class="line">    <span class="type">int</span> argc;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å‘½ä»¤æŒ‡é’ˆ</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">redisCommand</span> *<span class="title">cmd</span>;</span></span><br><span class="line">&#125; multiCmd;</span><br></pre></td></tr></table></figure>


<p>äº‹åŠ¡é˜Ÿåˆ—ä»¥å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰çš„æ–¹å¼ä¿å­˜å…¥é˜Ÿçš„å‘½ä»¤ï¼Œè¾ƒå…ˆäººé˜Ÿçš„å‘½ä»¤ä¼šè¢«æ”¾åˆ°æ•°ç»„çš„å‰é¢ï¼Œè€Œè¾ƒåå…¥é˜Ÿçš„å‘½ä»¤åˆ™ä¼šè¢«æ”¾åˆ°æ•°ç»„çš„åé¢ã€‚</p>
<h4 id="æ‰§è¡Œäº‹åŠ¡"><a href="#æ‰§è¡Œäº‹åŠ¡" class="headerlink" title="æ‰§è¡Œäº‹åŠ¡"></a>æ‰§è¡Œäº‹åŠ¡</h4><p>å½“ä¸€ä¸ªå¤„äºäº‹åŠ¡çŠ¶æ€çš„å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€EXECå‘½ä»¤æ—¶ï¼Œè¿™ä¸ªEXECå‘½ä»¤å°†ç«‹å³è¢«æœåŠ¡å™¨æ‰§è¡Œã€‚æœåŠ¡å™¨ä¼šéå†è¿™ä¸ªå®¢æˆ·ç«¯çš„äº‹åŠ¡é˜Ÿåˆ—ï¼Œæ‰§è¡Œé˜Ÿåˆ—ä¸­ä¿å­˜çš„æ‰€æœ‰å‘½ä»¤ï¼Œæœ€åå°†æ‰§è¡Œå‘½ä»¤æ‰€å¾—çš„ç»“æœå…¨éƒ¨è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p>
<p>EXECå‘½ä»¤çš„å®ç°åŸç†å¯ä»¥ç”¨ä»¥ä¸‹ä¼ªä»£ç æ¥æè¿°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">def <span class="title function_">EXEC</span><span class="params">()</span>:</span><br><span class="line"></span><br><span class="line">	#åˆ›å»ºç©ºç™½çš„å›å¤é˜Ÿåˆ—</span><br><span class="line">	reply_queue = []</span><br><span class="line"></span><br><span class="line">	#éå†äº‹åŠ¡é˜Ÿåˆ—ä¸­çš„æ¯ä¸ªé¡¹</span><br><span class="line">	#è¯»å–å‘½ä»¤çš„å‚æ•°ï¼Œå‚æ•°çš„ä¸ªæ•°ï¼Œä»¥åŠè¦æ‰§è¡Œçš„å‘½ä»¤</span><br><span class="line">	<span class="keyword">for</span> argv, argc, cmd in client.mstate.commands:</span><br><span class="line"></span><br><span class="line">		#æ‰§è¡Œå‘½ä»¤ï¼Œå¹¶å–å¾—å‘½ä»¤çš„è¿”å›å€¼</span><br><span class="line">		reply = execute_command(cmd, argv, argc)</span><br><span class="line">		#å°†è¿”å›å€¼è¿½åŠ åˆ°å›å¤é˜Ÿåˆ—æœ«å°¾</span><br><span class="line">		reply_queue.append(reply)</span><br><span class="line"></span><br><span class="line">	#ç§»é™¤REDIS_MULTIæ ‡è¯†ï¼Œè®©å®¢æˆ·ç«¯å›åˆ°éäº‹åŠ¡çŠ¶æ€</span><br><span class="line">	client.flags &amp;= ~REDIS_MULTI</span><br><span class="line"></span><br><span class="line">	#æ¸…ç©ºå®¢æˆ·ç«¯çš„äº‹åŠ¡çŠ¶æ€ï¼ŒåŒ…æ‹¬:</span><br><span class="line">	#<span class="number">1</span>)æ¸…é›¶å…¥é˜Ÿå‘½ä»¤è®¡æ•°å™¨</span><br><span class="line">	#<span class="number">2</span>)é‡Šæ”¾äº‹åŠ¡é˜Ÿåˆ—</span><br><span class="line">	client.mstate.count = <span class="number">0</span></span><br><span class="line">	release_transaction_queue(client.mstate.commands)</span><br><span class="line">	#å°†äº‹åŠ¡çš„æ‰§è¡Œç»“æœè¿”å›ç»™å®¢æˆ·ç«¯</span><br><span class="line">	send_reply_to_client(client, reply_queue)</span><br></pre></td></tr></table></figure>

<h3 id="WATCHå‘½ä»¤çš„å®ç°"><a href="#WATCHå‘½ä»¤çš„å®ç°" class="headerlink" title="WATCHå‘½ä»¤çš„å®ç°"></a>WATCHå‘½ä»¤çš„å®ç°</h3><p>WATCHå‘½ä»¤æ˜¯ä¸€ä¸ªä¹è§‚é”ï¼ˆoptimistic lockingï¼‰ï¼Œå®ƒå¯ä»¥åœ¨EXECå‘½ä»¤æ‰§è¡Œä¹‹å‰ï¼Œç›‘è§†ä»»æ„æ•°é‡çš„æ•°æ®åº“é”®ï¼Œå¹¶åœ¨EXECå‘½ä»¤æ‰§è¡Œæ—¶ï¼Œæ£€æŸ¥è¢«ç›‘è§†çš„é”®æ˜¯å¦è‡³å°‘æœ‰ä¸€ä¸ªå·²ç»è¢«ä¿®æ”¹è¿‡äº†ï¼Œå¦‚æœæ˜¯çš„è¯ï¼ŒæœåŠ¡å™¨å°†æ‹’ç»æ‰§è¡Œäº‹åŠ¡ï¼Œå¹¶å‘å®¢æˆ·ç«¯è¿”å›ä»£è¡¨äº‹åŠ¡æ‰§è¡Œå¤±è´¥çš„ç©ºå›å¤ã€‚</p>
<h4 id="ä½¿ç”¨WATCHå‘½ä»¤ç›‘è§†æ•°æ®åº“é”®"><a href="#ä½¿ç”¨WATCHå‘½ä»¤ç›‘è§†æ•°æ®åº“é”®" class="headerlink" title="ä½¿ç”¨WATCHå‘½ä»¤ç›‘è§†æ•°æ®åº“é”®"></a>ä½¿ç”¨WATCHå‘½ä»¤ç›‘è§†æ•°æ®åº“é”®</h4><p>æ¯ä¸ªRedisæ•°æ®åº“éƒ½ä¿å­˜ç€ä¸€ä¸ªwatched_keyså­—å…¸ï¼Œè¿™ä¸ªå­—å…¸çš„é”®æ˜¯æŸä¸ªè¢«WATCHå‘½ä»¤ç›‘è§†çš„æ•°æ®åº“é”®ï¼Œè€Œå­—å…¸çš„å€¼åˆ™æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œé“¾è¡¨ä¸­è®°å½•äº†æ‰€æœ‰ç›‘è§†ç›¸åº”æ•°æ®åº“é”®çš„å®¢æˆ·ç«¯ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisDb</span> &#123;</span></span><br><span class="line">	</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ­£åœ¨è¢«WATCHå‘½ä»¤ç›‘è§†çš„é”®</span></span><br><span class="line">    dict *watched_keys;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125; redisDb;</span><br></pre></td></tr></table></figure>


<p>é€šè¿‡watched_keyså­—å…¸ï¼ŒæœåŠ¡å™¨å¯ä»¥æ¸…æ¥šåœ°çŸ¥é“å“ªäº›æ•°æ®åº“é”®æ­£åœ¨è¢«ç›‘è§†ï¼Œä»¥åŠå“ªäº›å®¢æˆ·ç«¯æ­£åœ¨ç›‘è§†è¿™äº›æ•°æ®åº“é”®ã€‚</p>
<h4 id="ç›‘è§†æœºåˆ¶çš„è§¦å‘"><a href="#ç›‘è§†æœºåˆ¶çš„è§¦å‘" class="headerlink" title="ç›‘è§†æœºåˆ¶çš„è§¦å‘"></a>ç›‘è§†æœºåˆ¶çš„è§¦å‘</h4><p>æ‰€æœ‰å¯¹æ•°æ®åº“è¿›è¡Œä¿®æ”¹çš„å‘½ä»¤ï¼Œæ¯”å¦‚SETã€LPUSHã€SADDã€ZREMã€DELã€FLUSHDBç­‰ç­‰ï¼Œåœ¨æ‰§è¡Œä¹‹åéƒ½ä¼šè°ƒç”¨multi.c&#x2F;touchWatchKeyå‡½æ•°å¯¹watched_keyså­—å…¸è¿›è¡Œæ£€æŸ¥ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰å®¢æˆ·ç«¯æ­£åœ¨ç›‘è§†åˆšåˆšè¢«å‘½ä»¤ä¿®æ”¹è¿‡çš„æ•°æ®åº“é”®ï¼Œå¦‚æœæœ‰çš„è¯ï¼Œé‚£ä¹ˆtouchWatchKeyå‡½æ•°ä¼šå°†ç›‘è§†è¢«ä¿®æ”¹é”®çš„å®¢æˆ·ç«¯çš„REDIS_DIRTY_CASæ ‡è¯†æ‰“å¼€ï¼Œè¡¨ç¤ºè¯¥å®¢æˆ·ç«¯çš„äº‹åŠ¡å®‰å…¨æ€§å·²ç»è¢«ç ´åã€‚</p>
<p>touchWatchKeyå‡½æ•°çš„å®šä¹‰å¯ä»¥ç”¨ä»¥ä¸‹ä¼ªä»£ç æ¥æè¿°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">def touchWatchKey(db, key):</span><br><span class="line">	#å¦‚æœé”®keyå­˜åœ¨äºæ•°æ®åº“çš„watched_keyså­—å…¸ä¸­</span><br><span class="line">	#é‚£ä¹ˆè¯´æ˜è‡³å°‘æœ‰ä¸€ä¸ªå®¢æˆ·ç«¯åœ¨ç›‘è§†è¿™ä¸ªkey</span><br><span class="line">	if key in db.watched_keys:</span><br><span class="line">		#éå†æ‰€æœ‰ç›‘è§†é”®keyçš„å®¢æˆ·ç«¯</span><br><span class="line">		for client in db.watched_keys[key]:</span><br><span class="line">			#æ‰“å¼€æ ‡è¯†</span><br><span class="line">			client.flags |= REDIS_DIRTY_CAS</span><br></pre></td></tr></table></figure>

<h4 id="åˆ¤æ–­äº‹åŠ¡æ˜¯å¦å®‰å…¨"><a href="#åˆ¤æ–­äº‹åŠ¡æ˜¯å¦å®‰å…¨" class="headerlink" title="åˆ¤æ–­äº‹åŠ¡æ˜¯å¦å®‰å…¨"></a>åˆ¤æ–­äº‹åŠ¡æ˜¯å¦å®‰å…¨</h4><p>å½“æœåŠ¡å™¨æ¥æ”¶åˆ°ä¸€ä¸ªå®¢æˆ·ç«¯å‘æ¥çš„EXECå‘½ä»¤æ—¶ï¼ŒæœåŠ¡å™¨ä¼šæ ¹æ®è¿™ä¸ªå®¢æˆ·ç«¯æ˜¯å¦æ‰“å¼€äº†REDIS_DIRTY_CASæ ‡è¯†æ¥å†³å®šæ˜¯å¦æ‰§è¡Œäº‹åŠ¡ï¼š</p>
<ul>
<li>å¦‚æœå®¢æˆ·ç«¯çš„REDIS_DIRTY_CASæ ‡è¯†å·²ç»è¢«æ‰“å¼€ï¼Œé‚£ä¹ˆè¯´æ˜å®¢æˆ·ç«¯æ‰€ç›‘è§†çš„é”®å½“ä¸­ï¼Œè‡³å°‘æœ‰ä¸€ä¸ªé”®å·²ç»è¢«ä¿®æ”¹è¿‡äº†ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯æäº¤çš„äº‹åŠ¡å·²ç»ä¸å†å®‰å…¨ï¼Œæ‰€ä»¥æœåŠ¡å™¨ä¼šæ‹’ç»æ‰§è¡Œå®¢æˆ·ç«¯æäº¤çš„äº‹åŠ¡ã€‚</li>
<li>å¦‚æœå®¢æˆ·ç«¯çš„REDIS_DIRTY_CASæ ‡è¯†æ²¡æœ‰è¢«æ‰“å¼€ï¼Œé‚£ä¹ˆè¯´æ˜å®¢æˆ·ç«¯ç›‘è§†çš„æ‰€æœ‰é”®éƒ½æ²¡æœ‰è¢«ä¿®æ”¹è¿‡ï¼ˆæˆ–è€…å®¢æˆ·ç«¯æ²¡æœ‰ç›‘è§†ä»»ä½•é”®ï¼‰ï¼Œäº‹åŠ¡ä»ç„¶æ˜¯å®‰å…¨çš„ï¼ŒæœåŠ¡å™¨å°†æ‰§è¡Œå®¢æˆ·ç«¯æäº¤çš„è¿™ä¸ªäº‹åŠ¡ã€‚</li>
</ul>
<h3 id="äº‹åŠ¡çš„ACIDæ€§è´¨"><a href="#äº‹åŠ¡çš„ACIDæ€§è´¨" class="headerlink" title="äº‹åŠ¡çš„ACIDæ€§è´¨"></a>äº‹åŠ¡çš„ACIDæ€§è´¨</h3><p>åœ¨ä¼ ç»Ÿçš„å…³ç³»å¼æ•°æ®åº“ä¸­ï¼Œå¸¸å¸¸ç”¨ACIDæ€§è´¨æ¥æ£€éªŒäº‹åŠ¡åŠŸèƒ½çš„å¯é æ€§å’Œå®‰å…¨æ€§ã€‚åœ¨Redisä¸­ï¼Œäº‹åŠ¡æ€»æ˜¯å…·æœ‰åŸå­æ€§ï¼ˆAtomicityï¼‰ã€ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰å’Œéš”ç¦»æ€§ï¼ˆIsolationï¼‰ï¼Œå¹¶ä¸”å½“Redisè¿è¡Œåœ¨æŸç§ç‰¹å®šçš„æŒä¹…åŒ–æ¨¡å¼ä¸‹æ—¶ï¼Œäº‹åŠ¡ä¹Ÿå…·æœ‰è€ä¹…æ€§ï¼ˆDurabilityï¼‰ã€‚</p>
<h4 id="åŸå­æ€§"><a href="#åŸå­æ€§" class="headerlink" title="åŸå­æ€§"></a>åŸå­æ€§</h4><p>äº‹åŠ¡å…·æœ‰åŸå­æ€§æŒ‡çš„æ˜¯ï¼Œæ•°æ®åº“å°†äº‹åŠ¡ä¸­çš„å¤šä¸ªæ“ä½œå½“ä½œä¸€ä¸ªæ•´ä½“æ¥æ‰§è¡Œï¼ŒæœåŠ¡å™¨è¦ä¹ˆå°±æ‰§è¡Œäº‹åŠ¡ä¸­çš„æ‰€æœ‰æ“ä½œï¼Œè¦ä¹ˆå°±ä¸€ä¸ªæ“ä½œä¹Ÿä¸æ‰§è¡Œã€‚</p>
<p>å¯¹äºRedisçš„äº‹åŠ¡åŠŸèƒ½æ¥è¯´ï¼Œäº‹åŠ¡é˜Ÿåˆ—ä¸­çš„å‘½ä»¤è¦ä¹ˆå°±å…¨éƒ¨éƒ½æ‰§è¡Œï¼Œè¦ä¹ˆå°±ä¸€ä¸ªéƒ½ä¸æ‰§è¡Œï¼Œå› æ­¤ï¼ŒRedisçš„äº‹åŠ¡æ˜¯å…·æœ‰åŸå­æ€§çš„ã€‚</p>
<p>Redisçš„äº‹åŠ¡å’Œä¼ ç»Ÿçš„å…³ç³»å‹æ•°æ®åº“äº‹åŠ¡çš„æœ€å¤§åŒºåˆ«åœ¨äºï¼ŒRedisä¸æ”¯æŒäº‹åŠ¡å›æ»šæœºåˆ¶ï¼ˆrollbackï¼‰ï¼Œå³ä½¿äº‹åŠ¡é˜Ÿåˆ—ä¸­çš„æŸä¸ªå‘½ä»¤åœ¨æ‰§è¡ŒæœŸé—´å‡ºç°äº†é”™è¯¯ï¼Œæ•´ä¸ªäº‹åŠ¡ä¹Ÿä¼šç»§ç»­æ‰§è¡Œä¸‹å»ï¼Œç›´åˆ°å°†äº‹åŠ¡é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å‘½ä»¤éƒ½æ‰§è¡Œå®Œæ¯•ä¸ºæ­¢ã€‚</p>
<h4 id="ä¸€è‡´æ€§"><a href="#ä¸€è‡´æ€§" class="headerlink" title="ä¸€è‡´æ€§"></a>ä¸€è‡´æ€§</h4><p>äº‹åŠ¡å…·æœ‰ä¸€è‡´æ€§æŒ‡çš„æ˜¯ï¼Œå¦‚æœæ•°æ®åº“åœ¨æ‰§è¡Œäº‹åŠ¡ä¹‹å‰æ˜¯ä¸€è‡´çš„ï¼Œé‚£ä¹ˆåœ¨äº‹åŠ¡æ‰§è¡Œä¹‹åï¼Œæ— è®ºäº‹åŠ¡æ˜¯å¦æ‰§è¡ŒæˆåŠŸï¼Œæ•°æ®åº“ä¹Ÿåº”è¯¥ä»ç„¶æ˜¯ä¸€è‡´çš„ã€‚</p>
<p>â€œä¸€è‡´â€æŒ‡çš„æ˜¯æ•°æ®ç¬¦åˆæ•°æ®åº“æœ¬èº«çš„å®šä¹‰å’Œè¦æ±‚ï¼Œæ²¡æœ‰åŒ…å«éæ³•æˆ–è€…æ— æ•ˆçš„é”™è¯¯æ•°æ®ã€‚</p>
<p>Redisé€šè¿‡è°¨æ…çš„é”™è¯¯æ£€æµ‹å’Œç®€å•çš„è®¾è®¡æ¥ä¿è¯äº‹åŠ¡çš„ä¸€è‡´æ€§ï¼Œä»¥ä¸‹ä¸‰ä¸ªå°èŠ‚å°†åˆ†åˆ«ä»‹ç»ä¸‰ä¸ªRedisäº‹åŠ¡å¯èƒ½å‡ºé”™çš„åœ°æ–¹ï¼Œå¹¶è¯´æ˜Redisæ˜¯å¦‚ä½•å¦¥å–„åœ°å¤„ç†è¿™äº›é”™è¯¯ï¼Œä»è€Œç¡®ä¿äº‹åŠ¡çš„ä¸€è‡´æ€§çš„ã€‚</p>
<h5 id="å…¥é˜Ÿé”™è¯¯"><a href="#å…¥é˜Ÿé”™è¯¯" class="headerlink" title="å…¥é˜Ÿé”™è¯¯"></a>å…¥é˜Ÿé”™è¯¯</h5><p>å¦‚æœä¸€ä¸ªäº‹åŠ¡åœ¨å…¥é˜Ÿå‘½ä»¤çš„è¿‡ç¨‹ä¸­ï¼Œå‡ºç°äº†å‘½ä»¤ä¸å­˜åœ¨ï¼Œæˆ–è€…å‘½ä»¤çš„æ ¼å¼ä¸æ­£ç¡®ç­‰æƒ…å†µï¼Œé‚£ä¹ˆRediså°†æ‹’ç»æ‰§è¡Œè¿™ä¸ªäº‹åŠ¡ã€‚</p>
<p>å› ä¸ºæœåŠ¡å™¨ä¼šæ‹’ç»æ‰§è¡Œå…¥é˜Ÿè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯çš„äº‹åŠ¡ï¼Œæ‰€ä»¥Redisäº‹åŠ¡çš„ä¸€è‡´æ€§ä¸ä¼šè¢«å¸¦æœ‰å…¥é˜Ÿé”™è¯¯çš„äº‹åŠ¡å½±å“ã€‚</p>
<h5 id="æ‰§è¡Œé”™è¯¯"><a href="#æ‰§è¡Œé”™è¯¯" class="headerlink" title="æ‰§è¡Œé”™è¯¯"></a>æ‰§è¡Œé”™è¯¯</h5><p>é™¤äº†å…¥é˜Ÿæ—¶å¯èƒ½å‘ç”Ÿé”™è¯¯ä»¥å¤–ï¼Œäº‹åŠ¡è¿˜å¯èƒ½åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ã€‚å…³äºè¿™ç§é”™è¯¯æœ‰ä¸¤ä¸ªéœ€è¦è¯´æ˜çš„åœ°æ–¹ï¼š</p>
<ul>
<li>æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿçš„é”™è¯¯éƒ½æ˜¯ä¸€äº›ä¸èƒ½åœ¨å…¥é˜Ÿæ—¶è¢«æœåŠ¡å™¨å‘ç°çš„é”™è¯¯ï¼Œè¿™äº›é”™è¯¯åªä¼šåœ¨å‘½ä»¤å®é™…æ‰§è¡Œæ—¶è¢«è§¦å‘ã€‚</li>
<li>å³ä½¿åœ¨äº‹åŠ¡çš„æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿäº†é”™è¯¯ï¼ŒæœåŠ¡å™¨ä¹Ÿä¸ä¼šä¸­æ–­äº‹åŠ¡çš„æ‰§è¡Œï¼Œå®ƒä¼šç»§ç»­æ‰§è¡Œäº‹åŠ¡ä¸­ä½™ä¸‹çš„å…¶ä»–å‘½ä»¤ï¼Œå¹¶ä¸”å·²æ‰§è¡Œçš„å‘½ä»¤ï¼ˆåŒ…æ‹¬æ‰§è¡Œå‘½ä»¤æ‰€äº§ç”Ÿçš„ç»“æœï¼‰ä¸ä¼šè¢«å‡ºé”™çš„å‘½ä»¤å½±å“ã€‚</li>
</ul>
<p>å› ä¸ºåœ¨äº‹åŠ¡æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œå‡ºé”™çš„å‘½ä»¤ä¼šè¢«æœåŠ¡å™¨è¯†åˆ«å‡ºæ¥ï¼Œå¹¶è¿›è¡Œç›¸åº”çš„é”™è¯¯å¤„ç†ï¼Œæ‰€ä»¥è¿™äº›å‡ºé”™å‘½ä»¤ä¸ä¼šå¯¹æ•°æ®åº“åšä»»ä½•ä¿®æ”¹ï¼Œä¹Ÿä¸ä¼šå¯¹äº‹åŠ¡çš„ä¸€è‡´æ€§äº§ç”Ÿä»»ä½•å½±å“ã€‚</p>
<h5 id="æœåŠ¡å™¨åœæœº"><a href="#æœåŠ¡å™¨åœæœº" class="headerlink" title="æœåŠ¡å™¨åœæœº"></a>æœåŠ¡å™¨åœæœº</h5><p>å¦‚æœRedisæœåŠ¡å™¨åœ¨æ‰§è¡Œäº‹åŠ¡çš„è¿‡ç¨‹ä¸­åœæœºï¼Œé‚£ä¹ˆæ ¹æ®æœåŠ¡å™¨æ‰€ä½¿ç”¨çš„æŒä¹…åŒ–æ¨¡å¼ï¼Œå¯èƒ½æœ‰ä»¥ä¸‹æƒ…å†µå‡ºç°ï¼š</p>
<ul>
<li>å¦‚æœæœåŠ¡å™¨è¿è¡Œåœ¨æ— æŒä¹…åŒ–çš„å†…å­˜æ¨¡å¼ä¸‹ï¼Œé‚£ä¹ˆé‡å¯ä¹‹åçš„æ•°æ®åº“å°†æ˜¯ç©ºç™½çš„ï¼Œå› æ­¤æ•°æ®æ€»æ˜¯ä¸€è‡´çš„ã€‚</li>
<li>å¦‚æœæœåŠ¡å™¨è¿è¡Œåœ¨RDBæ¨¡å¼ä¸‹ï¼Œé‚£ä¹ˆåœ¨äº‹åŠ¡ä¸­é€”åœæœºä¸ä¼šå¯¼è‡´ä¸ä¸€è‡´æ€§ï¼Œå› ä¸ºæœåŠ¡å™¨å¯ä»¥æ ¹æ®ç°æœ‰çš„RDBæ–‡ä»¶æ¥æ¢å¤æ•°æ®ï¼Œä»è€Œå°†æ•°æ®åº“è¿˜åŸåˆ°ä¸€ä¸ªä¸€è‡´çš„çŠ¶æ€ã€‚å¦‚æœæ‰¾ä¸åˆ°å¯ä¾›ä½¿ç”¨çš„RDBæ–‡ä»¶ï¼Œé‚£ä¹ˆé‡å¯ä¹‹åçš„æ•°æ®åº“å°†æ˜¯ç©ºç™½çš„ï¼Œè€Œç©ºç™½æ•°æ®åº“æ€»æ˜¯ä¸€è‡´çš„ã€‚</li>
<li>å¦‚æœæœåŠ¡å™¨è¿è¡Œåœ¨AOFæ¨¡å¼ä¸‹ï¼Œé‚£ä¹ˆåœ¨äº‹åŠ¡ä¸­é€”åœæœºä¸ä¼šå¯¼è‡´ä¸ä¸€è‡´æ€§ï¼Œå› ä¸ºæœåŠ¡å™¨å¯ä»¥æ ¹æ®ç°æœ‰çš„AOFæ–‡ä»¶æ¥æ¢å¤æ•°æ®ï¼Œä»è€Œå°†æ•°æ®åº“è¿˜åŸåˆ°ä¸€ä¸ªä¸€è‡´çš„çŠ¶æ€ã€‚å¦‚æœæ‰¾ä¸åˆ°å¯ä¾›ä½¿ç”¨çš„AOFæ–‡ä»¶ï¼Œé‚£ä¹ˆé‡å¯ä¹‹åçš„æ•°æ®åº“å°†æ˜¯ç©ºç™½çš„ï¼Œè€Œç©ºç™½æ•°æ®åº“æ€»æ˜¯ä¸€è‡´çš„ã€‚</li>
</ul>
<p>ç»¼ä¸Šæ‰€è¿°ï¼Œæ— è®ºRedisæœåŠ¡å™¨è¿è¡Œåœ¨å“ªç§æŒä¹…åŒ–æ¨¡å¼ä¸‹ï¼Œäº‹åŠ¡æ‰§è¡Œä¸­é€”å‘ç”Ÿçš„åœæœºéƒ½ä¸ä¼šå½±å“æ•°æ®åº“çš„ä¸€è‡´æ€§ã€‚</p>
<h4 id="éš”ç¦»æ€§"><a href="#éš”ç¦»æ€§" class="headerlink" title="éš”ç¦»æ€§"></a>éš”ç¦»æ€§</h4><p>äº‹åŠ¡çš„éš”ç¦»æ€§æŒ‡çš„æ˜¯ï¼Œå³ä½¿æ•°æ®åº“ä¸­æœ‰å¤šä¸ªäº‹åŠ¡å¹¶å‘åœ°æ‰§è¡Œï¼Œå„ä¸ªäº‹åŠ¡ä¹‹é—´ä¹Ÿä¸ä¼šäº’ç›¸å½±å“ï¼Œå¹¶ä¸”åœ¨å¹¶å‘çŠ¶æ€ä¸‹æ‰§è¡Œçš„äº‹åŠ¡å’Œä¸²è¡Œæ‰§è¡Œçš„äº‹åŠ¡äº§ç”Ÿçš„ç»“æœå®Œå…¨ç›¸åŒã€‚</p>
<p>å› ä¸ºRedisä½¿ç”¨å•çº¿ç¨‹çš„æ–¹å¼æ¥æ‰§è¡Œäº‹åŠ¡ï¼ˆä»¥åŠäº‹åŠ¡é˜Ÿåˆ—ä¸­çš„å‘½ä»¤ï¼‰ï¼Œå¹¶ä¸”æœåŠ¡å™¨ä¿è¯ï¼Œåœ¨æ‰§è¡Œäº‹åŠ¡æœŸé—´ä¸ä¼šå¯¹äº‹åŠ¡è¿›è¡Œä¸­æ–­ï¼Œå› æ­¤ï¼ŒRedisçš„äº‹åŠ¡æ€»æ˜¯ä»¥ä¸²è¡Œçš„æ–¹å¼è¿è¡Œçš„ï¼Œå¹¶ä¸”äº‹åŠ¡ä¹Ÿæ€»æ˜¯å…·æœ‰éš”ç¦»æ€§çš„ã€‚	</p>
<h4 id="è€ä¹…æ€§"><a href="#è€ä¹…æ€§" class="headerlink" title="è€ä¹…æ€§"></a>è€ä¹…æ€§</h4><p>äº‹åŠ¡çš„è€ä¹…æ€§æŒ‡çš„æ˜¯ï¼Œå½“ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œå®Œæ¯•æ—¶ï¼Œæ‰§è¡Œè¿™ä¸ªäº‹åŠ¡æ‰€å¾—çš„ç»“æœå·²ç»è¢«ä¿å­˜åˆ°æ°¸ä¹…æ€§å­˜å‚¨ä»‹è´¨ï¼ˆæ¯”å¦‚ç¡¬ç›˜ï¼‰é‡Œé¢äº†ï¼Œå³ä½¿æœåŠ¡å™¨åœ¨äº‹åŠ¡æ‰§è¡Œå®Œæ¯•ä¹‹ååœæœºï¼Œæ‰§è¡Œäº‹åŠ¡æ‰€å¾—çš„ç»“æœä¹Ÿä¸ä¼šä¸¢å¤±ã€‚</p>
<p>å› ä¸ºRedisçš„äº‹åŠ¡ä¸è¿‡æ˜¯ç®€å•åœ°ç”¨é˜Ÿåˆ—åŒ…è£¹èµ·äº†ä¸€ç»„Rediså‘½ä»¤ï¼ŒRediså¹¶æ²¡æœ‰ä¸ºäº‹åŠ¡æä¾›ä»»ä½•é¢å¤–çš„æŒä¹…åŒ–åŠŸèƒ½ï¼Œæ‰€ä»¥Redisäº‹åŠ¡çš„è€ä¹…æ€§ç”±Redisæ‰€ä½¿ç”¨çš„æŒä¹…åŒ–æ¨¡å¼å†³å®šï¼š</p>
<ul>
<li>å½“æœåŠ¡å™¨åœ¨æ— æŒä¹…åŒ–çš„å†…å­˜æ¨¡å¼ä¸‹è¿ä½œæ—¶ï¼Œäº‹åŠ¡ä¸å…·æœ‰è€ä¹…æ€§ï¼šä¸€æ—¦æœåŠ¡å™¨åœæœºï¼ŒåŒ…æ‹¬äº‹åŠ¡æ•°æ®åœ¨å†…çš„æ‰€æœ‰æœåŠ¡å™¨æ•°æ®éƒ½å°†ä¸¢å¤±ã€‚</li>
<li>å½“æœåŠ¡å™¨åœ¨RDBæŒä¹…åŒ–æ¨¡å¼ä¸‹è¿ä½œæ—¶ï¼ŒæœåŠ¡å™¨åªä¼šåœ¨ç‰¹å®šçš„ä¿å­˜æ¡ä»¶è¢«æ»¡è¶³æ—¶ï¼Œæ‰ä¼šæ‰§è¡ŒBGSAVEå‘½ä»¤ï¼Œå¯¹æ•°æ®åº“è¿›è¡Œä¿å­˜æ“ä½œï¼Œå¹¶ä¸”å¼‚æ­¥æ‰§è¡Œçš„BGSAVEä¸èƒ½ä¿è¯äº‹åŠ¡æ•°æ®è¢«ç¬¬ä¸€æ—¶é—´ä¿å­˜åˆ°ç¡¬ç›˜é‡Œé¢ï¼Œå› æ­¤RDBæŒä¹…åŒ–æ¨¡å¼ä¸‹çš„äº‹åŠ¡ä¹Ÿä¸å…·æœ‰è€ä¹…æ€§ã€‚</li>
<li>å½“æœåŠ¡å™¨è¿è¡Œåœ¨AOFæŒä¹…åŒ–æ¨¡å¼ä¸‹ï¼Œå¹¶ä¸”appendfsyncé€‰é¡¹çš„å€¼ä¸ºalwaysæ—¶ï¼Œç¨‹åºæ€»ä¼šåœ¨æ‰§è¡Œå‘½ä»¤ä¹‹åè°ƒç”¨åŒæ­¥ï¼ˆsyncï¼‰å‡½æ•°ï¼Œå°†å‘½ä»¤æ•°æ®çœŸæ­£åœ°ä¿å­˜åˆ°ç¡¬ç›˜é‡Œé¢ï¼Œå› æ­¤è¿™ç§é…ç½®ä¸‹çš„äº‹åŠ¡æ˜¯å…·æœ‰è€ä¹…æ€§çš„ã€‚</li>
<li>å½“æœåŠ¡å™¨è¿è¡Œåœ¨AOFæŒä¹…åŒ–æ¨¡å¼ä¸‹ï¼Œå¹¶ä¸”appendfsyncé€‰é¡¹çš„å€¼ä¸ºeverysecæ—¶ï¼Œç¨‹åºä¼šæ¯ç§’åŒæ­¥ä¸€æ¬¡å‘½ä»¤æ•°æ®åˆ°ç¡¬ç›˜ã€‚å› ä¸ºåœæœºå¯èƒ½ä¼šæ°å¥½å‘ç”Ÿåœ¨ç­‰å¾…åŒæ­¥çš„é‚£ä¸€ç§’é’Ÿä¹‹å†…ï¼Œè¿™å¯èƒ½ä¼šé€ æˆäº‹åŠ¡æ•°æ®ä¸¢å¤±ï¼Œæ‰€ä»¥è¿™ç§é…ç½®ä¸‹çš„äº‹åŠ¡ä¸å…·æœ‰è€ä¹…æ€§ã€‚</li>
<li>å½“æœåŠ¡å™¨è¿è¡Œåœ¨AOFæŒä¹…åŒ–æ¨¡å¼ä¸‹ï¼Œå¹¶ä¸”appendfsyncé€‰é¡¹çš„å€¼ä¸ºnoæ—¶ï¼Œç¨‹åºä¼šäº¤ç”±æ“ä½œç³»ç»Ÿæ¥å†³å®šä½•æ—¶å°†å‘½ä»¤æ•°æ®åŒæ­¥åˆ°ç¡¬ç›˜ã€‚å› ä¸ºäº‹åŠ¡æ•°æ®å¯èƒ½åœ¨ç­‰å¾…åŒæ­¥çš„è¿‡ç¨‹ä¸­ä¸¢å¤±ï¼Œæ‰€ä»¥è¿™ç§é…ç½®ä¸‹çš„äº‹åŠ¡ä¸å…·æœ‰è€ä¹…æ€§ã€‚</li>
</ul>
<h2 id="Luaè„šæœ¬"><a href="#Luaè„šæœ¬" class="headerlink" title="Luaè„šæœ¬"></a>Luaè„šæœ¬</h2><p>Redisä»2.6ç‰ˆæœ¬å¼€å§‹å¼•å…¥å¯¹Luaè„šæœ¬çš„æ”¯æŒï¼Œé€šè¿‡åœ¨æœåŠ¡å™¨ä¸­åµŒå…¥Luaç¯å¢ƒï¼ŒRediså®¢æˆ·ç«¯å¯ä»¥ä½¿ç”¨Luaè„šæœ¬ï¼Œç›´æ¥åœ¨æœåŠ¡å™¨ç«¯åŸå­åœ°æ‰§è¡Œå¤šä¸ªRediså‘½ä»¤ã€‚</p>
<p>å…¶ä¸­ï¼Œä½¿ç”¨EVALå‘½ä»¤å¯ä»¥ç›´æ¥å¯¹è¾“å…¥çš„è„šæœ¬è¿›è¡Œæ±‚å€¼ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis&gt; EVAL &quot;return &#x27;hello world&#x27;&quot; 0</span><br><span class="line">&quot;hello world&quot;</span><br></pre></td></tr></table></figure>


<p>è€Œä½¿ç”¨EVALSHAå‘½ä»¤åˆ™å¯ä»¥æ ¹æ®è„šæœ¬çš„SHA1æ ¡éªŒå’Œæ¥å¯¹è„šæœ¬è¿›è¡Œæ±‚å€¼ï¼Œä½†è¿™ä¸ªå‘½ä»¤è¦æ±‚æ ¡éªŒå’Œå¯¹åº”çš„è„šæœ¬å¿…é¡»è‡³å°‘è¢«EVALå‘½ä»¤æ‰§è¡Œè¿‡ä¸€æ¬¡ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">redis&gt; EVAL &quot;return 1+1&quot; 0</span><br><span class="line">(integer)2</span><br><span class="line">redis&gt; EVALSHA &quot;a27e7e8a43702b7046d4f6a7ccf5b60cef6b9bd9&quot; 0 //ä¸Šä¸€ä¸ªè„šæœ¬çš„æ ¡éªŒå’Œ</span><br><span class="line">integer) 2</span><br></pre></td></tr></table></figure>


<p>æˆ–è€…è¿™ä¸ªæ ¡éªŒå’Œå¯¹åº”çš„è„šæœ¬æ›¾ç»è¢«SCRIPT LOADå‘½ä»¤è½½å…¥è¿‡ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">redis&gt; SCRIPT LOAD &quot;return 2*2&quot;</span><br><span class="line">&quot;4475bfb5919b5ad16424cb5074d4724ae833e72&quot;</span><br><span class="line">redis&gt; EVALSHA &quot;4475bfb5919b5ad16424cb50f7464724ae833e72&quot; 0</span><br><span class="line">(integer) 4</span><br></pre></td></tr></table></figure>


<p>æœ¬ç« å°†å¯¹RedisæœåŠ¡å™¨ä¸­ä¸Luaè„šæœ¬æœ‰å…³çš„å„ä¸ªéƒ¨åˆ†è¿›è¡Œä»‹ç»ã€‚</p>
<p>é¦–å…ˆï¼Œæœ¬ç« å°†ä»‹ç»RedisæœåŠ¡å™¨åˆå§‹åŒ–Luaç¯å¢ƒçš„æ•´ä¸ªè¿‡ç¨‹ï¼Œè¯´æ˜Rediså¯¹Luaç¯å¢ƒè¿›è¡Œäº†å“ªäº›ä¿®æ”¹ï¼Œè€Œè¿™äº›ä¿®æ”¹åˆå¯¹ç”¨æˆ·æ‰§è¡ŒLuaè„šæœ¬äº§ç”Ÿäº†ä»€ä¹ˆå½±å“å’Œé™åˆ¶ã€‚</p>
<p>æ¥ç€ï¼Œæœ¬ç« å°†ä»‹ç»ä¸Luaç¯å¢ƒè¿›è¡Œåä½œçš„ä¸¤ä¸ªç»„ä»¶ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯è´Ÿè´£æ‰§è¡ŒLuaè„šæœ¬ä¸­åŒ…å«Rediså‘½ä»¤çš„ä¼ªå®¢æˆ·ç«¯ï¼Œä»¥åŠè´Ÿè´£ä¿å­˜ä¼ å…¥æœåŠ¡å™¨çš„Luaè„šæœ¬çš„è„šæœ¬å­—å…¸ã€‚äº†è§£ä¼ªå®¢æˆ·ç«¯å¯ä»¥çŸ¥é“è„šæœ¬ä¸­çš„Rediså‘½ä»¤åœ¨æ‰§è¡Œæ—¶ï¼ŒæœåŠ¡å™¨ä¸Luaç¯å¢ƒçš„äº¤äº’è¿‡ç¨‹ï¼Œè€Œäº†è§£è„šæœ¬å­—å…¸åˆ™æœ‰åŠ©äºç†è§£SCRIPT EXISTSå‘½ä»¤å’Œè„šæœ¬å¤åˆ¶åŠŸèƒ½çš„å®ç°åŸç†ã€‚</p>
<p>åœ¨è¿™ä¹‹åï¼Œæœ¬ç« å°†ä»‹ç»EVALå‘½ä»¤å’ŒEVALSHAå‘½ä»¤çš„å®ç°åŸç†ï¼Œè¯´æ˜Luaè„šæœ¬åœ¨RedisæœåŠ¡å™¨ä¸­æ˜¯å¦‚ä½•è¢«æ‰§è¡Œçš„ï¼Œå¹¶å¯¹ç®¡ç†è„šæœ¬çš„å››ä¸ªå‘½ä»¤â€”â€”SCRIPT FLUSHå‘½ä»¤ã€SCRIPT EXISTSå‘½ä»¤ã€SCRIPT LOADå‘½ä»¤ã€SCRIPT KILL å‘½ä»¤çš„å®ç°åŸç†è¿›è¡Œä»‹ç»ã€‚</p>
<p>æœ€åï¼Œæœ¬ç« å°†ä»¥ä»‹ç»Redisåœ¨ä¸»ä»æœåŠ¡å™¨ä¹‹é—´å¤åˆ¶Luaè„šæœ¬çš„æ–¹æ³•ä½œä¸ºæœ¬ç« çš„ç»“æŸã€‚</p>
<h3 id="åˆ›å»ºå¹¶ä¿®æ”¹Luaç¯å¢ƒ"><a href="#åˆ›å»ºå¹¶ä¿®æ”¹Luaç¯å¢ƒ" class="headerlink" title="åˆ›å»ºå¹¶ä¿®æ”¹Luaç¯å¢ƒ"></a>åˆ›å»ºå¹¶ä¿®æ”¹Luaç¯å¢ƒ</h3><p>ä¸ºäº†åœ¨RedisæœåŠ¡å™¨ä¸­æ‰§è¡ŒLuaè„šæœ¬ï¼ŒRedisåœ¨æœåŠ¡å™¨å†…åµŒäº†ä¸€ä¸ªLuaç¯å¢ƒï¼ˆenviron-mentï¼‰ï¼Œå¹¶å¯¹è¿™ä¸ªLuaç¯å¢ƒè¿›è¡Œäº†ä¸€ç³»åˆ—ä¿®æ”¹ï¼Œä»è€Œç¡®ä¿è¿™ä¸ªLuaç¯å¢ƒå¯ä»¥æ»¡è¶³RedisæœåŠ¡å™¨çš„éœ€è¦ã€‚<br>RedisæœåŠ¡å™¨åˆ›å»ºå¹¶ä¿®æ”¹Luaç¯å¢ƒçš„æ•´ä¸ªè¿‡ç¨‹ç”±ä»¥ä¸‹æ­¥éª¤ç»„æˆï¼š</p>
<ol>
<li>åˆ›å»ºä¸€ä¸ªåŸºç¡€çš„Luaç¯å¢ƒï¼Œä¹‹åçš„æ‰€æœ‰ä¿®æ”¹éƒ½æ˜¯é’ˆå¯¹è¿™ä¸ªç¯å¢ƒè¿›è¡Œçš„ã€‚</li>
<li>è½½äººå¤šä¸ªå‡½æ•°åº“åˆ°Luaç¯å¢ƒé‡Œé¢ï¼Œè®©Luaè„šæœ¬å¯ä»¥ä½¿ç”¨è¿™äº›å‡½æ•°åº“æ¥è¿›è¡Œæ•°æ®æ“ä½œã€‚</li>
<li>åˆ›å»ºå…¨å±€è¡¨æ ¼redisï¼Œè¿™ä¸ªè¡¨æ ¼åŒ…å«äº†å¯¹Redisè¿›è¡Œæ“ä½œçš„å‡½æ•°ï¼Œæ¯”å¦‚ç”¨äºåœ¨Luaè„šæœ¬ä¸­æ‰§è¡ŒRediså‘½ä»¤çš„redis.callå‡½æ•°ã€‚</li>
<li>ä½¿ç”¨Redisè‡ªåˆ¶çš„éšæœºå‡½æ•°æ¥æ›¿æ¢LuaåŸæœ‰çš„å¸¦æœ‰å‰¯ä½œç”¨çš„éšæœºå‡½æ•°ï¼Œä»è€Œé¿å…åœ¨è„šæœ¬ä¸­å¼•å…¥å‰¯ä½œç”¨ã€‚</li>
<li>åˆ›å»ºæ’åºè¾…åŠ©å‡½æ•°ï¼ŒLuaç¯å¢ƒä½¿ç”¨è¿™ä¸ªè¾…ä½å‡½æ•°æ¥å¯¹ä¸€éƒ¨åˆ†Rediså‘½ä»¤çš„ç»“æœè¿›è¡Œæ’åºï¼Œä»è€Œæ¶ˆé™¤è¿™äº›å‘½ä»¤çš„ä¸ç¡®å®šæ€§ã€‚</li>
<li>åˆ›å»ºredis.pcallå‡½æ•°çš„é”™è¯¯æŠ¥å‘Šè¾…åŠ©å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å¯ä»¥æä¾›æ›´è¯¦ç»†çš„å‡ºé”™ä¿¡æ¯ã€‚</li>
<li>å¯¹Luaç¯å¢ƒä¸­çš„å…¨å±€ç¯å¢ƒè¿›è¡Œä¿æŠ¤ï¼Œé˜²æ­¢ç”¨æˆ·åœ¨æ‰§è¡ŒLuaè„šæœ¬çš„è¿‡ç¨‹ä¸­ï¼Œå°†é¢å¤–çš„å…¨å±€å˜é‡æ·»åŠ åˆ°Luaç¯å¢ƒä¸­ã€‚</li>
<li>å°†å®Œæˆä¿®æ”¹çš„Luaç¯å¢ƒä¿å­˜åˆ°æœåŠ¡å™¨çŠ¶æ€çš„luaå±æ€§ä¸­ï¼Œç­‰å¾…æ‰§è¡ŒæœåŠ¡å™¨ä¼ æ¥çš„Luaè„šæœ¬ã€‚</li>
</ol>
<h4 id="åˆ›å»ºLuaç¯å¢ƒ"><a href="#åˆ›å»ºLuaç¯å¢ƒ" class="headerlink" title="åˆ›å»ºLuaç¯å¢ƒ"></a>åˆ›å»ºLuaç¯å¢ƒ</h4><p>åœ¨æœ€å¼€å§‹çš„è¿™ä¸€æ­¥ï¼ŒæœåŠ¡å™¨é¦–å…ˆè°ƒç”¨Luaçš„CAPIå‡½æ•°lua_openï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„Luaç¯å¢ƒã€‚</p>
<p>å› ä¸ºlua_openå‡½æ•°åˆ›å»ºçš„åªæ˜¯ä¸€ä¸ªåŸºæœ¬çš„Luaç¯å¢ƒï¼Œä¸ºäº†è®©è¿™ä¸ªLuaç¯å¢ƒå¯ä»¥æ»¡è¶³Redisçš„æ“ä½œè¦æ±‚ï¼Œæ¥ä¸‹æ¥æœåŠ¡å™¨å°†å¯¹è¿™ä¸ªLuaç¯å¢ƒè¿›è¡Œä¸€ç³»åˆ—ä¿®æ”¹ã€‚</p>
<h4 id="è½½å…¥å‡½æ•°åº“"><a href="#è½½å…¥å‡½æ•°åº“" class="headerlink" title="è½½å…¥å‡½æ•°åº“"></a>è½½å…¥å‡½æ•°åº“</h4><p>Redisä¿®æ”¹Luaç¯å¢ƒçš„ç¬¬ä¸€æ­¥ï¼Œå°±æ˜¯å°†ä»¥ä¸‹å‡½æ•°åº“è½½å…¥åˆ°Luaç¯å¢ƒé‡Œé¢ï¼š</p>
<ul>
<li>åŸºç¡€åº“ï¼ˆbase libraryï¼‰ï¼šè¿™ä¸ªåº“åŒ…å«Luaçš„æ ¸å¿ƒï¼ˆcoreï¼‰å‡½æ•°ï¼Œerrorã€pairsã€tostringã€pcalç­‰ã€‚å¦å¤–ï¼Œä¸ºäº†é˜²æ­¢ç”¨æˆ·ä»å¤–éƒ¨æ–‡ä»¶ä¸­å¼•å…¥ä¸å®‰å…¨çš„ä»£ç ï¼Œåº“ä¸­çš„loadfileå‡½æ•°ä¼šè¢«åˆ é™¤ã€‚</li>
<li>è¡¨æ ¼åº“ï¼ˆtable libraryï¼‰ï¼šè¿™ä¸ªåº“åŒ…å«ç”¨äºå¤„ç†è¡¨æ ¼çš„é€šç”¨å‡½æ•°ï¼Œæ¯”å¦‚table.concatã€table.insertã€table.removeã€table.sortç­‰ã€‚</li>
<li>å­—ç¬¦ä¸²åº“ï¼ˆstring libraryï¼‰ï¼šè¿™ä¸ªåº“åŒ…å«ç”¨äºå¤„ç†å­—ç¬¦ä¸²çš„é€šç”¨å‡½æ•°ï¼Œæ¯”å¦‚ç”¨äºå¯¹å­—ç¬¦ä¸²è¿›è¡ŒæŸ¥æ‰¾çš„string.findå‡½æ•°ï¼Œå¯¹å­—ç¬¦ä¸²è¿›è¡Œæ ¼å¼åŒ–çš„string.formatå‡½æ•°ï¼ŒæŸ¥çœ‹å­—ç¬¦ä¸²é•¿åº¦çš„string.lenå‡½æ•°ï¼Œå¯¹å­—ç¬¦ä¸²è¿›è¡Œç¿»è½¬çš„string.reverseå‡½æ•°ç­‰ã€‚</li>
<li>æ•°å­¦åº“ï¼ˆmath libraryï¼‰ï¼šè¿™ä¸ªåº“æ˜¯æ ‡å‡†Cè¯­è¨€æ•°å­¦åº“çš„æ¥å£ï¼Œå®ƒåŒ…æ‹¬è®¡ç®—ç»å¯¹å€¼çš„math.abså‡½æ•°ï¼Œè¿”å›å¤šä¸ªæ•°ä¸­çš„æœ€å¤§å€¼å’Œæœ€å°å€¼çš„math.maxå‡½æ•°å’Œmath.minå‡½æ•°ï¼Œè®¡ç®—äºŒæ¬¡æ–¹æ ¹çš„math.sqrtå‡½æ•°ï¼Œè®¡ç®—å¯¹æ•°çš„math.logå‡½æ•°ç­‰ã€‚</li>
<li>è°ƒè¯•åº“ï¼ˆdebug libraryï¼‰ï¼šè¿™ä¸ªåº“æä¾›äº†å¯¹ç¨‹åºè¿›è¡Œè°ƒè¯•æ‰€éœ€çš„å‡½æ•°ï¼Œæ¯”å¦‚å¯¹ç¨‹åºè®¾ç½®é’©å­å’Œå–å¾—é’©å­çš„debug.sethookå‡½æ•°å’Œdebug.gethookå‡½æ•°ï¼Œè¿”å›ç»™å®šå‡½æ•°ç›¸å…³ä¿¡æ¯çš„debug. getinfoå‡½æ•°ï¼Œä¸ºå¯¹è±¡è®¾ç½®å…ƒæ•°æ®çš„debug.setmetatableå‡½æ•°ï¼Œè·å–å¯¹è±¡å…ƒæ•°æ®çš„debug.getmetatableå‡½æ•°ç­‰ã€‚</li>
<li>Lua CJSONåº“ï¼šè¿™ä¸ªåº“ç”¨äºå¤„ç†UTF-8ç¼–ç çš„JSONæ ¼å¼ï¼Œå…¶ä¸­cjson.decodeå‡½æ•°å°†ä¸€ä¸ªJSONæ ¼å¼çš„å­—ç¬¦ä¸²è½¬æ¢ä¸ºä¸€ä¸ªLuaå€¼ï¼Œè€Œcjson.encodeå‡½æ•°å°†ä¸€ä¸ªLuaå€¼åºåˆ—åŒ–ä¸ºJSONæ ¼å¼çš„å­—ç¬¦ä¸²ã€‚</li>
<li>Structåº“ï¼šè¿™ä¸ªåº“ç”¨äºåœ¨Luaå€¼å’ŒCç»“æ„ï¼ˆstructï¼‰ä¹‹é—´è¿›è¡Œè½¬æ¢ï¼Œå‡½æ•°struct.packå°†å¤šä¸ªLuaå€¼æ‰“åŒ…æˆä¸€ä¸ªç±»ç»“æ„ï¼ˆstruct-likeï¼‰å­—ç¬¦ä¸²ï¼Œè€Œå‡½æ•°struct.unpackåˆ™ä»ä¸€ä¸ªç±»ç»“æ„å­—ç¬¦ä¸²ä¸­è§£åŒ…å‡ºå¤šä¸ªLuaå€¼ã€‚</li>
<li>Lua cmsgpackåº“ï¼šè¿™ä¸ªåº“ç”¨äºå¤„ç†MessagePackæ ¼å¼çš„æ•°æ®ï¼Œå…¶ä¸­cmsgpack.pack å‡½æ•°å°†Luaå€¼è½¬æ¢ä¸ºMessagePackæ•°æ®ï¼Œè€Œcmsgpack.unpackå‡½æ•°åˆ™å°†MessagePackæ•°æ®è½¬æ¢ä¸ºLuaå€¼ã€‚</li>
</ul>
<p>é€šè¿‡ä½¿ç”¨è¿™äº›åŠŸèƒ½å¼ºå¤§çš„å‡½æ•°åº“ï¼ŒLuaè„šæœ¬å¯ä»¥ç›´æ¥å¯¹æ‰§è¡ŒRediså‘½ä»¤è·å¾—çš„æ•°æ®è¿›è¡Œå¤æ‚çš„æ“ä½œã€‚</p>
<h4 id="åˆ›å»ºrediså…¨å±€è¡¨æ ¼"><a href="#åˆ›å»ºrediså…¨å±€è¡¨æ ¼" class="headerlink" title="åˆ›å»ºrediså…¨å±€è¡¨æ ¼"></a>åˆ›å»ºrediså…¨å±€è¡¨æ ¼</h4><p>åœ¨è¿™ä¸€æ­¥ï¼ŒæœåŠ¡å™¨å°†åœ¨Luaç¯å¢ƒä¸­åˆ›å»ºä¸€ä¸ªredisè¡¨æ ¼ï¼ˆtableï¼‰ï¼Œå¹¶å°†å®ƒè®¾ä¸ºå…¨å±€å˜é‡ã€‚è¿™ä¸ªredisè¡¨æ ¼åŒ…å«ä»¥ä¸‹å‡½æ•°ï¼š</p>
<ul>
<li>ç”¨äºæ‰§è¡ŒRediså‘½ä»¤çš„redis.callå’Œredis.pcallå‡½æ•°ã€‚</li>
<li>ç”¨äºè®°å½•Redisæ—¥å¿—ï¼ˆlogï¼‰çš„redis.logå‡½æ•°ï¼Œä»¥åŠç›¸åº”çš„æ—¥å¿—çº§åˆ«ï¼ˆlevelï¼‰å¸¸é‡ï¼šredis.LOG_DEBUGï¼Œredis.LOG_VERBOSEï¼Œredis.LOG_NOTICEï¼Œä»¥åŠredis.LOG_WARNINGã€‚</li>
<li>ç”¨äºè®¡ç®—SHA1æ ¡éªŒå’Œçš„redis.sha1hexå‡½æ•°ã€‚</li>
<li>ç”¨äºè¿”å›é”™è¯¯ä¿¡æ¯çš„redis.error_replyå‡½æ•°å’Œredis.status_replyå‡½æ•°ã€‚</li>
</ul>
<p>åœ¨è¿™äº›å‡½æ•°é‡Œé¢ï¼Œæœ€å¸¸ç”¨ä¹Ÿæœ€é‡è¦çš„è¦æ•°redis.callå‡½æ•°å’Œredis.pcallå‡½æ•°ï¼Œé€šè¿‡è¿™ä¸¤ä¸ªå‡½æ•°ï¼Œç”¨æˆ·å¯ä»¥ç›´æ¥åœ¨Luaè„šæœ¬ä¸­æ‰§è¡ŒRediså‘½ä»¤ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis &gt; EVAL &quot;return redis.call(&#x27;PING&#x27;)&quot; 0</span><br><span class="line">PONG</span><br></pre></td></tr></table></figure>

<h4 id="ä½¿ç”¨Redisè‡ªåˆ¶çš„éšæœºå‡½æ•°æ¥æ›¿æ¢LuaåŸæœ‰çš„éšæœºå‡½æ•°"><a href="#ä½¿ç”¨Redisè‡ªåˆ¶çš„éšæœºå‡½æ•°æ¥æ›¿æ¢LuaåŸæœ‰çš„éšæœºå‡½æ•°" class="headerlink" title="ä½¿ç”¨Redisè‡ªåˆ¶çš„éšæœºå‡½æ•°æ¥æ›¿æ¢LuaåŸæœ‰çš„éšæœºå‡½æ•°"></a>ä½¿ç”¨Redisè‡ªåˆ¶çš„éšæœºå‡½æ•°æ¥æ›¿æ¢LuaåŸæœ‰çš„éšæœºå‡½æ•°</h4><p>ä¸ºäº†ä¿è¯ç›¸åŒçš„è„šæœ¬å¯ä»¥åœ¨ä¸åŒçš„æœºå™¨ä¸Šäº§ç”Ÿç›¸åŒçš„ç»“æœï¼ŒRedisè¦æ±‚æ‰€æœ‰ä¼ å…¥æœåŠ¡å™¨çš„Luaè„šæœ¬ï¼Œä»¥åŠLuaç¯å¢ƒä¸­çš„æ‰€æœ‰å‡½æ•°ï¼Œéƒ½å¿…é¡»æ˜¯æ— å‰¯ä½œç”¨ï¼ˆside effectï¼‰çš„çº¯å‡½æ•°ï¼ˆpure functionï¼‰ã€‚</p>
<p>ä½†æ˜¯ï¼Œåœ¨ä¹‹å‰è½½å…¥Luaç¯å¢ƒçš„mathå‡½æ•°åº“ä¸­ï¼Œç”¨äºç”Ÿæˆéšæœºæ•°çš„math.randomå‡½æ•°å’Œmath.randomseedå‡½æ•°éƒ½æ˜¯å¸¦æœ‰å‰¯ä½œç”¨çš„ï¼Œå®ƒä»¬ä¸ç¬¦åˆRediså¯¹Luaç¯å¢ƒçš„æ— å‰¯ä½œç”¨è¦æ±‚ã€‚</p>
<p>å› ä¸ºè¿™ä¸ªåŸå› ï¼ŒRedisä½¿ç”¨è‡ªåˆ¶çš„å‡½æ•°æ›¿æ¢äº†mathåº“ä¸­åŸæœ‰çš„math.randomå‡½æ•°å’Œmath.randomseedå‡½æ•°ï¼Œæ›¿æ¢ä¹‹åçš„ä¸¤ä¸ªå‡½æ•°æœ‰ä»¥ä¸‹ç‰¹å¾ï¼š</p>
<ul>
<li>å¯¹äºç›¸åŒçš„seedæ¥è¯´ï¼Œmath.randomæ€»äº§ç”Ÿç›¸åŒçš„éšæœºæ•°åºåˆ—ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯ä¸€ä¸ªçº¯å‡½æ•°ã€‚</li>
<li>é™¤éåœ¨è„šæœ¬ä¸­ä½¿ç”¨math.randomseedæ˜¾å¼åœ°ä¿®æ”¹seedï¼Œå¦åˆ™æ¯æ¬¡è¿è¡Œè„šæœ¬æ—¶ï¼ŒLuaç¯å¢ƒéƒ½ä½¿ç”¨å›ºå®šçš„math.randomseed(0)è¯­å¥æ¥åˆå§‹åŒ–seedã€‚</li>
</ul>
<h4 id="åˆ›å»ºæ’åºè¾…åŠ©å‡½æ•°"><a href="#åˆ›å»ºæ’åºè¾…åŠ©å‡½æ•°" class="headerlink" title="åˆ›å»ºæ’åºè¾…åŠ©å‡½æ•°"></a>åˆ›å»ºæ’åºè¾…åŠ©å‡½æ•°</h4><p>å¯¹äºLuaè„šæœ¬æ¥è¯´ï¼Œå¦ä¸€ä¸ªå¯èƒ½äº§ç”Ÿä¸ä¸€è‡´æ•°æ®çš„åœ°æ–¹æ˜¯é‚£äº›å¸¦æœ‰ä¸ç¡®å®šæ€§è´¨çš„å‘½ä»¤ã€‚æ¯”å¦‚å¯¹äºä¸€ä¸ªé›†åˆé”®æ¥è¯´ï¼Œå› ä¸ºé›†åˆå…ƒç´ çš„æ’åˆ—æ˜¯æ— åºçš„ï¼Œæ‰€ä»¥å³ä½¿ä¸¤ä¸ªé›†åˆçš„å…ƒç´ å®Œå…¨ç›¸åŒï¼Œå®ƒä»¬çš„è¾“å‡ºç»“æœä¹Ÿå¯èƒ½å¹¶ä¸ç›¸åŒã€‚</p>
<p>è€ƒè™‘ä¸‹é¢è¿™ä¸ªé›†åˆä¾‹å­ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">redis&gt; SADD fruit apple banana cherry</span><br><span class="line">(integer) 3</span><br><span class="line"></span><br><span class="line">redis&gt; SMEMBERS fruit</span><br><span class="line">1) &quot;cherry&quot;</span><br><span class="line">2) &quot;banana&quot;</span><br><span class="line">3) &quot;apple&quot;</span><br><span class="line"></span><br><span class="line">redis&gt; SADD another-fruit cherry banana apple</span><br><span class="line">(integer) 3</span><br><span class="line"></span><br><span class="line">redis&gt; SMEMBERS another-fruit</span><br><span class="line">1) &quot;apple&quot;</span><br><span class="line">2) &quot;banana&quot;</span><br><span class="line">3) &quot;cherry&quot;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªä¾‹å­ä¸­çš„fruité›†åˆå’Œanother-fruité›†åˆåŒ…å«çš„å…ƒç´ æ˜¯å®Œå…¨ç›¸åŒçš„ï¼Œåªæ˜¯å› ä¸ºé›†åˆæ·»åŠ å…ƒç´ çš„é¡ºåºä¸åŒï¼ŒSMEMBERSå‘½ä»¤çš„è¾“å‡ºå°±äº§ç”Ÿäº†ä¸åŒçš„ç»“æœã€‚</p>
<p>Rediså°†SMEMBERSè¿™ç§åœ¨ç›¸åŒæ•°æ®é›†ä¸Šå¯èƒ½ä¼šäº§ç”Ÿä¸åŒè¾“å‡ºçš„å‘½ä»¤ç§°ä¸ºâ€œå¸¦æœ‰ä¸ç¡®å®šæ€§çš„å‘½ä»¤â€ï¼Œè¿™äº›å‘½ä»¤åŒ…æ‹¬ï¼š</p>
<ul>
<li>SINTER</li>
<li>SUNION</li>
<li>SDIFF</li>
<li>SMEMBERS</li>
<li>HKEYS</li>
<li>HVALS</li>
<li>KEYS</li>
</ul>
<p>ä¸ºäº†æ¶ˆé™¤è¿™äº›å‘½ä»¤å¸¦æ¥çš„ä¸ç¡®å®šæ€§ï¼ŒæœåŠ¡å™¨ä¼šä¸ºLuaç¯å¢ƒåˆ›å»ºä¸€ä¸ªæ’åºè¾…åŠ©å‡½æ•°__redis__compare_helperï¼Œå½“Luaè„šæœ¬æ‰§è¡Œå®Œä¸€ä¸ªå¸¦æœ‰ä¸ç¡®å®šæ€§çš„å‘½ä»¤ä¹‹åï¼Œç¨‹åºä¼šä½¿ç”¨__redis__compare_helperä½œä¸ºå¯¹æ¯”å‡½æ•°ï¼Œè‡ªåŠ¨è°ƒç”¨table.sortå‡½æ•°å¯¹å‘½ä»¤çš„è¿”å›å€¼åšä¸€æ¬¡æ’åºï¼Œä»¥æ­¤æ¥ä¿è¯ç›¸åŒçš„æ•°æ®é›†æ€»æ˜¯äº§ç”Ÿç›¸åŒçš„è¾“å‡ºã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœæˆ‘ä»¬åœ¨Luaè„šæœ¬ä¸­å¯¹fruité›†åˆå’Œanother-fruité›†åˆæ‰§è¡ŒSMEMBERSå‘½ä»¤ï¼Œé‚£ä¹ˆä¸¤ä¸ªè„šæœ¬å°†å¾—å‡ºç›¸åŒçš„ç»“æœï¼Œå› ä¸ºè„šæœ¬å·²ç»å¯¹SMEMBERSå‘½ä»¤çš„è¾“å‡ºè¿›è¡Œè¿‡æ’åºäº†ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">redis&gt; EVAL &quot;return redis.call(&#x27;SMEMBERS&#x27;, KEYS[1])&quot; 1 fruit</span><br><span class="line">1ï¼‰&quot;apple&quot;</span><br><span class="line">2) &quot;banana&quot;</span><br><span class="line">3) &quot;cherry&quot;</span><br><span class="line"></span><br><span class="line">redis&gt; EVAL &quot;return redis.call(&#x27;SMEMBERS&#x27;, KEYS[1])&quot; 1 another-fruit</span><br><span class="line">1) &quot;apple&quot;</span><br><span class="line">2) &quot;banana&quot;</span><br><span class="line">3) &quot;cherry&quot;</span><br></pre></td></tr></table></figure>

<h4 id="åˆ›å»ºredis-pcallå‡½æ•°çš„é”™è¯¯æŠ¥å‘Šè¾…åŠ©å‡½æ•°"><a href="#åˆ›å»ºredis-pcallå‡½æ•°çš„é”™è¯¯æŠ¥å‘Šè¾…åŠ©å‡½æ•°" class="headerlink" title="åˆ›å»ºredis.pcallå‡½æ•°çš„é”™è¯¯æŠ¥å‘Šè¾…åŠ©å‡½æ•°"></a>åˆ›å»ºredis.pcallå‡½æ•°çš„é”™è¯¯æŠ¥å‘Šè¾…åŠ©å‡½æ•°</h4><p>åœ¨è¿™ä¸€æ­¥ï¼ŒæœåŠ¡å™¨å°†ä¸ºLuaç¯å¢ƒåˆ›å»ºä¸€ä¸ªåä¸º__redis__err__handlerçš„é”™è¯¯å¤„ç†å‡½æ•°ï¼Œå½“è„šæœ¬è°ƒç”¨redis.pcallå‡½æ•°æ‰§è¡ŒRediså‘½ä»¤ï¼Œå¹¶ä¸”è¢«æ‰§è¡Œçš„å‘½ä»¤å‡ºç°é”™è¯¯æ—¶ï¼Œ__redis__err__handlerå°±ä¼šæ‰“å°å‡ºé”™ä»£ç çš„æ¥æºå’Œå‘ç”Ÿé”™è¯¯çš„è¡Œæ•°ï¼Œä¸ºç¨‹åºçš„è°ƒè¯•æä¾›æ–¹ä¾¿ã€‚</p>
<h4 id="ä¿æŠ¤Luaçš„å…¨å±€ç¯å¢ƒ"><a href="#ä¿æŠ¤Luaçš„å…¨å±€ç¯å¢ƒ" class="headerlink" title="ä¿æŠ¤Luaçš„å…¨å±€ç¯å¢ƒ"></a>ä¿æŠ¤Luaçš„å…¨å±€ç¯å¢ƒ</h4><p>åœ¨è¿™ä¸€æ­¥ï¼ŒæœåŠ¡å™¨å°†å¯¹Luaç¯å¢ƒä¸­çš„å…¨å±€ç¯å¢ƒè¿›è¡Œä¿æŠ¤ï¼Œç¡®ä¿ä¼ å…¥æœåŠ¡å™¨çš„è„šæœ¬ä¸ä¼šå› ä¸ºå¿˜è®°ä½¿ç”¨localå…³é”®å­—è€Œå°†é¢å¤–çš„å…¨å±€å˜é‡æ·»åŠ åˆ°Luaç¯å¢ƒé‡Œé¢ã€‚</p>
<p>ä¸è¿‡Rediså¹¶æœªç¦æ­¢ç”¨æˆ·ä¿®æ”¹å·²å­˜åœ¨çš„å…¨å±€å˜é‡ï¼Œæ‰€ä»¥åœ¨æ‰§è¡ŒLuaè„šæœ¬çš„æ—¶å€™ï¼Œå¿…é¡»éå¸¸å°å¿ƒï¼Œä»¥å…é”™è¯¯åœ°ä¿®æ”¹äº†å·²å­˜åœ¨çš„å…¨å±€å˜é‡ã€‚</p>
<h4 id="å°†Luaç¯å¢ƒä¿å­˜åˆ°æœåŠ¡å™¨çŠ¶æ€çš„luaå±æ€§é‡Œé¢"><a href="#å°†Luaç¯å¢ƒä¿å­˜åˆ°æœåŠ¡å™¨çŠ¶æ€çš„luaå±æ€§é‡Œé¢" class="headerlink" title="å°†Luaç¯å¢ƒä¿å­˜åˆ°æœåŠ¡å™¨çŠ¶æ€çš„luaå±æ€§é‡Œé¢"></a>å°†Luaç¯å¢ƒä¿å­˜åˆ°æœåŠ¡å™¨çŠ¶æ€çš„luaå±æ€§é‡Œé¢</h4><p>ç»è¿‡ä»¥ä¸Šçš„ä¸€ç³»åˆ—ä¿®æ”¹ï¼ŒRedisæœåŠ¡å™¨å¯¹Luaç¯å¢ƒçš„ä¿®æ”¹å·¥ä½œåˆ°æ­¤å°±ç»“æŸäº†ï¼Œåœ¨æœ€åçš„è¿™ä¸€æ­¥ï¼ŒæœåŠ¡å™¨ä¼šå°†Luaç¯å¢ƒå’ŒæœåŠ¡å™¨çŠ¶æ€çš„luaå±æ€§å…³è”èµ·æ¥ã€‚</p>
<p><img src="/..%5Cimg%5CRedis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%5C%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%8A%B6%E6%80%81%E4%B8%AD%E7%9A%84Lua%E7%8E%AF%E5%A2%83.png" alt="æœåŠ¡å™¨çŠ¶æ€ä¸­çš„Luaç¯å¢ƒ"></p>
<p>å› ä¸ºRedisä½¿ç”¨ä¸²è¡ŒåŒ–çš„æ–¹å¼æ¥æ‰§è¡ŒRediså‘½ä»¤ï¼Œæ‰€ä»¥åœ¨ä»»ä½•ç‰¹å®šæ—¶é—´é‡Œï¼Œæœ€å¤šéƒ½åªä¼šæœ‰ä¸€ä¸ªè„šæœ¬èƒ½å¤Ÿè¢«æ”¾è¿›Luaç¯å¢ƒé‡Œé¢è¿è¡Œï¼Œå› æ­¤ï¼Œæ•´ä¸ªRedisæœåŠ¡å™¨åªéœ€è¦åˆ›å»ºä¸€ä¸ªLuaç¯å¢ƒå³å¯ã€‚</p>
<h3 id="Luaç¯å¢ƒåä½œç»„ä»¶"><a href="#Luaç¯å¢ƒåä½œç»„ä»¶" class="headerlink" title="Luaç¯å¢ƒåä½œç»„ä»¶"></a>Luaç¯å¢ƒåä½œç»„ä»¶</h3><p>é™¤äº†åˆ›å»ºå¹¶ä¿®æ”¹Luaç¯å¢ƒä¹‹å¤–ï¼ŒRedisæœåŠ¡å™¨è¿˜åˆ›å»ºäº†ä¸¤ä¸ªç”¨äºä¸Luaç¯å¢ƒè¿›è¡Œåä½œçš„ç»„ä»¶ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯è´Ÿè´£æ‰§è¡ŒLuaè„šæœ¬ä¸­çš„Rediså‘½ä»¤çš„ä¼ªå®¢æˆ·ç«¯ï¼Œä»¥åŠç”¨äºä¿å­˜Luaè„šæœ¬çš„lua_scriptså­—å…¸ã€‚</p>
<h4 id="ä¼ªå®¢æˆ·ç«¯"><a href="#ä¼ªå®¢æˆ·ç«¯" class="headerlink" title="ä¼ªå®¢æˆ·ç«¯"></a>ä¼ªå®¢æˆ·ç«¯</h4><p>å› ä¸ºæ‰§è¡ŒRediså‘½ä»¤å¿…é¡»æœ‰ç›¸åº”çš„å®¢æˆ·ç«¯çŠ¶æ€ï¼Œæ‰€ä»¥ä¸ºäº†æ‰§è¡ŒLuaè„šæœ¬ä¸­åŒ…å«çš„Rediså‘½ä»¤ï¼ŒRedisæœåŠ¡å™¨ä¸“é—¨ä¸ºLuaç¯å¢ƒåˆ›å»ºäº†ä¸€ä¸ªä¼ªå®¢æˆ·ç«¯ï¼Œå¹¶ç”±è¿™ä¸ªä¼ªå®¢æˆ·ç«¯è´Ÿè´£å¤„ç†Luaè„šæœ¬ä¸­åŒ…å«çš„æ‰€æœ‰Rediså‘½ä»¤ã€‚</p>
<p>Luaè„šæœ¬ä½¿ç”¨redis.callå‡½æ•°æˆ–è€…redis.pcallå‡½æ•°æ‰§è¡Œä¸€ä¸ªRediså‘½ä»¤ï¼Œéœ€è¦å®Œæˆä»¥ä¸‹æ­¥éª¤ï¼š</p>
<ol>
<li>Luaç¯å¢ƒå°†redis.callå‡½æ•°æˆ–è€…redis.pcallå‡½æ•°æƒ³è¦æ‰§è¡Œçš„å‘½ä»¤ä¼ ç»™ä¼ªå®¢æˆ·ç«¯ã€‚</li>
<li>ä¼ªå®¢æˆ·ç«¯å°†è„šæœ¬æƒ³è¦æ‰§è¡Œçš„å‘½ä»¤ä¼ ç»™å‘½ä»¤æ‰§è¡Œå™¨ã€‚</li>
<li>å‘½ä»¤æ‰§è¡Œå™¨æ‰§è¡Œä¼ªå®¢æˆ·ç«¯ä¼ ç»™å®ƒçš„å‘½ä»¤ï¼Œå¹¶å°†å‘½ä»¤çš„æ‰§è¡Œç»“æœè¿”å›ç»™ä¼ªå®¢æˆ·ç«¯ã€‚</li>
<li>ä¼ªå®¢æˆ·ç«¯æ¥æ”¶å‘½ä»¤æ‰§è¡Œå™¨è¿”å›çš„å‘½ä»¤ç»“æœï¼Œå¹¶å°†è¿™ä¸ªå‘½ä»¤ç»“æœè¿”å›ç»™Luaç¯å¢ƒã€‚</li>
<li>Luaç¯å¢ƒåœ¨æ¥æ”¶åˆ°å‘½ä»¤ç»“æœä¹‹åï¼Œå°†è¯¥ç»“æœè¿”å›ç»™redis.callå‡½æ•°æˆ–è€…redis.pcallå‡½æ•°ã€‚</li>
<li>æ¥æ”¶åˆ°ç»“æœçš„redis.callå‡½æ•°æˆ–è€…redis.pcallå‡½æ•°ä¼šå°†å‘½ä»¤ç»“æœä½œä¸ºå‡½æ•°è¿”å›å€¼è¿”å›ç»™è„šæœ¬ä¸­çš„è°ƒç”¨è€…ã€‚</li>
</ol>
<p><img src="/..%5Cimg%5CRedis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%5CLua%E8%84%9A%E6%9C%AC%E6%89%A7%E8%A1%8CRedis%E5%91%BD%E4%BB%A4%E6%97%B6%E7%9A%84%E9%80%9A%E4%BF%A1%E6%AD%A5%E9%AA%A4.png" alt="Luaè„šæœ¬æ‰§è¡ŒRediså‘½ä»¤æ—¶çš„é€šä¿¡æ­¥éª¤"></p>
<h4 id="lua-scriptså­—å…¸"><a href="#lua-scriptså­—å…¸" class="headerlink" title="lua_scriptså­—å…¸"></a>lua_scriptså­—å…¸</h4><p>é™¤äº†ä¼ªå®¢æˆ·ç«¯ä¹‹å¤–ï¼ŒRedisæœåŠ¡å™¨ä¸ºLuaç¯å¢ƒåˆ›å»ºçš„å¦ä¸€ä¸ªåä½œç»„ä»¶æ˜¯lua_scriptså­—å…¸ï¼Œè¿™ä¸ªå­—å…¸çš„é”®ä¸ºæŸä¸ªLuaè„šæœ¬çš„SHA1æ ¡éªŒå’Œï¼ˆchecksumï¼‰ï¼Œè€Œå­—å…¸çš„å€¼åˆ™æ˜¯SHA1æ ¡éªŒå’Œå¯¹åº”çš„Luaè„šæœ¬ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisServer</span> &#123;</span></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	dict *lua_scripts;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


<p>RedisæœåŠ¡å™¨ä¼šå°†æ‰€æœ‰è¢«EVALå‘½ä»¤æ‰§è¡Œè¿‡çš„Luaè„šæœ¬ï¼Œä»¥åŠæ‰€æœ‰è¢«SCRIPT LOADå‘½ä»¤è½½å…¥è¿‡çš„Luaè„šæœ¬éƒ½ä¿å­˜åˆ°lua_scripts å­—å…¸é‡Œé¢ã€‚</p>
<p>lua_scriptså­—å…¸æœ‰ä¸¤ä¸ªä½œç”¨ï¼Œä¸€ä¸ªæ˜¯å®ç°SCRIPT EXISTSå‘½ä»¤ï¼Œå¦ä¸€ä¸ªæ˜¯å®ç°è„šæœ¬å¤åˆ¶åŠŸèƒ½ã€‚</p>
<h3 id="EVALå‘½ä»¤çš„å®ç°"><a href="#EVALå‘½ä»¤çš„å®ç°" class="headerlink" title="EVALå‘½ä»¤çš„å®ç°"></a>EVALå‘½ä»¤çš„å®ç°</h3><p>EVALå‘½ä»¤çš„æ‰§è¡Œè¿‡ç¨‹å¯ä»¥åˆ†ä¸ºä»¥ä¸‹ä¸‰ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>æ ¹æ®å®¢æˆ·ç«¯ç»™å®šçš„Luaè„šæœ¬ï¼Œåœ¨ Luaç¯å¢ƒä¸­å®šä¹‰ä¸€ä¸ªLuaå‡½æ•°ã€‚</li>
<li>å°†å®¢æˆ·ç«¯ç»™å®šçš„è„šæœ¬ä¿å­˜åˆ°lua_scriptså­—å…¸ï¼Œç­‰å¾…å°†æ¥è¿›ä¸€æ­¥ä½¿ç”¨ã€‚</li>
<li>æ‰§è¡Œåˆšåˆšåœ¨Luaç¯å¢ƒä¸­å®šä¹‰çš„å‡½æ•°ï¼Œä»¥æ­¤æ¥æ‰§è¡Œå®¢æˆ·ç«¯ç»™å®šçš„Luaè„šæœ¬ã€‚</li>
</ol>
<p>ä»¥ä¸‹ä¸‰ä¸ªå°èŠ‚å°†ä»¥ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis&gt; EVAL &quot;return &#x27;hello world&#x27;&quot; 0</span><br><span class="line">&quot;hello world&quot;</span><br></pre></td></tr></table></figure>


<p>å‘½ä»¤ä¸ºç¤ºä¾‹ï¼Œåˆ†åˆ«ä»‹ç»EVALå‘½ä»¤æ‰§è¡Œçš„ä¸‰ä¸ªæ­¥éª¤ã€‚</p>
<h4 id="å®šä¹‰è„šæœ¬å‡½æ•°"><a href="#å®šä¹‰è„šæœ¬å‡½æ•°" class="headerlink" title="å®šä¹‰è„šæœ¬å‡½æ•°"></a>å®šä¹‰è„šæœ¬å‡½æ•°</h4><p>å½“å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€EVALå‘½ä»¤ï¼Œè¦æ±‚æ‰§è¡ŒæŸä¸ªLuaè„šæœ¬çš„æ—¶å€™ï¼ŒæœåŠ¡å™¨é¦–å…ˆè¦åšçš„å°±æ˜¯åœ¨Luaç¯å¢ƒä¸­ï¼Œä¸ºä¼ å…¥çš„è„šæœ¬å®šä¹‰ä¸€ä¸ªä¸è¿™ä¸ªè„šæœ¬ç›¸å¯¹åº”çš„Luaå‡½æ•°ï¼Œå…¶ä¸­ï¼ŒLuaå‡½æ•°çš„åå­—ç”±f_å‰ç¼€åŠ ä¸Šè„šæœ¬çš„SHA1æ ¡éªŒå’Œï¼ˆå››åä¸ªå­—ç¬¦é•¿ï¼‰ç»„æˆï¼Œè€Œå‡½æ•°çš„ä½“ï¼ˆbodyï¼‰åˆ™æ˜¯è„šæœ¬æœ¬èº«ã€‚<br>ä¸¾ä¸ªä¾‹å­ï¼Œå¯¹äºå‘½ä»¤ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EVAL &quot;return &#x27;hello world&#x27;&quot; 0</span><br></pre></td></tr></table></figure>


<p>æ¥è¯´ï¼ŒæœåŠ¡å™¨å°†åœ¨Luaç¯å¢ƒä¸­å®šä¹‰ä»¥ä¸‹å‡½æ•°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function f_5332031c6b470dc5a0dd9b4bf2030dea6d65de91()</span><br><span class="line">	return &#x27;hello world&#x27;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>


<p>å› ä¸ºå®¢æˆ·ç«¯ä¼ å…¥çš„è„šæœ¬ä¸ºreturn â€˜hello world â€˜ï¼Œè€Œè¿™ä¸ªè„šæœ¬çš„SHA1æ ¡éªŒå’Œä¸º5332031c6b470dc5a0dd9b4bf2030dea6d65de91ï¼Œæ‰€ä»¥å‡½æ•°çš„åå­—ä¸ºf_5332031c6b470dc5a0dd9b4bf2030dea6d65de91ï¼Œè€Œå‡½æ•°çš„ä½“åˆ™ä¸ºreturn â€˜hello world â€˜ã€‚</p>
<p>ä½¿ç”¨å‡½æ•°æ¥ä¿å­˜å®¢æˆ·ç«¯ä¼ å…¥çš„è„šæœ¬æœ‰ä»¥ä¸‹å¥½å¤„ï¼š</p>
<ul>
<li>æ‰§è¡Œè„šæœ¬çš„æ­¥éª¤éå¸¸ç®€å•ï¼Œåªè¦è°ƒç”¨ä¸è„šæœ¬ç›¸å¯¹åº”çš„å‡½æ•°å³å¯ã€‚</li>
<li>é€šè¿‡å‡½æ•°çš„å±€éƒ¨æ€§æ¥è®©Luaç¯å¢ƒä¿æŒæ¸…æ´ï¼Œå‡å°‘äº†åƒåœ¾å›æ”¶çš„å·¥ä½œé‡ï¼Œå¹¶ä¸”é¿å…äº†ä½¿ç”¨å…¨å±€å˜é‡ã€‚</li>
<li>å¦‚æœæŸä¸ªè„šæœ¬æ‰€å¯¹åº”çš„å‡½æ•°åœ¨Luaç¯å¢ƒä¸­è¢«å®šä¹‰è¿‡è‡³å°‘ä¸€æ¬¡ï¼Œé‚£ä¹ˆåªè¦è®°å¾—è¿™ä¸ªè„šæœ¬çš„SHA1æ ¡éªŒå’Œï¼ŒæœåŠ¡å™¨å°±å¯ä»¥åœ¨ä¸çŸ¥é“è„šæœ¬æœ¬èº«çš„æƒ…å†µä¸‹ï¼Œç›´æ¥é€šè¿‡è°ƒç”¨Luaå‡½æ•°æ¥æ‰§è¡Œè„šæœ¬ï¼Œè¿™æ˜¯EVALSHAå‘½ä»¤çš„å®ç°åŸç†ã€‚</li>
</ul>
<h4 id="å°†è„šæœ¬ä¿å­˜åˆ°lua-scriptså­—å…¸"><a href="#å°†è„šæœ¬ä¿å­˜åˆ°lua-scriptså­—å…¸" class="headerlink" title="å°†è„šæœ¬ä¿å­˜åˆ°lua_scriptså­—å…¸"></a>å°†è„šæœ¬ä¿å­˜åˆ°lua_scriptså­—å…¸</h4><p>EVALå‘½ä»¤è¦åšçš„ç¬¬äºŒä»¶äº‹æ˜¯å°†å®¢æˆ·ç«¯ä¼ å…¥çš„è„šæœ¬ä¿å­˜åˆ°æœåŠ¡å™¨çš„lua_scriptså­—å…¸é‡Œé¢ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¯¹äºå‘½ä»¤ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EVAL &quot;return &#x27;hello worid&#x27;&quot; 0</span><br></pre></td></tr></table></figure>


<p>æ¥è¯´ï¼ŒæœåŠ¡å™¨å°†åœ¨lua_scriptså­—å…¸ä¸­æ–°æ·»åŠ ä¸€ä¸ªé”®å€¼å¯¹ï¼Œå…¶ä¸­é”®ä¸ºLuaè„šæœ¬çš„SHA1æ ¡éªŒå’Œï¼š</p>
<p>5332031c6b470dc5a0dd9b4bf2030dea6d65de91</p>
<p>è€Œå€¼åˆ™ä¸ºLuaè„šæœ¬æœ¬èº«ï¼š</p>
<p>return â€˜hello worldâ€™</p>
<h4 id="æ‰§è¡Œè„šæœ¬å‡½æ•°"><a href="#æ‰§è¡Œè„šæœ¬å‡½æ•°" class="headerlink" title="æ‰§è¡Œè„šæœ¬å‡½æ•°"></a>æ‰§è¡Œè„šæœ¬å‡½æ•°</h4><p>åœ¨ä¸ºè„šæœ¬å®šä¹‰å‡½æ•°ï¼Œå¹¶ä¸”å°†è„šæœ¬ä¿å­˜åˆ°lua_scriptså­—å…¸ä¹‹åï¼ŒæœåŠ¡å™¨è¿˜éœ€è¦è¿›è¡Œä¸€äº›è®¾ç½®é’©å­ã€ä¼ å…¥å‚æ•°ä¹‹ç±»çš„å‡†å¤‡åŠ¨ä½œï¼Œæ‰èƒ½æ­£å¼å¼€å§‹æ‰§è¡Œè„šæœ¬ã€‚</p>
<p>æ•´ä¸ªå‡†å¤‡å’Œæ‰§è¡Œè„šæœ¬çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>å°†EVALå‘½ä»¤ä¸­ä¼ å…¥çš„é”®åï¼ˆkey nameï¼‰å‚æ•°å’Œè„šæœ¬å‚æ•°åˆ†åˆ«ä¿å­˜åˆ°KEYSæ•°ç»„å’ŒARGVæ•°ç»„ï¼Œç„¶åå°†è¿™ä¸¤ä¸ªæ•°ç»„ä½œä¸ºå…¨å±€å˜é‡ä¼ å…¥åˆ°Luaç¯å¢ƒé‡Œé¢ã€‚</li>
<li>ä¸ºLuaç¯å¢ƒè£…è½½è¶…æ—¶å¤„ç†é’©å­ï¼ˆhookï¼‰ï¼Œè¿™ä¸ªé’©å­å¯ä»¥åœ¨è„šæœ¬å‡ºç°è¶…æ—¶è¿è¡Œæƒ…å†µæ—¶ï¼Œè®©å®¢æˆ·ç«¯é€šè¿‡SCRIPT KILLå‘½ä»¤åœæ­¢è„šæœ¬ï¼Œæˆ–è€…é€šè¿‡SHUTDOWNå‘½ä»¤ç›´æ¥å…³é—­æœåŠ¡å™¨ã€‚</li>
<li>æ‰§è¡Œè„šæœ¬å‡½æ•°ã€‚</li>
<li>ç§»é™¤ä¹‹å‰è£…è½½çš„è¶…æ—¶é’©å­ã€‚</li>
<li>å°†æ‰§è¡Œè„šæœ¬å‡½æ•°æ‰€å¾—çš„ç»“æœä¿å­˜åˆ°å®¢æˆ·ç«¯çŠ¶æ€çš„è¾“å‡ºç¼“å†²åŒºé‡Œé¢ï¼Œç­‰å¾…æœåŠ¡å™¨å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚</li>
<li>å¯¹Luaç¯å¢ƒæ‰§è¡Œåƒåœ¾å›æ”¶æ“ä½œã€‚</li>
</ol>
<h3 id="EVALSHAå‘½ä»¤çš„å®ç°"><a href="#EVALSHAå‘½ä»¤çš„å®ç°" class="headerlink" title="EVALSHAå‘½ä»¤çš„å®ç°"></a>EVALSHAå‘½ä»¤çš„å®ç°</h3><p>æœ¬ç« å‰é¢ä»‹ç»EVALå‘½ä»¤çš„å®ç°æ—¶è¯´è¿‡ï¼Œæ¯ä¸ªè¢«EVALå‘½ä»¤æˆåŠŸæ‰§è¡Œè¿‡çš„Luaè„šæœ¬ï¼Œåœ¨Luaç¯å¢ƒé‡Œé¢éƒ½æœ‰ä¸€ä¸ªä¸è¿™ä¸ªè„šæœ¬ç›¸å¯¹åº”çš„Luaå‡½æ•°ï¼Œå‡½æ•°çš„åå­—ç”±f_å‰ç¼€åŠ ä¸Š40ä¸ªå­—ç¬¦é•¿çš„SHA1æ ¡éªŒå’Œç»„æˆï¼Œä¾‹å¦‚f_5332031c6b470dc5a0dd9b4bf2030dea6d65de91ã€‚</p>
<p>åªè¦è„šæœ¬å¯¹åº”çš„å‡½æ•°æ›¾ç»åœ¨Luaç¯å¢ƒé‡Œé¢å®šä¹‰è¿‡ï¼Œé‚£ä¹ˆå³ä½¿ä¸çŸ¥é“è„šæœ¬çš„å†…å®¹æœ¬èº«ï¼Œå®¢æˆ·ç«¯ä¹Ÿå¯ä»¥æ ¹æ®è„šæœ¬çš„SHA1æ ¡éªŒå’Œæ¥è°ƒç”¨è„šæœ¬å¯¹åº”çš„å‡½æ•°ï¼Œä»è€Œè¾¾åˆ°æ‰§è¡Œè„šæœ¬çš„ç›®çš„ï¼Œè¿™å°±æ˜¯EVALSHAå‘½ä»¤çš„å®ç°åŸç†ã€‚</p>
<p>å¯ä»¥ç”¨ä¼ªä»£ç æ¥æè¿°è¿™ä¸€åŸç†ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">def EVALSHA(sha1):</span><br><span class="line">	#æ‹¼æ¥å‡ºå‡½æ•°çš„åå­—</span><br><span class="line">	#ä¾‹å¦‚:f_5332031c6b470dc5a0dd9b4bf2030dea6d65de91func name = &quot;f_&quot;+ sha1</span><br><span class="line">	#æŸ¥çœ‹è¿™ä¸ªå‡½æ•°åœ¨Luaç¯å¢ƒä¸­æ˜¯å¦å­˜åœ¨</span><br><span class="line">	if function_exists_in_lua_env(func_name):</span><br><span class="line">		#å¦‚æœå‡½æ•°å­˜åœ¨ï¼Œé‚£ä¹ˆæ‰§è¡Œå®ƒ</span><br><span class="line">		execute_lua_function(func_name)</span><br><span class="line">	else:</span><br><span class="line">		#å¦‚æœå‡½æ•°ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆè¿”å›ä¸€ä¸ªé”™è¯¯</span><br><span class="line">		send_script_error(&quot;SCRIPT NOT FOUND&quot;)</span><br></pre></td></tr></table></figure>

<h3 id="è„šæœ¬ç®¡ç†å‘½ä»¤çš„å®ç°"><a href="#è„šæœ¬ç®¡ç†å‘½ä»¤çš„å®ç°" class="headerlink" title="è„šæœ¬ç®¡ç†å‘½ä»¤çš„å®ç°"></a>è„šæœ¬ç®¡ç†å‘½ä»¤çš„å®ç°</h3><p>é™¤äº†EVALå‘½ä»¤å’ŒEVALSHAå‘½ä»¤ä¹‹å¤–ï¼ŒRedisä¸­ä¸Luaè„šæœ¬æœ‰å…³çš„å‘½ä»¤è¿˜æœ‰å››ä¸ªï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯SCRIPT FLUSHå‘½ä»¤ã€SCRIPT EXISTSå‘½ä»¤ã€SCRIPT LOADå‘½ä»¤ã€ä»¥åŠSCRIPT KILLå‘½ä»¤ã€‚</p>
<h4 id="SCRIPT-FLUSH"><a href="#SCRIPT-FLUSH" class="headerlink" title="SCRIPT FLUSH"></a>SCRIPT FLUSH</h4><p>SCRIPT FLUSHå‘½ä»¤ç”¨äºæ¸…é™¤æœåŠ¡å™¨ä¸­æ‰€æœ‰å’ŒLuaè„šæœ¬æœ‰å…³çš„ä¿¡æ¯ï¼Œè¿™ä¸ªå‘½ä»¤ä¼šé‡Šæ”¾å¹¶é‡å»ºlua_scriptså­—å…¸ï¼Œå…³é—­ç°æœ‰çš„Luaç¯å¢ƒå¹¶é‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„Luaç¯å¢ƒã€‚</p>
<p>ä»¥ä¸‹ä¸ºSCRIPT FLUSHå‘½ä»¤çš„å®ç°ä¼ªä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">def SCRIPT_FLUSH():</span><br><span class="line">	#é‡Šæ”¾è„šæœ¬å­—å…¸</span><br><span class="line">	dictRelease(server.lua_scripts)</span><br><span class="line">	#é‡å»ºè„šæœ¬å­—å…¸</span><br><span class="line">	server.lua_scripts = dictCreate(...)</span><br><span class="line">	#å…³é—­Luaç¯å¢ƒ</span><br><span class="line">	lua_close(server.lua)</span><br><span class="line">	#åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„Luaç¯å¢ƒ</span><br><span class="line">	server.lua = init_lua_env()</span><br></pre></td></tr></table></figure>

<h4 id="SCRIPT-EXISTS"><a href="#SCRIPT-EXISTS" class="headerlink" title="SCRIPT EXISTS"></a>SCRIPT EXISTS</h4><p>SCRIPT EXISTSå‘½ä»¤æ ¹æ®è¾“å…¥çš„SHA1æ ¡éªŒå’Œï¼Œæ£€æŸ¥æ ¡éªŒå’Œå¯¹åº”çš„è„šæœ¬æ˜¯å¦å­˜åœ¨äºæœåŠ¡å™¨ä¸­ã€‚</p>
<p>SCRIPT EXISTSå‘½ä»¤æ˜¯é€šè¿‡æ£€æŸ¥ç»™å®šçš„æ ¡éªŒå’Œæ˜¯å¦å­˜åœ¨äºlua_scriptså­—å…¸æ¥å®ç°çš„ï¼Œä»¥ä¸‹æ˜¯è¯¥å‘½ä»¤çš„å®ç°ä¼ªä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">def SCRIPT_EXISTS(*sha1_list):</span><br><span class="line">	#ç»“æœåˆ—è¡¨</span><br><span class="line">	result_list = []</span><br><span class="line">	#éå†è¾“å…¥çš„æ‰€æœ‰SHA1æ ¡éªŒå’Œ</span><br><span class="line">	for sha1 in sha1_list:</span><br><span class="line">		#æ£€æŸ¥æ ¡éªŒå’Œæ˜¯å¦ä¸ºlua_scriptså­—å…¸çš„é”®</span><br><span class="line">		#å¦‚æœæ˜¯çš„è¯ï¼Œé‚£ä¹ˆè¡¨ç¤ºæ ¡éªŒå’Œå¯¹åº”çš„è„šæœ¬å­˜åœ¨</span><br><span class="line">		#å¦åˆ™çš„è¯ï¼Œè„šæœ¬å°±ä¸å­˜åœ¨</span><br><span class="line">		if sha1 in server.lua_scripts:</span><br><span class="line">			#å­˜åœ¨ç”¨1è¡¨ç¤º</span><br><span class="line">			result_list.append(1)</span><br><span class="line">		else:</span><br><span class="line">			#ä¸å­˜åœ¨ç”¨0è¡¨ç¤º</span><br><span class="line">			result_list.append(0)</span><br><span class="line">	#å‘å®¢æˆ·ç«¯è¿”å›ç»“æœåˆ—è¡¨</span><br><span class="line">	send_list_reply(result_list)</span><br></pre></td></tr></table></figure>

<p>å®ç°SCRIPT EXISTSå®é™…ä¸Šå¹¶ä¸éœ€è¦lua_scriptså­—å…¸çš„å€¼ã€‚å¦‚æœlua_scriptså­—å…¸åªç”¨äºå®ç°SCRIPT EXISTSå‘½ä»¤çš„è¯ï¼Œé‚£ä¹ˆå­—å…¸åªéœ€è¦ä¿å­˜Luaè„šæœ¬çš„SHA1æ ¡éªŒå’Œå°±å¯ä»¥äº†ï¼Œå¹¶ä¸éœ€è¦ä¿å­˜Luaè„šæœ¬æœ¬èº«ã€‚lua_scriptså­—å…¸æ—¢ä¿å­˜è„šæœ¬çš„SHA1æ ¡éªŒå’Œï¼Œåˆä¿å­˜è„šæœ¬æœ¬èº«çš„åŸå› æ˜¯ä¸ºäº†å®ç°è„šæœ¬å¤åˆ¶åŠŸèƒ½ã€‚</p>
<h4 id="SCRIPT-LOAD"><a href="#SCRIPT-LOAD" class="headerlink" title="SCRIPT LOAD"></a>SCRIPT LOAD</h4><p>SCRIPT LOADå‘½ä»¤æ‰€åšçš„äº‹æƒ…å’ŒEVALå‘½ä»¤æ‰§è¡Œè„šæœ¬æ—¶æ‰€åšçš„å‰ä¸¤æ­¥å®Œå…¨ä¸€æ ·ï¼šå‘½ä»¤é¦–å…ˆåœ¨Luaç¯å¢ƒä¸­ä¸ºè„šæœ¬åˆ›å»ºç›¸å¯¹åº”çš„å‡½æ•°ï¼Œç„¶åå†å°†è„šæœ¬ä¿å­˜åˆ°lua_scriptså­—å…¸é‡Œé¢ã€‚å®Œæˆäº†è¿™äº›æ­¥éª¤ä¹‹åï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥ä½¿ç”¨EVALSHAå‘½ä»¤æ¥æ‰§è¡Œå‰é¢è¢«SCRIPT LOADå‘½ä»¤è½½å…¥çš„è„šæœ¬äº†ã€‚</p>
<h4 id="SCRIPT-KILL"><a href="#SCRIPT-KILL" class="headerlink" title="SCRIPT KILL"></a>SCRIPT KILL</h4><p>å¦‚æœæœåŠ¡å™¨è®¾ç½®äº†lua-time-limité…ç½®é€‰é¡¹ï¼Œé‚£ä¹ˆåœ¨æ¯æ¬¡æ‰§è¡ŒLuaè„šæœ¬ä¹‹å‰ï¼ŒæœåŠ¡å™¨éƒ½ä¼šåœ¨Luaç¯å¢ƒé‡Œé¢è®¾ç½®ä¸€ä¸ªè¶…æ—¶å¤„ç†é’©å­ï¼ˆhookï¼‰ã€‚</p>
<p>è¶…æ—¶å¤„ç†é’©å­åœ¨è„šæœ¬è¿è¡ŒæœŸé—´ï¼Œä¼šå®šæœŸæ£€æŸ¥è„šæœ¬å·²ç»è¿è¡Œäº†å¤šé•¿æ—¶é—´ï¼Œä¸€æ—¦é’©å­å‘ç°è„šæœ¬çš„è¿è¡Œæ—¶é—´å·²ç»è¶…è¿‡äº†lua-time-limité€‰é¡¹è®¾ç½®çš„æ—¶é•¿ï¼Œé’©å­å°†å®šæœŸåœ¨è„šæœ¬è¿è¡Œçš„é—´éš™ä¸­ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰SCRIPT KILLå‘½ä»¤æˆ–è€…SHUTDOWNå‘½ä»¤åˆ°è¾¾æœåŠ¡å™¨ã€‚</p>
<p>å¦‚æœè¶…æ—¶è¿è¡Œçš„è„šæœ¬æœªæ‰§è¡Œè¿‡ä»»ä½•å†™å…¥æ“ä½œï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯å¯ä»¥é€šè¿‡SCRIPTKILLå‘½ä»¤æ¥æŒ‡ç¤ºæœåŠ¡å™¨åœæ­¢æ‰§è¡Œè¿™ä¸ªè„šæœ¬ï¼Œå¹¶å‘æ‰§è¡Œè¯¥è„šæœ¬çš„å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªé”™è¯¯å›å¤ã€‚å¤„ç†å®ŒSCRIPT KILLå‘½ä»¤ä¹‹åï¼ŒæœåŠ¡å™¨å¯ä»¥ç»§ç»­è¿è¡Œã€‚</p>
<p>å¦ä¸€æ–¹é¢ï¼Œå¦‚æœè„šæœ¬å·²ç»æ‰§è¡Œè¿‡å†™å…¥æ“ä½œï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯åªèƒ½ç”¨SHUTDOWN nosaveå‘½ä»¤æ¥åœæ­¢æœåŠ¡å™¨ï¼Œä»è€Œé˜²æ­¢ä¸åˆæ³•çš„æ•°æ®è¢«å†™å…¥æ•°æ®åº“ä¸­ã€‚</p>
<h3 id="è„šæœ¬å¤åˆ¶"><a href="#è„šæœ¬å¤åˆ¶" class="headerlink" title="è„šæœ¬å¤åˆ¶"></a>è„šæœ¬å¤åˆ¶</h3><p>ä¸å…¶ä»–æ™®é€šRediså‘½ä»¤ä¸€æ ·ï¼Œå½“æœåŠ¡å™¨è¿è¡Œåœ¨å¤åˆ¶æ¨¡å¼ä¹‹ä¸‹æ—¶ï¼Œå…·æœ‰å†™æ€§è´¨çš„è„šæœ¬å‘½ä»¤ä¹Ÿä¼šè¢«å¤åˆ¶åˆ°ä»æœåŠ¡å™¨ï¼Œè¿™äº›å‘½ä»¤åŒ…æ‹¬EVALå‘½ä»¤ã€EVALSHAå‘½ä»¤ã€SCRIPT FLUSHå‘½ä»¤ï¼Œä»¥åŠSCRIPT LOADå‘½ä»¤ã€‚</p>
<h4 id="å¤åˆ¶EVALå‘½ä»¤ã€SCRIPT-FLUSHå‘½ä»¤å’ŒSCRIPT-LOADå‘½ä»¤"><a href="#å¤åˆ¶EVALå‘½ä»¤ã€SCRIPT-FLUSHå‘½ä»¤å’ŒSCRIPT-LOADå‘½ä»¤" class="headerlink" title="å¤åˆ¶EVALå‘½ä»¤ã€SCRIPT FLUSHå‘½ä»¤å’ŒSCRIPT LOADå‘½ä»¤"></a>å¤åˆ¶EVALå‘½ä»¤ã€SCRIPT FLUSHå‘½ä»¤å’ŒSCRIPT LOADå‘½ä»¤</h4><p>Rediså¤åˆ¶EVALã€SCRIPT FLUSHã€SCRIPT LOADä¸‰ä¸ªå‘½ä»¤çš„æ–¹æ³•å’Œå¤åˆ¶å…¶ä»–æ™®é€šRediså‘½ä»¤çš„æ–¹æ³•ä¸€æ ·ï¼Œå½“ä¸»æœåŠ¡å™¨æ‰§è¡Œå®Œä»¥ä¸Šä¸‰ä¸ªå‘½ä»¤çš„å…¶ä¸­ä¸€ä¸ªæ—¶ï¼Œä¸»æœåŠ¡å™¨ä¼šç›´æ¥å°†è¢«æ‰§è¡Œçš„å‘½ä»¤ä¼ æ’­ï¼ˆpropagateï¼‰ç»™æ‰€æœ‰ä»æœåŠ¡å™¨ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="/..%5Cimg%5CRedis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%5C%E5%B0%86%E8%84%9A%E6%9C%AC%E5%91%BD%E4%BB%A4%E4%BC%A0%E6%92%AD%E7%BB%99%E4%BB%8E%E6%9C%8D%E5%8A%A1%E5%99%A8.png" alt="å°†è„šæœ¬å‘½ä»¤ä¼ æ’­ç»™ä»æœåŠ¡å™¨"></p>
<h5 id="EVAL"><a href="#EVAL" class="headerlink" title="EVAL"></a>EVAL</h5><p>å¯¹äºEVALå‘½ä»¤æ¥è¯´ï¼Œåœ¨ä¸»æœåŠ¡å™¨æ‰§è¡Œçš„Luaè„šæœ¬åŒæ ·ä¼šåœ¨æ‰€æœ‰ä»æœåŠ¡å™¨ä¸­æ‰§è¡Œã€‚</p>
<p>ä¸»æœåŠ¡å™¨åœ¨æ‰§è¡Œè¿™ä¸ªEVALå‘½ä»¤ä¹‹åï¼Œå°†å‘æ‰€æœ‰ä»æœåŠ¡å™¨ä¼ æ’­è¿™æ¡EVALå‘½ä»¤ï¼Œä»æœåŠ¡å™¨ä¼šæ¥æ”¶å¹¶æ‰§è¡Œè¿™æ¡EVALå‘½ä»¤ï¼Œæœ€ç»ˆç»“æœæ˜¯ï¼Œä¸»ä»æœåŠ¡å™¨åŒæ–¹éƒ½ä¼šæ‰§è¡Œè¯¥è„šæœ¬å¹¶å°†è„šæœ¬ä¿å­˜åœ¨è„šæœ¬å­—å…¸é‡Œé¢ã€‚</p>
<h5 id="SCRIPT-FLUSH-1"><a href="#SCRIPT-FLUSH-1" class="headerlink" title="SCRIPT FLUSH"></a>SCRIPT FLUSH</h5><p>å¦‚æœå®¢æˆ·ç«¯å‘ä¸»æœåŠ¡å™¨å‘é€SCRIPT FLUSHå‘½ä»¤ï¼Œé‚£ä¹ˆä¸»æœåŠ¡å™¨ä¹Ÿä¼šå‘æ‰€æœ‰ä»æœåŠ¡å™¨ä¼ æ’­SCRIPT FLUSHå‘½ä»¤ã€‚<br>æœ€ç»ˆçš„ç»“æœæ˜¯ï¼Œä¸»ä»æœåŠ¡å™¨åŒæ–¹éƒ½ä¼šé‡ç½®è‡ªå·±çš„Luaç¯å¢ƒï¼Œå¹¶æ¸…ç©ºè‡ªå·±çš„è„šæœ¬å­—å…¸ã€‚</p>
<h5 id="SCRIPT-LOAD-1"><a href="#SCRIPT-LOAD-1" class="headerlink" title="SCRIPT LOAD"></a>SCRIPT LOAD</h5><p>å¦‚æœå®¢æˆ·ç«¯ä½¿ç”¨SCRIPT LOADå‘½ä»¤ï¼Œå‘ä¸»æœåŠ¡å™¨è½½äººä¸€ä¸ªLuaè„šæœ¬ï¼Œé‚£ä¹ˆä¸»æœåŠ¡å™¨å°†å‘æ‰€æœ‰ä»æœåŠ¡å™¨ä¼ æ’­ç›¸åŒçš„SCRIPTLOADå‘½ä»¤ï¼Œä½¿å¾—æ‰€æœ‰ä»æœåŠ¡å™¨ä¹Ÿä¼šè½½äººç›¸åŒçš„Luaè„šæœ¬ã€‚</p>
<p>æœ€ç»ˆçš„ç»“æœæ˜¯ï¼Œä¸»ä»æœåŠ¡å™¨åŒæ–¹éƒ½ä¼šè½½å…¥è„šæœ¬ã€‚</p>
<h4 id="å¤åˆ¶EVALSHAå‘½ä»¤"><a href="#å¤åˆ¶EVALSHAå‘½ä»¤" class="headerlink" title="å¤åˆ¶EVALSHAå‘½ä»¤"></a>å¤åˆ¶EVALSHAå‘½ä»¤</h4><p>EVALSHAå‘½ä»¤æ˜¯æ‰€æœ‰ä¸Luaè„šæœ¬æœ‰å…³çš„å‘½ä»¤ä¸­ï¼Œå¤åˆ¶æ“ä½œæœ€å¤æ‚çš„ä¸€ä¸ªï¼Œå› ä¸ºä¸»æœåŠ¡å™¨ä¸ä»æœåŠ¡å™¨è½½å…¥Luaè„šæœ¬çš„æƒ…å†µå¯èƒ½æœ‰æ‰€ä¸åŒï¼Œæ‰€ä»¥ä¸»æœåŠ¡å™¨ä¸èƒ½åƒå¤åˆ¶EVALå‘½ä»¤ã€SCRIPT LOADå‘½ä»¤æˆ–è€…SCRIPT FLUSHå‘½ä»¤é‚£æ ·ï¼Œç›´æ¥å°†EVALSHAå‘½ä»¤ä¼ æ’­ç»™ä»æœåŠ¡å™¨ã€‚å¯¹äºä¸€ä¸ªåœ¨ä¸»æœåŠ¡å™¨è¢«æˆåŠŸæ‰§è¡Œçš„EVALSHAå‘½ä»¤æ¥è¯´ï¼Œç›¸åŒçš„EVALSHAå‘½ä»¤åœ¨ä»æœåŠ¡å™¨æ‰§è¡Œæ—¶å´å¯èƒ½ä¼šå‡ºç°è„šæœ¬æœªæ‰¾åˆ°ï¼ˆnot foundï¼‰é”™è¯¯ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾ç°åœ¨æœ‰ä¸€ä¸ªä¸»æœåŠ¡å™¨masterï¼Œå¦‚æœå®¢æˆ·ç«¯å‘ä¸»æœåŠ¡å™¨å‘é€å‘½ä»¤ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">master&gt; SCRIPT LOAD &quot;return &#x27;hello world&#x27;&quot;</span><br><span class="line">&quot;5332031c6b470dc5a0dd9b4bf2030dea6d65de91&quot;</span><br></pre></td></tr></table></figure>


<p>é‚£ä¹ˆåœ¨æ‰§è¡Œè¿™ä¸ªSCRIPT LOADå‘½ä»¤ä¹‹åï¼ŒSHA1å€¼ä¸º5332031c6b470dc5a0dd9b4bf2030dea6d65de91çš„è„šæœ¬å°±å­˜åœ¨äºä¸»æœåŠ¡å™¨ä¸­äº†ã€‚</p>
<p>ç°åœ¨ï¼Œå‡è®¾ä¸€ä¸ªä»æœåŠ¡å™¨slave1å¼€å§‹å¤åˆ¶ä¸»æœåŠ¡å™¨masterï¼Œå¦‚æœmasterä¸æƒ³åŠæ³•å°†è„šæœ¬ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;return &#x27;hello world&#x27;&quot;</span><br></pre></td></tr></table></figure>


<p>ä¼ é€ç»™slave1è½½å…¥çš„è¯ï¼Œé‚£ä¹ˆå½“å®¢æˆ·ç«¯å‘ä¸»æœåŠ¡å™¨å‘é€å‘½ä»¤ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">master&gt; EVALSHA &quot;5332031c6b470dc5a0dd9b4bf2030dea6d65de91&quot; 0</span><br><span class="line">&quot;hello world&quot;</span><br></pre></td></tr></table></figure>


<p>çš„æ—¶å€™ï¼Œmasterå°†æˆåŠŸæ‰§è¡Œè¿™ä¸ªEVALSHAå‘½ä»¤ï¼Œè€Œå½“masterå°†è¿™ä¸ªå‘½ä»¤ä¼ æ’­ç»™slave1æ‰§è¡Œçš„æ—¶å€™ï¼Œslave1å´ä¼šå‡ºç°è„šæœ¬æœªæ‰¾åˆ°é”™è¯¯ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">slave1&gt; EVALSHA &quot;5332031c6b470dc5a0dd9b4bf2030dea6d65de91&quot; 0</span><br><span class="line">(error) NOSCRIPT No matching script. Please use EVAL.</span><br></pre></td></tr></table></figure>


<p>æ›´ä¸ºå¤æ‚çš„æ˜¯ï¼Œå› ä¸ºå¤šä¸ªä»æœåŠ¡å™¨ä¹‹é—´è½½å…¥Luaè„šæœ¬çš„æƒ…å†µä¹Ÿå¯èƒ½å„æœ‰ä¸åŒï¼Œæ‰€ä»¥å³ä½¿ä¸€ä¸ª EVALSHAå‘½ä»¤å¯ä»¥åœ¨æŸä¸ªä»æœåŠ¡å™¨æˆåŠŸæ‰§è¡Œï¼Œä¹Ÿä¸ä»£è¡¨è¿™ä¸ªEVALSHAå‘½ä»¤å°±ä¸€å®šå¯ä»¥åœ¨å¦ä¸€ä¸ªä»æœåŠ¡å™¨æˆåŠŸæ‰§è¡Œã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾æœ‰ä¸»æœåŠ¡å™¨masterå’Œä»æœåŠ¡å™¨slave1ï¼Œå¹¶ä¸”slave1ä¸€ç›´å¤åˆ¶ç€masterï¼Œæ‰€ä»¥masterè½½å…¥çš„æ‰€æœ‰Luaè„šæœ¬ï¼Œslave1ä¹Ÿæœ‰è½½å…¥ï¼ˆé€šè¿‡ä¼ æ’­EVALå‘½ä»¤æˆ–è€…SCRIPT LOADå‘½ä»¤æ¥å®ç°)ã€‚</p>
<p>ä¾‹å¦‚è¯´ï¼Œå¦‚æœå®¢æˆ·ç«¯å‘masterå‘é€å‘½ä»¤ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">master&gt; SCRIPT LOAD &quot;return &#x27;hello world&#x27;&quot;</span><br><span class="line">&quot;5332031c6b470dc5a0dd9b4bf2030dea6d65de91&quot;</span><br></pre></td></tr></table></figure>


<p>é‚£ä¹ˆè¿™ä¸ªå‘½ä»¤ä¹Ÿä¼šè¢«ä¼ æ’­åˆ°slave1ä¸Šé¢ï¼Œæ‰€ä»¥masterå’Œslave1éƒ½ä¼šæˆåŠŸè½½äººSHA1æ ¡éªŒå’Œä¸º5332031c6b470dc5a0dd9b4bf2030dea6d65de91çš„Luaè„šæœ¬ã€‚</p>
<p>å¦‚æœè¿™æ—¶ï¼Œä¸€ä¸ªæ–°çš„ä»æœåŠ¡å™¨slave2å¼€å§‹å¤åˆ¶ä¸»æœåŠ¡å™¨masterï¼Œå¦‚æœmasterä¸æƒ³åŠæ³•å°†è„šæœ¬ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;return &#x27;hello world&#x27;&quot;</span><br></pre></td></tr></table></figure>


<p>ä¼ é€ç»™slave2çš„è¯ï¼Œé‚£ä¹ˆå½“å®¢æˆ·ç«¯å‘ä¸»æœåŠ¡å™¨å‘é€å‘½ä»¤ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">master&gt; EVALSHA &quot;5332031c6b470dc5a0dd9b4bf2030dea6d65de91&quot; 0</span><br><span class="line">&quot;hello world&quot;</span><br></pre></td></tr></table></figure>


<p>çš„æ—¶å€™ï¼Œmasterå’Œslave1éƒ½å°†æˆåŠŸæ‰§è¡Œè¿™ä¸ªEVALSHAå‘½ä»¤ï¼Œè€Œslave2å´ä¼šå‘ç”Ÿè„šæœ¬æœªæ‰¾åˆ°é”™è¯¯ã€‚</p>
<p>ä¸ºäº†é˜²æ­¢ä»¥ä¸Šå‡è®¾çš„æƒ…å†µå‡ºç°ï¼ŒRedisè¦æ±‚ä¸»æœåŠ¡å™¨åœ¨ä¼ æ’­EVALSHAå‘½ä»¤çš„æ—¶å€™ï¼Œå¿…é¡»ç¡®ä¿EVALSHAå‘½ä»¤è¦æ‰§è¡Œçš„è„šæœ¬å·²ç»è¢«æ‰€æœ‰ä»æœåŠ¡å™¨è½½å…¥è¿‡ï¼Œå¦‚æœä¸èƒ½ç¡®ä¿è¿™ä¸€ç‚¹çš„è¯ï¼Œä¸»æœåŠ¡å™¨ä¼šå°†EVALSHAå‘½ä»¤è½¬æ¢æˆä¸€ä¸ªç­‰ä»·çš„EVALå‘½ä»¤ï¼Œç„¶åé€šè¿‡ä¼ æ’­EVALå‘½ä»¤æ¥ä»£æ›¿EVALSHAå‘½ä»¤ã€‚</p>
<p>ä¼ æ’­EVALSHAå‘½ä»¤ï¼Œæˆ–è€…å°†EVALSHAå‘½ä»¤è½¬æ¢æˆEVALå‘½ä»¤ï¼Œéƒ½éœ€è¦ç”¨åˆ°æœåŠ¡å™¨çŠ¶æ€çš„lua_scriptså­—å…¸å’Œrepl_scriptcache_dictå­—å…¸ã€‚</p>
<h5 id="åˆ¤æ–­ä¼ æ’­EVALSHAå‘½ä»¤æ˜¯å¦å®‰å…¨çš„æ–¹æ³•"><a href="#åˆ¤æ–­ä¼ æ’­EVALSHAå‘½ä»¤æ˜¯å¦å®‰å…¨çš„æ–¹æ³•" class="headerlink" title="åˆ¤æ–­ä¼ æ’­EVALSHAå‘½ä»¤æ˜¯å¦å®‰å…¨çš„æ–¹æ³•"></a>åˆ¤æ–­ä¼ æ’­EVALSHAå‘½ä»¤æ˜¯å¦å®‰å…¨çš„æ–¹æ³•</h5><p>ä¸»æœåŠ¡å™¨ä½¿ç”¨æœåŠ¡å™¨çŠ¶æ€çš„repl_scriptcache_dictå­—å…¸è®°å½•è‡ªå·±å·²ç»å°†å“ªäº›è„šæœ¬ä¼ æ’­ç»™äº†æ‰€æœ‰ä»æœåŠ¡å™¨ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisServer</span> &#123;</span></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	dict *repl_scriptcache_dict;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


<p>repl_scriptcache_dictå­—å…¸çš„é”®æ˜¯ä¸€ä¸ªä¸ªLuaè„šæœ¬çš„SHA1æ ¡éªŒå’Œï¼Œè€Œå­—å…¸çš„å€¼åˆ™å…¨éƒ¨éƒ½æ˜¯NULLï¼Œå½“ä¸€ä¸ªæ ¡éªŒå’Œå‡ºç°åœ¨repl_scriptcache_dictå­—å…¸æ—¶ï¼Œè¯´æ˜è¿™ä¸ªæ ¡éªŒå’Œå¯¹åº”çš„Luaè„šæœ¬å·²ç»ä¼ æ’­ç»™äº†æ‰€æœ‰ä»æœåŠ¡å™¨ï¼Œä¸»æœåŠ¡å™¨å¯ä»¥ç›´æ¥å‘ä»æœåŠ¡å™¨ä¼ æ’­åŒ…å«è¿™ä¸ªSHA1æ ¡éªŒå’Œçš„EVALSHAå‘½ä»¤ï¼Œè€Œä¸å¿…æ‹…å¿ƒä»æœåŠ¡å™¨ä¼šå‡ºç°è„šæœ¬æœªæ‰¾åˆ°é”™è¯¯ã€‚</p>
<p>å¦ä¸€æ–¹é¢ï¼Œå¦‚æœä¸€ä¸ªè„šæœ¬çš„SHA1æ ¡éªŒå’Œå­˜åœ¨äºlua_scriptså­—å…¸ï¼Œä½†æ˜¯å´ä¸å­˜åœ¨äºrepl_scriptcache_dictå­—å…¸ï¼Œé‚£ä¹ˆè¯´æ˜æ ¡éªŒå’Œå¯¹åº”çš„Luaè„šæœ¬å·²ç»è¢«ä¸»æœåŠ¡å™¨è½½äººï¼Œä½†æ˜¯å¹¶æ²¡æœ‰ä¼ æ’­ç»™æ‰€æœ‰ä»æœåŠ¡å™¨ï¼Œå¦‚æœæˆ‘ä»¬å°è¯•å‘ä»æœåŠ¡å™¨ä¼ æ’­åŒ…å«è¿™ä¸ªSHA1æ ¡éªŒå’Œçš„EVALSHAå‘½ä»¤ï¼Œé‚£ä¹ˆè‡³å°‘æœ‰ä¸€ä¸ªä»æœåŠ¡å™¨ä¼šå‡ºç°è„šæœ¬æœªæ‰¾åˆ°é”™è¯¯ã€‚</p>
<h5 id="æ¸…ç©ºrepl-scriptcache-dictå­—å…¸"><a href="#æ¸…ç©ºrepl-scriptcache-dictå­—å…¸" class="headerlink" title="æ¸…ç©ºrepl_scriptcache_dictå­—å…¸"></a>æ¸…ç©ºrepl_scriptcache_dictå­—å…¸</h5><p>æ¯å½“ä¸»æœåŠ¡å™¨æ·»åŠ ä¸€ä¸ªæ–°çš„ä»æœåŠ¡å™¨æ—¶ï¼Œä¸»æœåŠ¡å™¨éƒ½ä¼šæ¸…ç©ºè‡ªå·±çš„repl_scriptcache_dictå­—å…¸ï¼Œè¿™æ˜¯å› ä¸ºéšç€æ–°ä»æœåŠ¡å™¨çš„å‡ºç°ï¼Œrepl_scriptcache_dictå­—å…¸é‡Œé¢è®°å½•çš„è„šæœ¬å·²ç»ä¸å†è¢«æ‰€æœ‰ä»æœåŠ¡å™¨è½½å…¥è¿‡ï¼Œæ‰€ä»¥ä¸»æœåŠ¡å™¨ä¼šæ¸…ç©ºrepl_scriptcache_dictå­—å…¸ï¼Œå¼ºåˆ¶è‡ªå·±é‡æ–°å‘æ‰€æœ‰ä»æœåŠ¡å™¨ä¼ æ’­è„šæœ¬ï¼Œä»è€Œç¡®ä¿æ–°çš„ä»æœåŠ¡å™¨ä¸ä¼šå‡ºç°è„šæœ¬æœªæ‰¾åˆ°é”™è¯¯ã€‚</p>
<h5 id="EVALSHAå‘½ä»¤è½¬æ¢æˆEVALå‘½ä»¤çš„æ–¹æ³•"><a href="#EVALSHAå‘½ä»¤è½¬æ¢æˆEVALå‘½ä»¤çš„æ–¹æ³•" class="headerlink" title="EVALSHAå‘½ä»¤è½¬æ¢æˆEVALå‘½ä»¤çš„æ–¹æ³•"></a>EVALSHAå‘½ä»¤è½¬æ¢æˆEVALå‘½ä»¤çš„æ–¹æ³•</h5><p>é€šè¿‡ä½¿ç”¨EVALSHAå‘½ä»¤æŒ‡å®šçš„SHA1æ ¡éªŒå’Œï¼Œä»¥åŠlua_scriptså­—å…¸ä¿å­˜çš„Luaè„šæœ¬ï¼ŒæœåŠ¡å™¨æ€»å¯ä»¥å°†ä¸€ä¸ªEVALSHAå‘½ä»¤ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EVALSHA &lt;sha1&gt; &lt;numkeys&gt; [key...] [arg...]</span><br></pre></td></tr></table></figure>


<p>è½¬æ¢æˆä¸€ä¸ªç­‰ä»·çš„EVALå‘½ä»¤ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EVAL &lt;script&gt; &lt;numkeys&gt; [key...] [arg...]</span><br></pre></td></tr></table></figure>

<p>å…·ä½“çš„è½¬æ¢æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<ol>
<li>æ ¹æ®SHA1æ ¡éªŒå’Œsha1ï¼Œåœ¨lua_scriptså­—å…¸ä¸­æŸ¥æ‰¾sha1å¯¹åº”çš„Luaè„šæœ¬scriptã€‚</li>
<li>å°†åŸæ¥çš„EVALSHAå‘½ä»¤è¯·æ±‚æ”¹å†™æˆEVALå‘½ä»¤è¯·æ±‚ï¼Œå¹¶ä¸”å°†æ ¡éªŒå’Œsha1æ”¹æˆè„šæœ¬scriptï¼Œè‡³äºnumkeysã€keyã€argç­‰å‚æ•°åˆ™ä¿æŒä¸å˜ã€‚</li>
</ol>
<p>å¦‚æœä¸€ä¸ªSHA1å€¼æ‰€å¯¹åº”çš„Luaè„šæœ¬æ²¡æœ‰è¢«æ‰€æœ‰ä»æœåŠ¡å™¨è½½å…¥è¿‡ï¼Œé‚£ä¹ˆä¸»æœåŠ¡å™¨å¯ä»¥å°†EVALSHAå‘½ä»¤è½¬æ¢æˆç­‰ä»·çš„EVALå‘½ä»¤ï¼Œç„¶åé€šè¿‡ä¼ æ’­ç­‰ä»·çš„EVALå‘½ä»¤æ¥ä»£æ›¿åŸæœ¬æƒ³è¦ä¼ æ’­çš„EVALSHAå‘½ä»¤ï¼Œä»¥æ­¤æ¥äº§ç”Ÿç›¸åŒçš„è„šæœ¬æ‰§è¡Œæ•ˆæœï¼Œå¹¶ç¡®ä¿æ‰€æœ‰ä»æœåŠ¡å™¨éƒ½ä¸ä¼šå‡ºç°è„šæœ¬æœªæ‰¾åˆ°é”™è¯¯ã€‚</p>
<p>å¦å¤–ï¼Œå› ä¸ºä¸»æœåŠ¡å™¨åœ¨ä¼ æ’­å®ŒEVALå‘½ä»¤ä¹‹åï¼Œä¼šå°†è¢«ä¼ æ’­è„šæœ¬çš„SHA1æ ¡éªŒå’Œï¼ˆä¹Ÿå³æ˜¯åŸæœ¬EVALSHAå‘½ä»¤æŒ‡å®šçš„é‚£ä¸ªæ ¡éªŒå’Œï¼‰æ·»åŠ åˆ°repl_scriptcache_dictå­—å…¸é‡Œé¢ï¼Œå¦‚æœä¹‹åEVALSHAå‘½ä»¤å†æ¬¡æŒ‡å®šè¿™ä¸ªSHA1æ ¡éªŒå’Œï¼Œä¸»æœåŠ¡å™¨å°±å¯ä»¥ç›´æ¥ä¼ æ’­EVALSHAå‘½ä»¤ï¼Œè€Œä¸å¿…å†æ¬¡å¯¹EVALSHAå‘½ä»¤è¿›è¡Œè½¬æ¢ã€‚</p>
<h5 id="ä¼ æ’­EVALSHAå‘½ä»¤çš„æ–¹æ³•"><a href="#ä¼ æ’­EVALSHAå‘½ä»¤çš„æ–¹æ³•" class="headerlink" title="ä¼ æ’­EVALSHAå‘½ä»¤çš„æ–¹æ³•"></a>ä¼ æ’­EVALSHAå‘½ä»¤çš„æ–¹æ³•</h5><p>å½“ä¸»æœåŠ¡å™¨æˆåŠŸåœ¨æœ¬æœºæ‰§è¡Œå®Œä¸€ä¸ªEVALSHAå‘½ä»¤ä¹‹åï¼Œå®ƒå°†æ ¹æ®EVALSHAå‘½ä»¤æŒ‡å®šçš„SHA1æ ¡éªŒå’Œæ˜¯å¦å­˜åœ¨äºrepl_scriptcache_dictå­—å…¸æ¥å†³å®šæ˜¯å‘ä»æœåŠ¡å™¨ä¼ æ’­EVALSHAå‘½ä»¤è¿˜æ˜¯EVALå‘½ä»¤ï¼š</p>
<ol>
<li>å¦‚æœEVALSHAå‘½ä»¤æŒ‡å®šçš„SHA1æ ¡éªŒå’Œå­˜åœ¨äºrepl_scriptcache_dictå­—å…¸ï¼Œé‚£ä¹ˆä¸»æœåŠ¡å™¨ç›´æ¥å‘ä»æœåŠ¡å™¨ä¼ æ’­EVALSHAå‘½ä»¤ã€‚</li>
<li>å¦‚æœEVALSHAå‘½ä»¤æŒ‡å®šçš„SHA1æ ¡éªŒå’Œä¸å­˜åœ¨äºrepl_scriptcache_dictå­—å…¸ï¼Œé‚£ä¹ˆä¸»æœåŠ¡å™¨ä¼šå°†EVALSHAå‘½ä»¤è½¬æ¢æˆç­‰ä»·çš„EVALå‘½ä»¤ï¼Œç„¶åä¼ æ’­è¿™ä¸ªç­‰ä»·çš„EVALå‘½ä»¤ï¼Œå¹¶å°†EVALSHAå‘½ä»¤æŒ‡å®šçš„SHA1æ ¡éªŒå’Œæ·»åŠ åˆ°repl_scriptcache_dictå­—å…¸é‡Œé¢ã€‚</li>
</ol>
<p><img src="/..%5Cimg%5CRedis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%5C%E4%B8%BB%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%88%A4%E6%96%AD%E4%BC%A0%E6%92%ADEVAL%E8%BF%98%E6%98%AFEVALSHA%E7%9A%84%E8%BF%87%E7%A8%8B.png" alt="ä¸»æœåŠ¡å™¨åˆ¤æ–­ä¼ æ’­EVALè¿˜æ˜¯EVALSHAçš„è¿‡ç¨‹"></p>
<h2 id="æ’åº"><a href="#æ’åº" class="headerlink" title="æ’åº"></a>æ’åº</h2><p>Redisçš„SORTå‘½ä»¤å¯ä»¥å¯¹åˆ—è¡¨é”®ã€é›†åˆé”®æˆ–è€…æœ‰åºé›†åˆé”®çš„å€¼è¿›è¡Œæ’åºã€‚</p>
<h3 id="SORT-lt-key-gt-å‘½ä»¤çš„å®ç°"><a href="#SORT-lt-key-gt-å‘½ä»¤çš„å®ç°" class="headerlink" title="SORT &lt;key&gt;å‘½ä»¤çš„å®ç°"></a>SORT &lt;key&gt;å‘½ä»¤çš„å®ç°</h3><p>SORTå‘½ä»¤çš„æœ€ç®€å•æ‰§è¡Œå½¢å¼ä¸ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SORT &lt;key&gt;</span><br></pre></td></tr></table></figure>


<p>è¿™ä¸ªå‘½ä»¤å¯ä»¥å¯¹ä¸€ä¸ªåŒ…å«æ•°å­—å€¼çš„é”®keyè¿›è¡Œæ’åºã€‚</p>
<p>ä»¥ä¸‹ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨SORTå‘½ä»¤å¯¹ä¸€ä¸ªåŒ…å«ä¸‰ä¸ªæ•°å­—å€¼çš„åˆ—è¡¨é”®è¿›è¡Œæ’åºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">redis&gt; RPUSH numbers 3 1 2</span><br><span class="line">(integer) 3</span><br><span class="line"></span><br><span class="line">redis&gt; SORT numbers</span><br><span class="line">1) &quot;1&quot;</span><br><span class="line">2) &quot;2&quot;</span><br><span class="line">3) &quot;3&quot;</span><br></pre></td></tr></table></figure>

<p>æœåŠ¡å™¨æ‰§è¡ŒSORT numberså‘½ä»¤çš„è¯¦ç»†æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li>åˆ›å»ºä¸€ä¸ªå’Œnumbersåˆ—è¡¨é•¿åº¦ç›¸åŒçš„æ•°ç»„ï¼Œè¯¥æ•°ç»„çš„æ¯ä¸ªé¡¹éƒ½æ˜¯ä¸€ä¸ªredis.h&#x2F;redissortObjectç»“æ„ï¼Œå¦‚å›¾21-1æ‰€ç¤ºã€‚</li>
<li>éå†æ•°ç»„ï¼Œå°†å„ä¸ªæ•°ç»„é¡¹çš„objæŒ‡é’ˆåˆ†åˆ«æŒ‡å‘numbersåˆ—è¡¨çš„å„ä¸ªé¡¹ï¼Œæ„æˆobjæŒ‡é’ˆå’Œåˆ—è¡¨é¡¹ä¹‹é—´çš„ä¸€å¯¹ä¸€å…³ç³»ï¼Œå¦‚å›¾21-2æ‰€ç¤ºã€‚</li>
<li>éå†æ•°ç»„ï¼Œå°†å„ä¸ªobjæŒ‡é’ˆæ‰€æŒ‡å‘çš„åˆ—è¡¨é¡¹è½¬æ¢æˆä¸€ä¸ªdoubleç±»å‹çš„æµ®ç‚¹æ•°ï¼Œå¹¶å°†è¿™ä¸ªæµ®ç‚¹æ•°ä¿å­˜åœ¨ç›¸åº”æ•°ç»„é¡¹çš„u.scoreå±æ€§é‡Œé¢ï¼Œå¦‚å›¾21-3æ‰€ç¤ºã€‚</li>
<li>æ ¹æ®æ•°ç»„é¡¹u.scoreå±æ€§çš„å€¼ï¼Œå¯¹æ•°ç»„è¿›è¡Œæ•°å­—å€¼æ’åºï¼Œæ’åºåçš„æ•°ç»„é¡¹æŒ‰u.scoreå±æ€§çš„å€¼ä»å°åˆ°å¤§æ’åˆ—ï¼Œå¦‚å›¾21-4æ‰€ç¤ºã€‚</li>
<li>éå†æ•°ç»„ï¼Œå°†å„ä¸ªæ•°ç»„é¡¹çš„objæŒ‡é’ˆæ‰€æŒ‡å‘çš„åˆ—è¡¨é¡¹ä½œä¸ºæ’åºç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œç¨‹åºé¦–å…ˆè®¿é—®æ•°ç»„çš„ç´¢å¼•0ï¼Œè¿”å›u.scoreå€¼ä¸º1.0çš„åˆ—è¡¨é¡¹â€1â€ï¼›ç„¶åè®¿é—®æ•°ç»„çš„ç´¢å¼•1ï¼Œè¿”å›u.scoreå€¼ä¸º2.0çš„åˆ—è¡¨é¡¹â€2â€ï¼›æœ€åè®¿é—®æ•°ç»„çš„ç´¢å¼•2ï¼Œè¿”å›u.scoreå€¼ä¸º3.0çš„åˆ—è¡¨é¡¹â€3â€ã€‚</li>
</ol>
<p>å…¶ä»–sORT <key>å‘½ä»¤çš„æ‰§è¡Œæ­¥éª¤ä¹Ÿå’Œè¿™é‡Œç»™å‡ºçš„SORT numberså‘½ä»¤çš„æ‰§è¡Œæ­¥éª¤ç±»ä¼¼ã€‚</p>
<p><img src="/..%5Cimg%5CRedis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%5CredisSortObject%E6%95%B0%E7%BB%84.png" alt="redisSortObjectæ•°ç»„.png"></p>
<p><img src="/..%5Cimg%5CRedis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%5C%E5%B0%86obj%E6%8C%87%E9%92%88%E6%8C%87%E5%90%91%E5%88%97%E8%A1%A8%E7%9A%84%E5%90%84%E4%B8%AA%E9%A1%B9.png" alt="å°†objæŒ‡é’ˆæŒ‡å‘åˆ—è¡¨çš„å„ä¸ªé¡¹.png"></p>
<p><img src="/..%5Cimg%5CRedis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%5C%E8%AE%BE%E7%BD%AE%E6%95%B0%E7%BB%84%E9%A1%B9%E7%9A%84u.score%E5%B1%9E%E6%80%A7.png" alt="è®¾ç½®æ•°ç»„é¡¹çš„u.scoreå±æ€§"></p>
<p><img src="/..%5Cimg%5CRedis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%5C%E6%8E%92%E5%BA%8F%E5%90%8E%E7%9A%84%E6%95%B0%E7%BB%84.png" alt="æ’åºåçš„æ•°ç»„"></p>
<p>ä»¥ä¸‹æ˜¯redisSortObjectç»“æ„çš„å®Œæ•´å®šä¹‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">redisSortObject</span> &#123;</span></span><br><span class="line">	<span class="comment">//è¢«æ’åºé”®çš„å€¼</span></span><br><span class="line">	robj *obj;</span><br><span class="line">	<span class="comment">//æƒé‡</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="comment">//æ’åºæ•°å­—å€¼æ—¶ä½¿ç”¨</span></span><br><span class="line">        <span class="type">double</span> score;</span><br><span class="line">		<span class="comment">//æ’åºå¸¦æœ‰BYé€‰é¡¹çš„å­—ç¬¦ä¸²å€¼æ—¶ä½¿ç”¨</span></span><br><span class="line">        robj *cmpobj;</span><br><span class="line">	&#125; u;</span><br><span class="line">&#125; redisSortObject;</span><br></pre></td></tr></table></figure>


<p>SORTå‘½ä»¤ä¸ºæ¯ä¸ªè¢«æ’åºçš„é”®éƒ½åˆ›å»ºä¸€ä¸ªä¸é”®é•¿åº¦ç›¸åŒçš„æ•°ç»„ï¼Œæ•°ç»„çš„æ¯ä¸ªé¡¹éƒ½æ˜¯ä¸€ä¸ªredisSortObjectç»“æ„ï¼Œæ ¹æ®SORTå‘½ä»¤ä½¿ç”¨çš„é€‰é¡¹ä¸åŒï¼Œç¨‹åºä½¿ç”¨redisSortObjectç»“æ„çš„æ–¹å¼ä¹Ÿä¸åŒã€‚</p>
<h3 id="ALPHAé€‰é¡¹çš„å®ç°"><a href="#ALPHAé€‰é¡¹çš„å®ç°" class="headerlink" title="ALPHAé€‰é¡¹çš„å®ç°"></a>ALPHAé€‰é¡¹çš„å®ç°</h3><p>é€šè¿‡ä½¿ç”¨ALPHAé€‰é¡¹ï¼ŒSORTå‘½ä»¤å¯ä»¥å¯¹åŒ…å«å­—ç¬¦ä¸²å€¼çš„é”®è¿›è¡Œæ’åºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SORT &lt;key&gt; ALPHA</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸‹å‘½ä»¤å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨SORTå‘½ä»¤å¯¹ä¸€ä¸ªåŒ…å«ä¸‰ä¸ªå­—ç¬¦ä¸²å€¼çš„é›†åˆé”®è¿›è¡Œæ’åºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">redis&gt; SADD fruits apple banana cherry</span><br><span class="line">(integer) 3</span><br><span class="line"></span><br><span class="line">#å…ƒç´ åœ¨é›†åˆä¸­æ˜¯ä¹±åºå­˜æ”¾çš„</span><br><span class="line">redis&gt; SMEMBERS fruits</span><br><span class="line">1) &quot;apple&quot;</span><br><span class="line">2) &quot;cherry&quot;</span><br><span class="line">3) &quot;banana&quot;</span><br><span class="line"></span><br><span class="line">#å¯¹fruitsé”®è¿›è¡Œå­—ç¬¦ä¸²æ’åº</span><br><span class="line">redis&gt; SORT fruits ALPHA</span><br><span class="line">1) &quot;apple&quot;</span><br><span class="line">2) &quot;banana&quot;</span><br><span class="line">3) &quot;cherry&quot;</span><br></pre></td></tr></table></figure>

<p>æœåŠ¡å™¨æ‰§è¡ŒSORT fruits ALPHAå‘½ä»¤çš„è¯¦ç»†æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li>åˆ›å»ºä¸€ä¸ªredisSortObjectç»“æ„æ•°ç»„ï¼Œæ•°ç»„çš„é•¿åº¦ç­‰äºfruitsé›†åˆçš„å¤§å°ã€‚</li>
<li>éå†æ•°ç»„ï¼Œå°†å„ä¸ªæ•°ç»„é¡¹çš„objæŒ‡é’ˆåˆ†åˆ«æŒ‡å‘fruitsé›†åˆçš„å„ä¸ªå…ƒç´ ï¼Œå¦‚å›¾21-5æ‰€ç¤ºã€‚</li>
<li>æ ¹æ®objæŒ‡é’ˆæ‰€æŒ‡å‘çš„é›†åˆå…ƒç´ ï¼Œå¯¹æ•°ç»„è¿›è¡Œå­—ç¬¦ä¸²æ’åºï¼Œæ’åºåçš„æ•°ç»„é¡¹æŒ‰é›†åˆå…ƒç´ çš„å­—ç¬¦ä¸²å€¼ä»å°åˆ°å¤§æ’åˆ—ï¼šå› ä¸ºâ€appleâ€ã€â€bananaâ€ã€ â€œcherryâ€ä¸‰ä¸ªå­—ç¬¦ä¸²çš„å¤§å°é¡ºåºä¸ºâ€appleâ€&lt;â€bananaâ€&lt;â€cherryâ€ï¼Œæ‰€ä»¥æ’åºåæ•°ç»„çš„ç¬¬ä¸€é¡¹æŒ‡å‘â€appleâ€å…ƒç´ ï¼Œç¬¬äºŒé¡¹æŒ‡å‘â€bananaâ€å…ƒç´ ï¼Œç¬¬ä¸‰é¡¹æŒ‡å‘â€cherryâ€å…ƒç´ ï¼Œå¦‚å›¾21-6æ‰€ç¤ºã€‚</li>
<li>éå†æ•°ç»„ï¼Œä¾æ¬¡å°†æ•°ç»„é¡¹çš„objæŒ‡é’ˆæ‰€æŒ‡å‘çš„å…ƒç´ è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</li>
</ol>
<p>å…¶ä»–SORT &lt;key&gt; ALPHAå‘½ä»¤çš„æ‰§è¡Œæ­¥éª¤ä¹Ÿå’Œè¿™é‡Œç»™å‡ºçš„SORT fruits ALPHAå‘½ä»¤çš„æ‰§è¡Œæ­¥éª¤ç±»ä¼¼ã€‚</p>
<p>![sort alphaç¤ºä¾‹](..\img\Redisè®¾è®¡ä¸å®ç°\sort alphaç¤ºä¾‹.png)</p>
<h3 id="ASCé€‰é¡¹å’ŒDESCé€‰é¡¹"><a href="#ASCé€‰é¡¹å’ŒDESCé€‰é¡¹" class="headerlink" title="ASCé€‰é¡¹å’ŒDESCé€‰é¡¹"></a>ASCé€‰é¡¹å’ŒDESCé€‰é¡¹</h3><p>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒSORTå‘½ä»¤æ‰§è¡Œå‡åºæ’åºï¼Œæ’åºåçš„ç»“æœæŒ‰å€¼çš„å¤§å°ä»å°åˆ°å¤§æ’åˆ—ï¼Œä»¥ä¸‹ä¸¤ä¸ªå‘½ä»¤æ˜¯å®Œå…¨ç­‰ä»·çš„ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SORT &lt;key&gt;</span><br><span class="line">SORT &lt;key&gt; ASC</span><br></pre></td></tr></table></figure>


<p>ç›¸ååœ°ï¼Œåœ¨æ‰§è¡ŒSORTå‘½ä»¤æ—¶ä½¿ç”¨DESCé€‰é¡¹ï¼Œå¯ä»¥è®©å‘½ä»¤æ‰§è¡Œé™åºæ’åºï¼Œè®©æ’åºåçš„ç»“æœæŒ‰å€¼çš„å¤§å°ä»å¤§åˆ°å°æ’åˆ—ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SORT &lt;key&gt; DESC</span><br></pre></td></tr></table></figure>

<p>å‡åºæ’åºå’Œé™åºæ’åºéƒ½ç”±ç›¸åŒçš„å¿«é€Ÿæ’åºç®—æ³•æ‰§è¡Œï¼Œå®ƒä»¬ä¹‹é—´çš„ä¸åŒä¹‹å¤„åœ¨äºï¼š</p>
<ul>
<li>åœ¨æ‰§è¡Œå‡åºæ’åºæ—¶ï¼Œæ’åºç®—æ³•ä½¿ç”¨çš„å¯¹æ¯”å‡½æ•°äº§ç”Ÿå‡åºå¯¹æ¯”ç»“æœã€‚</li>
<li>è€Œåœ¨æ‰§è¡Œé™åºæ’åºæ—¶ï¼Œæ’åºç®—æ³•æ‰€ä½¿ç”¨çš„å¯¹æ¯”å‡½æ•°äº§ç”Ÿé™åºå¯¹æ¯”ç»“æœã€‚</li>
</ul>
<p>å› ä¸ºå‡åºå¯¹æ¯”å’Œé™åºå¯¹æ¯”çš„ç»“æœæ­£å¥½ç›¸åï¼Œæ‰€ä»¥å®ƒä»¬ä¼šäº§ç”Ÿå…ƒç´ æ’åˆ—æ–¹å¼æ­£å¥½ç›¸åçš„ä¸¤ç§æ’åºç»“æœã€‚</p>
<h3 id="BYé€‰é¡¹çš„å®ç°"><a href="#BYé€‰é¡¹çš„å®ç°" class="headerlink" title="BYé€‰é¡¹çš„å®ç°"></a>BYé€‰é¡¹çš„å®ç°</h3><p>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒSORTå‘½ä»¤ä½¿ç”¨è¢«æ’åºé”®åŒ…å«çš„å…ƒç´ ä½œä¸ºæ’åºçš„æƒé‡ï¼Œå…ƒç´ æœ¬èº«å†³å®šäº†å…ƒç´ åœ¨æ’åºä¹‹åæ‰€å¤„çš„ä½ç½®ã€‚</p>
<p>ä¾‹å¦‚ï¼Œåœ¨ä¸‹é¢è¿™ä¸ªä¾‹å­é‡Œé¢ï¼Œæ’åºfruitsé›†åˆæ‰€ä½¿ç”¨çš„æƒé‡å°±æ˜¯â€appleâ€ã€â€bananaâ€ã€â€cherryâ€ä¸‰ä¸ªå…ƒç´ æœ¬èº«ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">redis&gt; SADD fruits &quot;apple&quot; &quot;banana&quot; &quot;cherry&quot;</span><br><span class="line">(integer) 3</span><br><span class="line">redis&gt; SORT fruits ALPHA</span><br><span class="line">1) &quot;apple&quot;</span><br><span class="line">2) &quot;banana&quot;</span><br><span class="line">3) &quot;cherry&quot;</span><br></pre></td></tr></table></figure>


<p>å¦ä¸€æ–¹é¢ï¼Œé€šè¿‡ä½¿ç”¨BYé€‰é¡¹ï¼ŒSORTå‘½ä»¤å¯ä»¥æŒ‡å®šæŸäº›å­—ç¬¦ä¸²é”®æˆ–è€…æŸä¸ªå“ˆå¸Œé”®æ‰€åŒ…å«çš„æŸäº›åŸŸï¼ˆfieldï¼‰æ¥ä½œä¸ºå…ƒç´ çš„æƒé‡ï¼Œå¯¹ä¸€ä¸ªé”®è¿›è¡Œæ’åºã€‚</p>
<p>ä¾‹å¦‚ï¼Œä»¥ä¸‹è¿™ä¸ªä¾‹å­å°±ä½¿ç”¨è‹¹æœã€é¦™è•‰ã€æ¨±æ¡ƒä¸‰ç§æ°´æœçš„ä»·é’±ï¼Œå¯¹é›†åˆé”®fruitsè¿›è¡Œäº†æ’åºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">redis&gt; MSET apple-price 8 banana-price 5.5 cherry-price 7</span><br><span class="line">OK</span><br><span class="line">redis&gt; SORT fruits BY *-price</span><br><span class="line">1) &quot;banana&quot;</span><br><span class="line">2) &quot;cherryâ€</span><br><span class="line">3) &quot;apple&quot;</span><br></pre></td></tr></table></figure>

<p>æœåŠ¡å™¨æ‰§è¡ŒSORT fruits BY *-priceå‘½ä»¤çš„è¯¦ç»†æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li>åˆ›å»ºä¸€ä¸ªredisSortObjectç»“æ„æ•°ç»„ï¼Œæ•°ç»„çš„é•¿åº¦ç­‰äºfruitsé›†åˆçš„å¤§å°ã€‚</li>
<li>éå†æ•°ç»„ï¼Œå°†å„ä¸ªæ•°ç»„é¡¹çš„objæŒ‡é’ˆåˆ†åˆ«æŒ‡å‘fruitsé›†åˆçš„å„ä¸ªå…ƒç´ ï¼Œå¦‚å›¾21-9æ‰€ç¤ºã€‚</li>
<li>éå†æ•°ç»„ï¼Œæ ¹æ®å„ä¸ªæ•°ç»„é¡¹çš„objæŒ‡é’ˆæ‰€æŒ‡å‘çš„é›†åˆå…ƒç´ ï¼Œä»¥åŠBYé€‰é¡¹æ‰€ç»™å®šçš„æ¨¡å¼*-priceï¼ŒæŸ¥æ‰¾ç›¸åº”çš„æƒé‡é”®ï¼š<ul>
<li>å¯¹äºâ€appleâ€å…ƒç´ ï¼ŒæŸ¥æ‰¾ç¨‹åºè¿”å›æƒé‡é”®â€apple-priceâ€ã€‚</li>
<li>å¯¹äºâ€bananaâ€å…ƒç´ ï¼ŒæŸ¥æ‰¾ç¨‹åºè¿”å›æƒé‡é”®â€banana-priceâ€ã€‚</li>
<li>å¯¹äºâ€cherryâ€å…ƒç´ ï¼ŒæŸ¥æ‰¾ç¨‹åºè¿”å›æƒé‡é”®â€cherry-priceâ€ã€‚</li>
</ul>
</li>
<li>å°†å„ä¸ªæƒé‡é”®çš„å€¼è½¬æ¢æˆä¸€ä¸ªdoubleç±»å‹çš„æµ®ç‚¹æ•°ï¼Œç„¶åä¿å­˜åœ¨ç›¸åº”æ•°ç»„é¡¹çš„u.scoreå±æ€§é‡Œé¢ï¼Œå¦‚å›¾21-10æ‰€ç¤ºï¼š<ul>
<li>â€œappleâ€å…ƒç´ çš„æƒé‡é”®â€apple-priceâ€çš„å€¼è½¬æ¢ä¹‹åä¸º8.0ã€‚</li>
<li>â€œbananaâ€å…ƒç´ çš„æƒé‡é”®â€banana-priceâ€çš„å€¼è½¬æ¢ä¹‹åä¸º5.5ã€‚</li>
<li>â€œcherryâ€å…ƒç´ çš„æƒé‡é”®â€cherry-priceâ€çš„å€¼è½¬æ¢ä¹‹åä¸º7.0ã€‚</li>
</ul>
</li>
<li>ä»¥æ•°ç»„é¡¹u.scoreå±æ€§çš„å€¼ä¸ºæƒé‡ï¼Œå¯¹æ•°ç»„è¿›è¡Œæ’åºï¼Œå¾—åˆ°ä¸€ä¸ªæŒ‰u.scoreå±æ€§çš„å€¼ä»å°åˆ°å¤§æ’åºçš„æ•°ç»„,å¦‚å›¾21-11æ‰€ç¤ºï¼š<ul>
<li>æƒé‡ä¸º5.5çš„â€bananaâ€å…ƒç´ ä½äºæ•°ç»„çš„ç´¢å¼•0ä½ç½®ä¸Šã€‚</li>
<li>æƒé‡ä¸º7.0çš„â€cherryâ€å…ƒç´ ä½äºæ•°ç»„çš„ç´¢å¼•1ä½ç½®ä¸Šã€‚</li>
<li>æƒé‡ä¸º8.0çš„â€appleâ€å…ƒç´ ä½äºæ•°ç»„çš„ç´¢å¼•2ä½ç½®ä¸Šã€‚</li>
</ul>
</li>
<li>éå†æ•°ç»„ï¼Œä¾æ¬¡å°†æ•°ç»„é¡¹çš„objæŒ‡é’ˆæ‰€æŒ‡å‘çš„é›†åˆå…ƒç´ è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</li>
</ol>
<p>å…¶ä»–SORT &lt;key&gt; BY &lt;pattern&gt;å‘½ä»¤çš„æ‰§è¡Œæ­¥éª¤ä¹Ÿå’Œè¿™é‡Œç»™å‡ºçš„æ­¥éª¤ç±»ä¼¼ã€‚</p>
<p><img src="/..%5Cimg%5CRedis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%5CBY%E6%8E%92%E5%BA%8F%EF%BC%881%EF%BC%89.png" alt="BYæ’åºï¼ˆ1ï¼‰"></p>
<p><img src="/..%5Cimg%5CRedis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%5CBY%E6%8E%92%E5%BA%8F%EF%BC%882%EF%BC%89.png" alt="BYæ’åºï¼ˆ2ï¼‰"></p>
<p><img src="/..%5Cimg%5CRedis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%5CBY%E6%8E%92%E5%BA%8F%EF%BC%883%EF%BC%89.png" alt="BYæ’åºï¼ˆ3ï¼‰"></p>
<h3 id="å¸¦æœ‰ALPHAé€‰é¡¹çš„BYé€‰é¡¹çš„å®ç°"><a href="#å¸¦æœ‰ALPHAé€‰é¡¹çš„BYé€‰é¡¹çš„å®ç°" class="headerlink" title="å¸¦æœ‰ALPHAé€‰é¡¹çš„BYé€‰é¡¹çš„å®ç°"></a>å¸¦æœ‰ALPHAé€‰é¡¹çš„BYé€‰é¡¹çš„å®ç°</h3><p>BYé€‰é¡¹é»˜è®¤å‡è®¾æƒé‡é”®ä¿å­˜çš„å€¼ä¸ºæ•°å­—å€¼ï¼Œå¦‚æœæƒé‡é”®ä¿å­˜çš„æ˜¯å­—ç¬¦ä¸²å€¼çš„è¯ï¼Œé‚£ä¹ˆå°±éœ€è¦åœ¨ä½¿ç”¨BYé€‰é¡¹çš„åŒæ—¶ï¼Œé…åˆä½¿ç”¨ALPHAé€‰é¡¹ã€‚</p>
<p>æœåŠ¡å™¨æ‰§è¡ŒSORT fruits BY *-id ALPHAå‘½ä»¤çš„è¯¦ç»†æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li>åˆ›å»ºä¸€ä¸ªredisSortObjectç»“æ„æ•°ç»„ï¼Œæ•°ç»„çš„é•¿åº¦ç­‰äºfruitsé›†åˆçš„å¤§å°ã€‚</li>
<li>éå†æ•°ç»„ï¼Œå°†å„ä¸ªæ•°ç»„é¡¹çš„objæŒ‡é’ˆåˆ†åˆ«æŒ‡å‘fruitsé›†åˆçš„å„ä¸ªå…ƒç´ ã€‚</li>
<li>éå†æ•°ç»„ï¼Œæ ¹æ®å„ä¸ªæ•°ç»„é¡¹çš„objæŒ‡é’ˆæ‰€æŒ‡å‘çš„é›†åˆå…ƒç´ ï¼Œä»¥åŠBYé€‰é¡¹æ‰€ç»™å®šçš„æ¨¡å¼*-idï¼ŒæŸ¥æ‰¾ç›¸åº”çš„æƒé‡é”®ã€‚</li>
<li>å°†å„ä¸ªæ•°ç»„é¡¹çš„u.cmpobjæŒ‡é’ˆåˆ†åˆ«æŒ‡å‘ç›¸åº”çš„æƒé‡é”®ï¼ˆä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ï¼‰ã€‚</li>
<li>ä»¥å„ä¸ªæ•°ç»„é¡¹çš„æƒé‡é”®çš„å€¼ä¸ºæƒé‡ï¼Œå¯¹æ•°ç»„æ‰§è¡Œå­—ç¬¦ä¸²æ’åºã€‚</li>
<li>éå†æ•°ç»„ï¼Œä¾æ¬¡å°†æ•°ç»„é¡¹çš„objæŒ‡é’ˆæ‰€æŒ‡å‘çš„é›†åˆå…ƒç´ è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</li>
</ol>
<p>å…¶ä»–SORT &lt;key&gt; BY &lt;pattern&gt; ALPHAå‘½ä»¤çš„æ‰§è¡Œæ­¥éª¤ä¹Ÿå’Œè¿™é‡Œç»™å‡ºçš„æ­¥éª¤ç±»ä¼¼ã€‚</p>
<h3 id="LIMITé€‰é¡¹çš„å®ç°"><a href="#LIMITé€‰é¡¹çš„å®ç°" class="headerlink" title="LIMITé€‰é¡¹çš„å®ç°"></a>LIMITé€‰é¡¹çš„å®ç°</h3><p>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒSORTå‘½ä»¤æ€»ä¼šå°†æ’åºåçš„æ‰€æœ‰å…ƒç´ éƒ½è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p>
<p>ä½†æ˜¯ï¼Œé€šè¿‡LIMITé€‰é¡¹ï¼Œæˆ‘ä»¬å¯ä»¥è®©SORTå‘½ä»¤åªè¿”å›å…¶ä¸­ä¸€éƒ¨åˆ†å·²æ’åºçš„å…ƒç´ ã€‚LIMITé€‰é¡¹çš„æ ¼å¼ä¸ºLIMIT &lt;offset&gt; &lt;count&gt;ï¼š</p>
<ul>
<li>offsetå‚æ•°è¡¨ç¤ºè¦è·³è¿‡çš„å·²æ’åºå…ƒç´ æ•°é‡ã€‚</li>
<li>countå‚æ•°è¡¨ç¤ºè·³è¿‡ç»™å®šæ•°é‡çš„å·²æ’åºå…ƒç´ ä¹‹åï¼Œè¦è¿”å›çš„å·²æ’åºå…ƒç´ æ•°é‡ã€‚</li>
</ul>
<p>æœåŠ¡å™¨æ‰§è¡ŒSORT alphabet ALPHA LIMIT 0 4å‘½ä»¤çš„è¯¦ç»†æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li>åˆ›å»ºä¸€ä¸ªredisSortObjectç»“æ„æ•°ç»„ï¼Œæ•°ç»„çš„é•¿åº¦ç­‰äºalphabeté›†åˆçš„å¤§å°ã€‚</li>
<li>éå†æ•°ç»„ï¼Œå°†å„ä¸ªæ•°ç»„é¡¹çš„objæŒ‡é’ˆåˆ†åˆ«æŒ‡å‘alphabeté›†åˆçš„å„ä¸ªå…ƒç´ ã€‚</li>
<li>æ ¹æ®objæŒ‡é’ˆæ‰€æŒ‡å‘çš„é›†åˆå…ƒç´ ï¼Œå¯¹æ•°ç»„è¿›è¡Œå­—ç¬¦ä¸²æ’åºã€‚</li>
<li>æ ¹æ®é€‰é¡¹LIMIT 0 4ï¼Œå°†æŒ‡é’ˆç§»åŠ¨åˆ°æ•°ç»„çš„ç´¢å¼•0ä¸Šé¢ï¼Œç„¶åä¾æ¬¡è®¿é—®array [0]ã€array[1]ã€array[2]ã€array[3]è¿™4ä¸ªæ•°ç»„é¡¹ï¼Œå¹¶å°†æ•°ç»„é¡¹çš„objæŒ‡é’ˆæ‰€æŒ‡å‘çš„å…ƒç´ â€aâ€ã€â€bâ€ã€â€câ€ã€â€dâ€è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</li>
</ol>
<h3 id="GETé€‰é¡¹çš„å®ç°"><a href="#GETé€‰é¡¹çš„å®ç°" class="headerlink" title="GETé€‰é¡¹çš„å®ç°"></a>GETé€‰é¡¹çš„å®ç°</h3><p>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒSORTå‘½ä»¤åœ¨å¯¹é”®è¿›è¡Œæ’åºä¹‹åï¼Œæ€»æ˜¯è¿”å›è¢«æ’åºé”®æœ¬èº«æ‰€åŒ…å«çš„å…ƒç´ ã€‚</p>
<p>ä½†æ˜¯ï¼Œé€šè¿‡ä½¿ç”¨GETé€‰é¡¹ï¼Œæˆ‘ä»¬å¯ä»¥è®©SORTå‘½ä»¤åœ¨å¯¹é”®è¿›è¡Œæ’åºä¹‹åï¼Œæ ¹æ®è¢«æ’åºçš„å…ƒç´ ï¼Œä»¥åŠGETé€‰é¡¹æ‰€æŒ‡å®šçš„æ¨¡å¼ï¼ŒæŸ¥æ‰¾å¹¶è¿”å›æŸäº›é”®çš„å€¼ã€‚</p>
<p>æœåŠ¡å™¨æ‰§è¡ŒSORT students ALPHA GET*-nameå‘½ä»¤çš„è¯¦ç»†æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li>åˆ›å»ºä¸€ä¸ªredisSortObjectç»“æ„æ•°ç»„ï¼Œæ•°ç»„çš„é•¿åº¦ç­‰äºstudentsé›†åˆçš„å¤§å°ã€‚</li>
<li>éå†æ•°ç»„ï¼Œå°†å„ä¸ªæ•°ç»„é¡¹çš„objæŒ‡é’ˆåˆ†åˆ«æŒ‡å‘studentsé›†åˆçš„å„ä¸ªå…ƒç´ ã€‚</li>
<li>æ ¹æ®objæŒ‡é’ˆæ‰€æŒ‡å‘çš„é›†åˆå…ƒç´ ï¼Œå¯¹æ•°ç»„è¿›è¡Œå­—ç¬¦ä¸²æ’åºã€‚</li>
<li>éå†æ•°ç»„ï¼Œæ ¹æ®æ•°ç»„é¡¹objæŒ‡é’ˆæ‰€æŒ‡å‘çš„é›†åˆå…ƒç´ ï¼Œä»¥åŠGETé€‰é¡¹æ‰€ç»™å®šçš„*ä¸€nameæ¨¡å¼ï¼ŒæŸ¥æ‰¾ç›¸åº”çš„é”®ã€‚</li>
<li>éå†æŸ¥æ‰¾ç¨‹åºè¿”å›çš„ä¸‰ä¸ªé”®ï¼Œå¹¶å‘å®¢æˆ·ç«¯è¿”å›å®ƒä»¬çš„å€¼ã€‚</li>
</ol>
<p>å› ä¸ºä¸€ä¸ªSORTå‘½ä»¤å¯ä»¥å¸¦æœ‰å¤šä¸ªGETé€‰é¡¹ï¼Œæ‰€ä»¥éšç€GETé€‰é¡¹çš„å¢å¤šï¼Œå‘½ä»¤è¦æ‰§è¡Œçš„æŸ¥æ‰¾æ“ä½œä¹Ÿä¼šå¢å¤šã€‚</p>
<p>SORTå‘½ä»¤åœ¨æ‰§è¡Œå…¶ä»–å¸¦æœ‰GETé€‰é¡¹çš„æ’åºæ“ä½œæ—¶ï¼Œæ‰§è¡Œçš„æ­¥éª¤ä¹Ÿå’Œè¿™é‡Œç»™å‡ºçš„æ­¥éª¤ç±»ä¼¼ã€‚</p>
<h3 id="STOREé€‰é¡¹çš„å®ç°"><a href="#STOREé€‰é¡¹çš„å®ç°" class="headerlink" title="STOREé€‰é¡¹çš„å®ç°"></a>STOREé€‰é¡¹çš„å®ç°</h3><p>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒSORTå‘½ä»¤åªå‘å®¢æˆ·ç«¯è¿”å›æ’åºç»“æœï¼Œè€Œä¸ä¿å­˜æ’åºç»“æœã€‚ä½†æ˜¯ï¼Œé€šè¿‡ä½¿ç”¨STORE é€‰é¡¹ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ’åºç»“æœä¿å­˜åœ¨æŒ‡å®šçš„é”®é‡Œé¢ï¼Œå¹¶åœ¨æœ‰éœ€è¦æ—¶é‡ç”¨è¿™ä¸ªæ’åºç»“æœã€‚</p>
<p>æœåŠ¡å™¨æ‰§è¡ŒSORT students ALPHA STORE sorted_studentså‘½ä»¤çš„è¯¦ç»†æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li>åˆ›å»ºä¸€ä¸ªredisSortObjectç»“æ„æ•°ç»„ï¼Œæ•°ç»„çš„é•¿åº¦ç­‰äºstudentsé›†åˆçš„å¤§å°ã€‚</li>
<li>éå†æ•°ç»„ï¼Œå°†å„ä¸ªæ•°ç»„é¡¹çš„objæŒ‡é’ˆåˆ†åˆ«æŒ‡å‘studentsé›†åˆçš„å„ä¸ªå…ƒç´ ã€‚</li>
<li>æ ¹æ®objæŒ‡é’ˆæ‰€æŒ‡å‘çš„é›†åˆå…ƒç´ ï¼Œå¯¹æ•°ç»„è¿›è¡Œå­—ç¬¦ä¸²æ’åºã€‚</li>
<li>æ£€æŸ¥sorted_studentsé”®æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨çš„è¯ï¼Œé‚£ä¹ˆåˆ é™¤è¯¥é”®ã€‚</li>
<li>è®¾ç½®sorted_studentsä¸ºç©ºç™½çš„åˆ—è¡¨é”®ã€‚</li>
<li>éå†æ•°ç»„ï¼Œå°†æ’åºåçš„ä¸‰ä¸ªå…ƒç´ â€jackâ€ã€â€peterâ€å’Œâ€tomâ€ä¾æ¬¡æ¨å…¥sorted_studentsåˆ—è¡¨çš„æœ«å°¾ï¼Œç›¸å½“äºæ‰§è¡Œå‘½ä»¤RPUSH sorted_students â€œjackâ€ã€â€peterâ€ã€â€tomâ€ã€‚</li>
<li>éå†æ•°ç»„ï¼Œå‘å®¢æˆ·ç«¯è¿”å›â€jackâ€ã€â€peterâ€ã€â€tomâ€ä¸‰ä¸ªå…ƒç´ ã€‚</li>
</ol>
<p>SORTå‘½ä»¤åœ¨æ‰§è¡Œå…¶ä»–å¸¦æœ‰STOREé€‰é¡¹çš„æ’åºæ“ä½œæ—¶ï¼Œæ‰§è¡Œçš„æ­¥éª¤ä¹Ÿå’Œè¿™é‡Œç»™å‡ºçš„æ­¥éª¤ç±»ä¼¼ã€‚</p>
<h3 id="å¤šä¸ªé€‰é¡¹çš„æ‰§è¡Œé¡ºåº"><a href="#å¤šä¸ªé€‰é¡¹çš„æ‰§è¡Œé¡ºåº" class="headerlink" title="å¤šä¸ªé€‰é¡¹çš„æ‰§è¡Œé¡ºåº"></a>å¤šä¸ªé€‰é¡¹çš„æ‰§è¡Œé¡ºåº</h3><h4 id="é€‰é¡¹çš„æ‰§è¡Œé¡ºåº"><a href="#é€‰é¡¹çš„æ‰§è¡Œé¡ºåº" class="headerlink" title="é€‰é¡¹çš„æ‰§è¡Œé¡ºåº"></a>é€‰é¡¹çš„æ‰§è¡Œé¡ºåº</h4><p>å¦‚æœæŒ‰ç…§é€‰é¡¹æ¥åˆ’åˆ†çš„è¯ï¼Œä¸€ä¸ªSORTå‘½ä»¤çš„æ‰§è¡Œè¿‡ç¨‹å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å››æ­¥ï¼š</p>
<ol>
<li>æ’åºï¼šåœ¨è¿™ä¸€æ­¥ï¼Œå‘½ä»¤ä¼šä½¿ç”¨ALPHAã€ASCæˆ–DESCã€BYè¿™å‡ ä¸ªé€‰é¡¹ï¼Œå¯¹è¾“å…¥é”®è¿›è¡Œæ’åºï¼Œå¹¶å¾—åˆ°ä¸€ä¸ªæ’åºç»“æœé›†ã€‚</li>
<li>é™åˆ¶æ’åºç»“æœé›†çš„é•¿åº¦ï¼šåœ¨è¿™ä¸€æ­¥ï¼Œå‘½ä»¤ä¼šä½¿ç”¨LIMITé€‰é¡¹ï¼Œå¯¹æ’åºç»“æœé›†çš„é•¿åº¦è¿›è¡Œé™åˆ¶ï¼Œåªæœ‰LIMITé€‰é¡¹æŒ‡å®šçš„é‚£éƒ¨åˆ†å…ƒç´ ä¼šè¢«ä¿ç•™åœ¨æ’åºç»“æœé›†ä¸­ã€‚</li>
<li>è·å–å¤–éƒ¨é”®ï¼šåœ¨è¿™ä¸€æ­¥ï¼Œå‘½ä»¤ä¼šä½¿ç”¨GETé€‰é¡¹ï¼Œæ ¹æ®æ’åºç»“æœé›†ä¸­çš„å…ƒç´ ï¼Œä»¥åŠGETé€‰é¡¹æŒ‡å®šçš„æ¨¡å¼ï¼ŒæŸ¥æ‰¾å¹¶è·å–æŒ‡å®šé”®çš„å€¼ï¼Œå¹¶ç”¨è¿™äº›å€¼æ¥ä½œä¸ºæ–°çš„æ’åºç»“æœé›†ã€‚</li>
<li>ä¿å­˜æ’åºç»“æœé›†ï¼šåœ¨è¿™ä¸€æ­¥ï¼Œå‘½ä»¤ä¼šä½¿ç”¨STOREé€‰é¡¹ï¼Œå°†æ’åºç»“æœé›†ä¿å­˜åˆ°æŒ‡å®šçš„é”®ä¸Šé¢å»ã€‚</li>
<li>å‘å®¢æˆ·ç«¯è¿”å›æ’åºç»“æœé›†ï¼šåœ¨æœ€åè¿™ä¸€æ­¥ï¼Œå‘½ä»¤éå†æ’åºç»“æœé›†ï¼Œå¹¶ä¾æ¬¡å‘å®¢æˆ·ç«¯è¿”å›æ’åºç»“æœé›†ä¸­çš„å…ƒç´ ã€‚</li>
</ol>
<p>åœ¨ä»¥ä¸Šè¿™äº›æ­¥éª¤ä¸­ï¼Œåä¸€ä¸ªæ­¥éª¤å¿…é¡»åœ¨å‰ä¸€ä¸ªæ­¥éª¤å®Œæˆä¹‹åè¿›è¡Œã€‚</p>
<h4 id="é€‰é¡¹çš„æ‘†æ”¾é¡ºåº"><a href="#é€‰é¡¹çš„æ‘†æ”¾é¡ºåº" class="headerlink" title="é€‰é¡¹çš„æ‘†æ”¾é¡ºåº"></a>é€‰é¡¹çš„æ‘†æ”¾é¡ºåº</h4><p>å¦å¤–è¦æé†’çš„ä¸€ç‚¹æ˜¯ï¼Œè°ƒç”¨SORTå‘½ä»¤æ—¶ï¼Œé™¤äº†GETé€‰é¡¹ä¹‹å¤–ï¼Œæ”¹å˜é€‰é¡¹çš„æ‘†æ”¾é¡ºåºå¹¶ä¸ä¼šå½±å“SORTå‘½ä»¤æ‰§è¡Œè¿™äº›é€‰é¡¹çš„é¡ºåºã€‚</p>
<p>ä¾‹å¦‚ï¼Œå‘½ä»¤ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SORT &lt;key&gt; ALPHA DESC BY &lt;by-pattern&gt; LIMIT &lt;offset&gt; &lt;count&gt; GET &lt;get-pattern&gt; STORE &lt;store_key&gt;</span><br><span class="line"></span><br><span class="line">SORT &lt;key&gt; LIMIT &lt;offset&gt; &lt;count&gt; BY &lt;by-pattern&gt; ALPHA GET &lt;get-pattern&gt; STORE &lt;store_key&gt; DESC</span><br><span class="line"></span><br><span class="line">SORT &lt;key&gt; STORE &lt;store_key&gt; DESC BY &lt;by-pattern&gt; GET &lt;get-pattern&gt; ALPHA LIMIT &lt;offset&gt; &lt;count&gt;</span><br></pre></td></tr></table></figure>

<p>éƒ½äº§ç”Ÿå®Œå…¨ç›¸åŒçš„æ’åºæ•°æ®é›†ã€‚ä¸è¿‡ï¼Œå¦‚æœå‘½ä»¤åŒ…å«äº†å¤šä¸ªGETé€‰é¡¹ï¼Œé‚£ä¹ˆåœ¨è°ƒæ•´é€‰é¡¹çš„ä½ç½®æ—¶ï¼Œæˆ‘ä»¬å¿…é¡»ä¿è¯å¤šä¸ªGETé€‰é¡¹çš„æ‘†æ”¾é¡ºåºä¸å˜ï¼Œè¿™æ‰å¯ä»¥è®©æ’åºç»“æœé›†ä¿æŒä¸å˜ã€‚<br>ä¾‹å¦‚ï¼Œå‘½ä»¤ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SORT &lt;key&gt; GET &lt;pattern-a&gt; GET &lt;pattern-b&gt; STORE &lt;store_key&gt;</span><br><span class="line"></span><br><span class="line">SORT &lt;key&gt; STORE &lt;store_key&gt; GET &lt;pattern-a&gt; GET &lt;pattern-b&gt;</span><br></pre></td></tr></table></figure>

<p>äº§ç”Ÿçš„æ’åºç»“æœé›†æ˜¯å®Œå…¨ä¸€æ ·çš„ï¼Œä½†å¦‚æœå°†ä¸¤ä¸ªGETé€‰é¡¹çš„é¡ºåºè°ƒæ•´ä¸€ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SORT &lt;key&gt; STORE &lt;store_key&gt; GET &lt;pattern-b&gt; GET &lt;pattern-a&gt;</span><br></pre></td></tr></table></figure>


<p>é‚£ä¹ˆè¿™ä¸ªå‘½ä»¤äº§ç”Ÿçš„æ’åºç»“æœé›†å°±ä¼šå’Œå‰é¢ä¸¤ä¸ªå‘½ä»¤äº§ç”Ÿçš„æ’åºç»“æœé›†ä¸åŒã€‚å› æ­¤åœ¨è°ƒæ•´SORTå‘½ä»¤å„ä¸ªé€‰é¡¹çš„æ‘†æ”¾é¡ºåºæ—¶ï¼Œå¿…é¡»å°å¿ƒå¤„ç†GETé€‰é¡¹ã€‚</p>
<h2 id="äºŒè¿›åˆ¶ä½æ•°ç»„"><a href="#äºŒè¿›åˆ¶ä½æ•°ç»„" class="headerlink" title="äºŒè¿›åˆ¶ä½æ•°ç»„"></a>äºŒè¿›åˆ¶ä½æ•°ç»„</h2><p>Redisæä¾›äº†SETBITã€GETBITã€BITCOUNTã€BITOPå››ä¸ªå‘½ä»¤ç”¨äºå¤„ç†äºŒè¿›åˆ¶ä½æ•°ç»„ï¼ˆbit arrayï¼Œåˆç§°â€œä½æ•°ç»„â€ï¼‰ã€‚</p>
<p>å…¶ä¸­ï¼ŒSETBITå‘½ä»¤ç”¨äºä¸ºä½æ•°ç»„æŒ‡å®šåç§»é‡ä¸Šçš„äºŒè¿›åˆ¶ä½è®¾ç½®å€¼ï¼Œä½æ•°ç»„çš„åç§»é‡ä»0å¼€å§‹è®¡æ•°ï¼Œè€ŒäºŒè¿›åˆ¶ä½çš„å€¼åˆ™å¯ä»¥æ˜¯0æˆ–è€…1ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">redis&gt; SETBIT bit 0 1	# 0000 0001</span><br><span class="line">(integer) 0</span><br><span class="line">redis&gt; SETBIT bit 3 1	# 0000 1001</span><br><span class="line">(integer) 0</span><br><span class="line">redis&gt; SETBIT bit 0 0	# 0000 1000</span><br><span class="line">(integer) 1</span><br></pre></td></tr></table></figure>


<p>è€ŒGETBITå‘½ä»¤åˆ™ç”¨äºè·å–ä½æ•°ç»„æŒ‡å®šåç§»é‡ä¸Šçš„äºŒè¿›åˆ¶ä½çš„å€¼ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">redis&gt; GETBIT bit 0		# 0000 1000</span><br><span class="line">(integer) 0</span><br><span class="line">redis&gt; GETBIT bit 3 	# 0000 1000</span><br><span class="line">(integer) 1</span><br></pre></td></tr></table></figure>


<p>BITCOUNTå‘½ä»¤ç”¨äºç»Ÿè®¡ä½æ•°ç»„é‡Œé¢ï¼Œå€¼ä¸º1çš„äºŒè¿›åˆ¶ä½çš„æ•°é‡ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">redis&gt; BITCOUNT bit		# 0000 1000</span><br><span class="line">(integer) 1</span><br><span class="line">redis&gt; SETBIT bit 0 1	# 0000 1001</span><br><span class="line">(integer) 0</span><br><span class="line">redis&gt; BITCOUNT bit</span><br><span class="line">(integer) 2</span><br><span class="line">redis&gt; SETBIT bit 1 1	# 0000 1011</span><br><span class="line">(integer) 0</span><br><span class="line">redis&gt; BITCOUNT bit</span><br><span class="line">(integer) 3</span><br></pre></td></tr></table></figure>


<p>æœ€åï¼ŒBITOPå‘½ä»¤æ—¢å¯ä»¥å¯¹å¤šä¸ªä½æ•°ç»„è¿›è¡ŒæŒ‰ä½ä¸ï¼ˆandï¼‰ã€æŒ‰ä½æˆ–ï¼ˆorï¼‰ã€æŒ‰ä½å¼‚æˆ–ï¼ˆxorï¼‰è¿ç®—ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">redis&gt; SETBIT x 3 1		# x = 0000 1011</span><br><span class="line">(integer) 0</span><br><span class="line">redis&gt; SETBIT x 1 1</span><br><span class="line">(integer) 0</span><br><span class="line">redis&gt; SETBIT x 0 1</span><br><span class="line">(integer) 0</span><br><span class="line">redis&gt; SETBIT y 2 1		# y = 0000 0110</span><br><span class="line">(integer) 0</span><br><span class="line">redis&gt; SETBIT y 1 1</span><br><span class="line">(integer) 0</span><br><span class="line">redis&gt; SETBIT z 2 1		# z = 0000 0101</span><br><span class="line">(integer) 0</span><br><span class="line">redis&gt; SETBIT z 0 1</span><br><span class="line">(integer) 0</span><br><span class="line">redis&gt; BITOP AND and-result x y z	# 0000 0000</span><br><span class="line">(integer) 1</span><br><span class="line">redis&gt; BITOP OR or-result x y z		# 0000 1111</span><br><span class="line">(integer) 1</span><br><span class="line">redis&gt; BITOP XOR xor-result x y z	# 0000 1000</span><br><span class="line">(integer) 1</span><br></pre></td></tr></table></figure>


<p>ä¹Ÿå¯ä»¥å¯¹ç»™å®šçš„ä½æ•°ç»„è¿›è¡Œå–åï¼ˆnotï¼‰è¿ç®—ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">redis&gt; SETBIT value 0 1		# 0000 1001</span><br><span class="line">(integer) 0</span><br><span class="line">redis&gt; SETBIT value 3 1</span><br><span class="line">(integer) 0</span><br><span class="line">redis&gt; BITOP NOT not-value value 	# 1111 0110</span><br><span class="line">(integer) 1</span><br></pre></td></tr></table></figure>


<p>æœ¬ç« å°†å¯¹Redisè¡¨ç¤ºä½æ•°ç»„çš„æ–¹æ³•è¿›è¡Œè¯´æ˜ï¼Œå¹¶ä»‹ç»GETBITã€SETBITã€BITCOUNTã€BITOPå››ä¸ªå‘½ä»¤çš„å®ç°åŸç†ã€‚</p>
<h3 id="ä½æ•°ç»„çš„è¡¨ç¤º"><a href="#ä½æ•°ç»„çš„è¡¨ç¤º" class="headerlink" title="ä½æ•°ç»„çš„è¡¨ç¤º"></a>ä½æ•°ç»„çš„è¡¨ç¤º</h3><p>Redisä½¿ç”¨å­—ç¬¦ä¸²å¯¹è±¡æ¥è¡¨ç¤ºä½æ•°ç»„ï¼Œå› ä¸ºå­—ç¬¦ä¸²å¯¹è±¡ä½¿ç”¨çš„SDSæ•°æ®ç»“æ„æ˜¯äºŒè¿›åˆ¶å®‰å…¨çš„ï¼Œæ‰€ä»¥ç¨‹åºå¯ä»¥ç›´æ¥ä½¿ç”¨SDSç»“æ„æ¥ä¿å­˜ä½æ•°ç»„ï¼Œå¹¶ä½¿ç”¨SDSç»“æ„çš„æ“ä½œå‡½æ•°æ¥å¤„ç†ä½æ•°ç»„ã€‚</p>
<p>å›¾22-1å±•ç¤ºäº†ç”¨SDSè¡¨ç¤ºçš„ï¼Œä¸€å­—èŠ‚é•¿çš„ä½æ•°ç»„ï¼š</p>
<ul>
<li>redisObject.typeçš„å€¼ä¸ºREDIS_STRINGï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡ã€‚</li>
<li>sdshdr.lençš„å€¼ä¸º1ï¼Œè¡¨ç¤ºè¿™ä¸ªSDSä¿å­˜äº†ä¸€ä¸ªä¸€å­—èŠ‚é•¿çš„ä½æ•°ç»„ã€‚</li>
<li>bufæ•°ç»„ä¸­çš„buf[0]å­—èŠ‚ä¿å­˜äº†ä¸€å­—èŠ‚é•¿çš„ä½æ•°ç»„ã€‚</li>
<li>bufæ•°ç»„ä¸­çš„buf [1]å­—èŠ‚ä¿å­˜äº†SDSç¨‹åºè‡ªåŠ¨è¿½åŠ åˆ°å€¼çš„æœ«å°¾çš„ç©ºå­—ç¬¦â€™\0â€™ã€‚</li>
</ul>
<p><img src="/..%5Cimg%5CRedis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%5CSDS%E4%BD%8D%E6%95%B0%E7%BB%84.png" alt="SDSä½æ•°ç»„"></p>
<p>å› ä¸ºæœ¬ç« ä»‹ç»çš„æ“ä½œæ¶‰åŠäºŒè¿›åˆ¶ä½ï¼Œä¸ºäº†æ¸…æ™°åœ°å±•ç¤ºå„ä¸ªä½çš„å€¼ï¼Œæœ¬ç« ä¼šå¯¹SDSä¸­bufæ•°ç»„çš„å±•ç¤ºæ–¹å¼è¿›è¡Œä¸€äº›ä¿®æ”¹ï¼Œè®©å„ä¸ªå­—èŠ‚çš„å„ä¸ªä½éƒ½å¯ä»¥æ¸…æ¥šåœ°å±•ç°å‡ºæ¥ã€‚æ¯”å¦‚è¯´ï¼Œæœ¬ç« ä¼šå°†å‰é¢å›¾22-1å±•ç¤ºçš„SDSå€¼æ”¹æˆå›¾22-2æ‰€ç¤ºçš„æ ·å­ã€‚</p>
<p><img src="/..%5Cimg%5CRedis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%5C%E4%B8%80%E5%AD%97%E8%8A%82%E9%95%BF%E7%9A%84%E4%B8%BA%E6%95%B0%E7%BB%84%E7%9A%84SDS%E8%A1%A8%E7%A4%BA.png" alt="ä¸€å­—èŠ‚é•¿çš„ä¸ºæ•°ç»„çš„SDSè¡¨ç¤º"></p>
<p>ç°åœ¨ï¼Œbufæ•°ç»„çš„æ¯ä¸ªå­—èŠ‚éƒ½ç”¨ä¸€è¡Œæ¥è¡¨ç¤ºï¼Œæ¯è¡Œçš„ç¬¬ä¸€ä¸ªæ ¼å­buf[i]è¡¨ç¤ºè¿™æ˜¯bufæ•°ç»„çš„å“ªä¸ªå­—èŠ‚ï¼Œè€Œbuf[i]ä¹‹åçš„å…«ä¸ªæ ¼å­åˆ™åˆ†åˆ«ä»£è¡¨è¿™ä¸€å­—èŠ‚ä¸­çš„å…«ä¸ªä½ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œbufæ•°ç»„ä¿å­˜ä½æ•°ç»„çš„é¡ºåºå’Œæˆ‘ä»¬å¹³æ—¶ä¹¦å†™ä½æ•°ç»„çš„é¡ºåºæ˜¯å®Œå…¨ç›¸åçš„ï¼Œä¾‹å¦‚ï¼Œåœ¨å›¾22-2çš„buf[0]å­—èŠ‚ä¸­ï¼Œå„ä¸ªä½çš„å€¼åˆ†åˆ«æ˜¯1ã€0ã€1ã€1ã€0ã€0ã€1ã€0ï¼Œè¿™è¡¨ç¤ºbuf[0]å­—èŠ‚ä¿å­˜çš„ä½æ•°ç»„ä¸º0100 1101ã€‚ä½¿ç”¨é€†åºæ¥ä¿å­˜ä½æ•°ç»„å¯ä»¥ç®€åŒ–SETBITå‘½ä»¤çš„å®ç°ï¼Œè¯¦ç»†çš„æƒ…å†µç¨ååœ¨ä»‹ç»SETBITå‘½ä»¤çš„å®ç°åŸç†æ—¶ä¼šè¯´åˆ°ã€‚</p>
<p>å›¾22-3å±•ç¤ºäº†å¦ä¸€ä¸ªä½æ•°ç»„ç¤ºä¾‹ï¼š</p>
<ul>
<li>sdshdr.lenå±æ€§çš„å€¼ä¸º3ï¼Œè¡¨ç¤ºè¿™ä¸ªSDSä¿å­˜äº†ä¸€ä¸ªä¸‰å­—èŠ‚é•¿çš„ä½æ•°ç»„ã€‚</li>
<li>ä½æ•°ç»„ç”±bufæ•°ç»„ä¸­çš„buf[0]ã€buf[1]ã€buf[2]ä¸‰ä¸ªå­—èŠ‚ä¿å­˜ï¼Œå’Œä¹‹å‰è¯´æ˜çš„ä¸€æ ·ï¼Œbufæ•°ç»„ä½¿ç”¨é€†åºæ¥ä¿å­˜ä½æ•°ç»„ï¼šä½æ•°ç»„1111 0000 1100 0011 1010 0101åœ¨bufæ•°ç»„ä¸­ä¼šè¢«ä¿å­˜ä¸º1010 0101 1100 0011 0000 1111ã€‚</li>
</ul>
<p><img src="/..%5Cimg%5CRedis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%5C%E4%B8%89%E5%AD%97%E8%8A%82%E9%95%BF%E7%9A%84%E4%BD%8D%E6%95%B0%E7%BB%84%E7%9A%84SDS%E8%A1%A8%E7%A4%BA.png" alt="ä¸‰å­—èŠ‚é•¿çš„ä½æ•°ç»„çš„SDSè¡¨ç¤º"></p>
<h3 id="GETBITå‘½ä»¤çš„å®ç°"><a href="#GETBITå‘½ä»¤çš„å®ç°" class="headerlink" title="GETBITå‘½ä»¤çš„å®ç°"></a>GETBITå‘½ä»¤çš„å®ç°</h3><p>GETBITå‘½ä»¤ç”¨äºè¿”å›ä½æ•°ç»„bitarrayåœ¨offsetåç§»é‡ä¸Šçš„äºŒè¿›åˆ¶ä½çš„å€¼ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GETBIT &lt;bitarray&gt; &lt;offset&gt;</span><br></pre></td></tr></table></figure>

<p>GETBITå‘½ä»¤çš„æ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>è®¡ç®—byte&#x3D;âŒŠoffset Ã· 8âŒ‹,byteå€¼è®°å½•äº†offsetåç§»é‡æŒ‡å®šçš„äºŒè¿›åˆ¶ä½ä¿å­˜åœ¨ä½æ•°ç»„çš„å“ªä¸ªå­—èŠ‚ã€‚</li>
<li>è®¡ç®—bit&#x3D;(offset mod 8)+1ï¼Œbitå€¼è®°å½•äº†offsetåç§»é‡æŒ‡å®šçš„äºŒè¿›åˆ¶ä½æ˜¯byteå­—èŠ‚çš„ç¬¬å‡ ä¸ªäºŒè¿›åˆ¶ä½ã€‚</li>
<li>æ ¹æ®byteå€¼å’Œbitå€¼ï¼Œåœ¨ä½æ•°ç»„bitarrayä¸­å®šä½offsetåç§»é‡æŒ‡å®šçš„äºŒè¿›åˆ¶ä½ï¼Œå¹¶è¿”å›è¿™ä¸ªä½çš„å€¼ã€‚</li>
</ol>
<p>å› ä¸ºGETBITå‘½ä»¤æ‰§è¡Œçš„æ‰€æœ‰æ“ä½œéƒ½å¯ä»¥åœ¨å¸¸æ•°æ—¶é—´å†…å®Œæˆï¼Œæ‰€ä»¥è¯¥å‘½ä»¤çš„ç®—æ³•å¤æ‚åº¦ä½O(1)ã€‚</p>
<h3 id="SETBITå‘½ä»¤çš„å®Œæˆ"><a href="#SETBITå‘½ä»¤çš„å®Œæˆ" class="headerlink" title="SETBITå‘½ä»¤çš„å®Œæˆ"></a>SETBITå‘½ä»¤çš„å®Œæˆ</h3><p>SETBITç”¨äºå°†ä½æ•°ç»„bitarrayåœ¨offsetåç§»é‡ä¸Šçš„äºŒè¿›åˆ¶ä½çš„å€¼è®¾ç½®ä¸ºvalueï¼Œå¹¶å‘å®¢æˆ·ç«¯è¿”å›äºŒè¿›åˆ¶ä½è¢«è®¾ç½®ä¹‹å‰çš„æ—§å€¼ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SETBIT &lt;bitarray&gt; &lt;offset&gt; &lt;value&gt;</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸‹æ˜¯SETBITå‘½ä»¤çš„æ‰§è¡Œè¿‡ç¨‹ï¼š</p>
<ol>
<li>è®¡ç®—len &#x3D; âŒŠoffset Ã· 8âŒ‹ + 1ï¼Œlenå€¼è®°å½•äº†ä¿å­˜offsetåç§»é‡æŒ‡å®šçš„äºŒè¿›åˆ¶ä½è‡³å°‘éœ€è¦å¤šå°‘å­—èŠ‚ã€‚</li>
<li>æ£€æŸ¥bitarrayé”®ä¿å­˜çš„ä½æ•°ç»„ï¼ˆä¹Ÿå³æ˜¯SDSï¼‰çš„é•¿åº¦æ˜¯å¦å°äºlenï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œå°†SDSçš„é•¿åº¦æ‰©å±•ä¸ºlenå­—èŠ‚ï¼Œå¹¶å°†æ‰€æœ‰æ–°æ‰©å±•ç©ºé—´çš„äºŒè¿›åˆ¶ä½çš„å€¼è®¾ç½®ä¸º0ã€‚</li>
<li>è®¡ç®—byte &#x3D; âŒŠoffset Ã· 8âŒ‹ï¼Œ byteå€¼è®°å½•äº†offsetåç§»é‡æŒ‡å®šçš„äºŒè¿›åˆ¶ä½ä¿å­˜åœ¨ä½æ•°ç»„çš„å“ªä¸ªå­—èŠ‚ã€‚</li>
<li>è®¡ç®—bit &#x3D; (offset mod 8) + 1ï¼Œbitå€¼è®°å½•äº†offsetåç§»é‡æŒ‡å®šçš„äºŒè¿›åˆ¶ä½æ˜¯byteå­—èŠ‚çš„ç¬¬å‡ ä¸ªäºŒè¿›åˆ¶ä½ã€‚</li>
<li>æ ¹æ®byteå€¼å’Œbitå€¼ï¼Œåœ¨bitarrayé”®ä¿å­˜çš„ä½æ•°ç»„ä¸­å®šä½offsetåç§»é‡æŒ‡å®šçš„äºŒè¿›åˆ¶ä½ï¼Œé¦–å…ˆå°†æŒ‡å®šäºŒè¿›åˆ¶ä½ç°åœ¨å€¼ä¿å­˜åœ¨oldvalueå˜é‡ï¼Œç„¶åå°†æ–°å€¼valueè®¾ç½®ä¸ºè¿™ä¸ªäºŒè¿›åˆ¶ä½çš„å€¼ã€‚</li>
<li>å‘å®¢æˆ·ç«¯è¿”å›oldvalueå˜é‡çš„å€¼ã€‚</li>
</ol>
<p>å› ä¸ºSETBITå‘½ä»¤æ‰§è¡Œçš„æ‰€æœ‰æ“ä½œéƒ½å¯ä»¥åœ¨å¸¸æ•°æ—¶é—´å†…å®Œæˆï¼Œæ‰€ä»¥è¯¥å‘½ä»¤çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(1)ã€‚</p>
<h4 id="å¸¦æ‰©å±•æ“ä½œçš„SETBITå‘½ä»¤ç¤ºä¾‹"><a href="#å¸¦æ‰©å±•æ“ä½œçš„SETBITå‘½ä»¤ç¤ºä¾‹" class="headerlink" title="å¸¦æ‰©å±•æ“ä½œçš„SETBITå‘½ä»¤ç¤ºä¾‹"></a>å¸¦æ‰©å±•æ“ä½œçš„SETBITå‘½ä»¤ç¤ºä¾‹</h4><p><img src="/..%5Cimg%5CRedis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%5C%E4%B8%80%E5%AD%97%E8%8A%82%E9%95%BF%E7%9A%84%E4%B8%BA%E6%95%B0%E7%BB%84%E7%9A%84SDS%E8%A1%A8%E7%A4%BA.png" alt="ä¸€å­—èŠ‚é•¿çš„ä¸ºæ•°ç»„çš„SDSè¡¨ç¤º"><br>å‡è®¾æˆ‘ä»¬å¯¹ä¸Šå›¾æ‰€ç¤ºçš„ä½æ•°ç»„æ‰§è¡Œå‘½ä»¤ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SETBIT &lt;bitarray&gt; 12 1</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆæœåŠ¡å™¨å°†æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p>
<ol>
<li>è®¡ç®—âŒŠ12 Ã· 8âŒ‹ + 1ï¼Œå¾—å‡ºå€¼2ï¼Œè¿™è¡¨ç¤ºä¿å­˜åç§»é‡ä¸º12çš„äºŒè¿›åˆ¶ä½è‡³å°‘éœ€è¦2å­—èŠ‚é•¿çš„ä½æ•°ç»„ã€‚</li>
<li>å¯¹ä½æ•°ç»„çš„é•¿åº¦è¿›è¡Œæ£€æŸ¥ï¼Œå¾—çŸ¥ä½æ•°ç»„ç°åœ¨çš„é•¿åº¦ä¸º1å­—èŠ‚ï¼Œè¿™æ¯”æ‰§è¡Œå‘½ä»¤æ‰€éœ€çš„æœ€å°é•¿åº¦2å­—èŠ‚è¦å°ï¼Œæ‰€ä»¥ç¨‹åºä¼šè¦æ±‚å°†ä½æ•°ç»„çš„é•¿åº¦æ‰©å±•ä¸º2å­—èŠ‚ã€‚ä¸è¿‡ï¼Œå°½ç®¡ç¨‹åºåªè¦æ±‚2å­—èŠ‚é•¿çš„ä½æ•°ç»„ï¼Œä½†SDSçš„ç©ºé—´é¢„åˆ†é…ç­–ç•¥ä¼šä¸ºSDSé¢å¤–å¤šåˆ†é…2å­—èŠ‚çš„æœªä½¿ç”¨ç©ºé—´ï¼Œå†åŠ ä¸Šä¸ºä¿å­˜ç©ºå­—ç¬¦è€Œé¢å¤–åˆ†é…çš„1å­—èŠ‚ï¼Œæ‰©å±•ä¹‹åbufæ•°ç»„çš„å®é™…é•¿åº¦ä¸º5å­—èŠ‚ï¼Œå¦‚å›¾22-8æ‰€ç¤ºã€‚</li>
<li>è®¡ç®—âŒŠ12 Ã· 8âŒ‹ï¼Œå¾—å‡ºå€¼1ï¼Œè¯´æ˜åç§»é‡ä¸º12çš„äºŒè¿›åˆ¶ä½ä½äºbuf[1]å­—èŠ‚ä¸­ã€‚</li>
<li>è®¡ç®—(12 mod 8) + 1ï¼Œå¾—å‡ºå€¼5ï¼Œè¯´æ˜åç§»é‡ä¸º12çš„äºŒè¿›åˆ¶ä½æ˜¯buf[1]å­—èŠ‚çš„ç¬¬5ä¸ªäºŒè¿›åˆ¶ä½ã€‚</li>
<li>å®šä½åˆ°buf[1]å­—èŠ‚çš„ç¬¬5ä¸ªäºŒè¿›åˆ¶ä½ï¼Œå°†äºŒè¿›åˆ¶ä½ç°åœ¨çš„å€¼0ä¿å­˜åˆ°oldvalueå˜é‡ï¼Œç„¶åå°†äºŒè¿›åˆ¶ä½çš„å€¼è®¾ç½®ä¸º1ã€‚</li>
<li>å‘å®¢æˆ·ç«¯è¿”å›oldvalueå˜é‡çš„å€¼0ã€‚</li>
</ol>
<p>å›¾22-10åˆ™å±•ç¤ºäº†SETBITå‘½ä»¤æ‰§è¡Œä¹‹åï¼Œä½æ•°ç»„çš„æ ·å­ã€‚</p>
<p>æ³¨æ„ï¼Œå› ä¸ºbufæ•°ç»„ä½¿ç”¨é€†åºæ¥ä¿å­˜ä½æ•°ç»„ï¼Œæ‰€ä»¥å½“ç¨‹åºå¯¹bufæ•°ç»„è¿›è¡Œæ‰©å±•ä¹‹åï¼Œå†™å…¥æ“ä½œå¯ä»¥ç›´æ¥åœ¨æ–°æ‰©å±•çš„äºŒè¿›åˆ¶ä½ä¸­å®Œæˆï¼Œè€Œä¸å¿…æ”¹åŠ¨ä½æ•°ç»„åŸæ¥å·²æœ‰çš„äºŒè¿›åˆ¶ä½ã€‚ç›¸ååœ°ï¼Œå¦‚æœbufæ•°ç»„ä½¿ç”¨å’Œä¹¦å†™ä½æ•°ç»„æ—¶ä¸€æ ·çš„é¡ºåºæ¥ä¿å­˜ä½æ•°ç»„ï¼Œé‚£ä¹ˆåœ¨æ¯æ¬¡æ‰©å±•bufæ•°ç»„ä¹‹åï¼Œç¨‹åºéƒ½éœ€è¦å°†ä½æ•°ç»„å·²æœ‰çš„ä½è¿›è¡Œç§»åŠ¨ï¼Œç„¶åæ‰èƒ½æ‰§è¡Œå†™å…¥æ“ä½œï¼Œè¿™æ¯”SETBITå‘½ä»¤ç›®å‰çš„å®ç°æ–¹å¼è¦å¤æ‚ï¼Œå¹¶ä¸”ç§»ä½å¸¦æ¥çš„CPUæ—¶é—´æ¶ˆè€—ä¹Ÿä¼šå½±å“å‘½ä»¤çš„æ‰§è¡Œé€Ÿåº¦ã€‚</p>
<p><img src="/..%5Cimg%5CRedis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%5C%E6%89%A9%E5%B1%95%E7%A9%BA%E9%97%B4%E4%B9%8B%E5%90%8E%E7%9A%84%E4%BD%8D%E6%95%B0%E7%BB%84.png" alt="æ‰©å±•ç©ºé—´ä¹‹åçš„ä½æ•°ç»„"></p>
<p><img src="/..%5Cimg%5CRedis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%5CSETBIT%E5%91%BD%E4%BB%A4%E4%B9%8B%E5%90%8E%E7%9A%84%E4%BD%8D%E6%95%B0%E7%BB%84.png" alt="SETBITå‘½ä»¤ä¹‹åçš„ä½æ•°ç»„"></p>
<h3 id="BITCOUNTå‘½ä»¤çš„å®ç°"><a href="#BITCOUNTå‘½ä»¤çš„å®ç°" class="headerlink" title="BITCOUNTå‘½ä»¤çš„å®ç°"></a>BITCOUNTå‘½ä»¤çš„å®ç°</h3><p>BITCOUNTå‘½ä»¤ç”¨äºç»Ÿè®¡ç»™å®šä½æ•°ç»„ä¸­ï¼Œå€¼ä¸º1çš„äºŒè¿›åˆ¶ä½çš„æ•°é‡ã€‚</p>
<p>BITCOUNTå‘½ä»¤è¦åšçš„å·¥ä½œåˆçœ‹ä¸Šå»å¹¶ä¸å¤æ‚ï¼Œä½†å®é™…ä¸Šè¦é«˜æ•ˆåœ°å®ç°è¿™ä¸ªå‘½ä»¤å¹¶ä¸å®¹æ˜“ï¼Œéœ€è¦ç”¨åˆ°ä¸€äº›ç²¾å·§çš„ç®—æ³•ã€‚</p>
<p>æ¥ä¸‹æ¥çš„å‡ ä¸ªå°èŠ‚å°†å¯¹BITCOUNTå‘½ä»¤å¯èƒ½ä½¿ç”¨çš„å‡ ç§ç®—æ³•è¿›è¡Œä»‹ç»ï¼Œå¹¶æœ€ç»ˆç»™å‡ºBITCOUNTå‘½ä»¤çš„å…·ä½“å®ç°åŸç†ã€‚</p>
<h4 id="äºŒè¿›åˆ¶ä½ç»Ÿè®¡ç®—æ³•ï¼ˆ1ï¼‰ï¼šéå†ç®—æ³•"><a href="#äºŒè¿›åˆ¶ä½ç»Ÿè®¡ç®—æ³•ï¼ˆ1ï¼‰ï¼šéå†ç®—æ³•" class="headerlink" title="äºŒè¿›åˆ¶ä½ç»Ÿè®¡ç®—æ³•ï¼ˆ1ï¼‰ï¼šéå†ç®—æ³•"></a>äºŒè¿›åˆ¶ä½ç»Ÿè®¡ç®—æ³•ï¼ˆ1ï¼‰ï¼šéå†ç®—æ³•</h4><p>å®ç°BITCOUNTå‘½ä»¤æœ€ç®€å•ç›´æ¥çš„æ–¹æ³•ï¼Œå°±æ˜¯éå†ä½æ•°ç»„ä¸­çš„æ¯ä¸ªäºŒè¿›åˆ¶ä½ï¼Œå¹¶åœ¨é‡åˆ°å€¼ä¸º1çš„äºŒè¿›åˆ¶ä½æ—¶ï¼Œå°†è®¡æ•°å™¨çš„å€¼å¢ä¸€ã€‚</p>
<p>éå†ç®—æ³•è™½ç„¶å®ç°èµ·æ¥ç®€å•ï¼Œä½†æ•ˆç‡éå¸¸ä½ï¼Œå› ä¸ºè¿™ä¸ªç®—æ³•åœ¨æ¯æ¬¡å¾ªç¯ä¸­åªèƒ½æ£€æŸ¥ä¸€ä¸ªäºŒè¿›åˆ¶ä½çš„å€¼æ˜¯å¦ä¸º1ï¼Œæ‰€ä»¥æ£€æŸ¥æ“ä½œæ‰§è¡Œçš„æ¬¡æ•°å°†ä¸ä½æ•°ç»„åŒ…å«çš„äºŒè¿›åˆ¶ä½çš„æ•°é‡æˆæ­£æ¯”ã€‚</p>
<p>ä¾‹å¦‚ï¼Œå‡è®¾è¦æ£€æŸ¥çš„ä½æ•°ç»„çš„é•¿åº¦ä¸º100MBï¼Œé‚£ä¹ˆæŒ‰1MB &#x3D; 1 000 000 Byte &#x3D; 8 000 000bitæ¥è®¡ç®—ï¼Œä½¿ç”¨éå†ç®—æ³•æ£€æŸ¥é•¿åº¦ä¸º100 MBçš„ä½æ•°ç»„å°†éœ€è¦æ‰§è¡Œæ£€æŸ¥æ“ä½œå…«äº¿æ¬¡ï¼ˆ100 * 8 000 000ï¼‰ï¼è€Œå¯¹äºé•¿åº¦ä¸º500MBçš„ä½æ•°ç»„æ¥è¯´ï¼Œéå†ç®—æ³•å°†éœ€è¦æ‰§è¡Œæ£€æŸ¥æ“ä½œå››åäº¿æ¬¡ï¼</p>
<p>å°½ç®¡éå†ç®—æ³•å¯¹å•ä¸ªäºŒè¿›åˆ¶ä½çš„æ£€æŸ¥å¯ä»¥åœ¨å¾ˆçŸ­çš„æ—¶é—´å†…å®Œæˆï¼Œä½†é‡å¤æ‰§è¡Œä¸Šäº¿æ¬¡è¿™ç§æ£€æŸ¥è‚¯å®šä¸æ˜¯ä¸€ä¸ªé«˜æ•ˆç¨‹åºåº”æœ‰çš„è¡¨ç°ï¼Œä¸ºäº†è®©BITCOUNTå‘½ä»¤çš„å®ç°å°½å¯èƒ½åœ°é«˜æ•ˆï¼Œç¨‹åºå¿…é¡»å°½å¯èƒ½åœ°å¢åŠ æ¯æ¬¡æ£€æŸ¥æ‰€èƒ½å¤„ç†çš„äºŒè¿›åˆ¶ä½çš„æ•°é‡ï¼Œä»è€Œå‡å°‘æ£€æŸ¥æ“ä½œæ‰§è¡Œçš„æ¬¡æ•°ã€‚</p>
<h4 id="äºŒè¿›åˆ¶ä½ç»Ÿè®¡ç®—æ³•ï¼ˆ2ï¼‰ï¼šæŸ¥è¡¨ç®—æ³•"><a href="#äºŒè¿›åˆ¶ä½ç»Ÿè®¡ç®—æ³•ï¼ˆ2ï¼‰ï¼šæŸ¥è¡¨ç®—æ³•" class="headerlink" title="äºŒè¿›åˆ¶ä½ç»Ÿè®¡ç®—æ³•ï¼ˆ2ï¼‰ï¼šæŸ¥è¡¨ç®—æ³•"></a>äºŒè¿›åˆ¶ä½ç»Ÿè®¡ç®—æ³•ï¼ˆ2ï¼‰ï¼šæŸ¥è¡¨ç®—æ³•</h4><p>ä¼˜åŒ–æ£€æŸ¥æ“ä½œçš„ä¸€ä¸ªåŠæ³•æ˜¯ä½¿ç”¨æŸ¥è¡¨æ³•ï¼š</p>
<ul>
<li>å¯¹äºä¸€ä¸ªæœ‰é™é›†åˆæ¥è¯´ï¼Œé›†åˆå…ƒç´ çš„æ’åˆ—æ–¹å¼æ˜¯æœ‰é™çš„ã€‚</li>
<li>è€Œå¯¹äºä¸€ä¸ªæœ‰é™é•¿åº¦çš„ä½æ•°ç»„æ¥è¯´ï¼Œå®ƒèƒ½è¡¨ç¤ºçš„äºŒè¿›åˆ¶ä½æ’åˆ—ä¹Ÿæ˜¯æœ‰é™çš„ã€‚</li>
</ul>
<p>æ ¹æ®è¿™ä¸ªåŸç†ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªè¡¨ï¼Œè¡¨çš„é”®ä¸ºæŸç§æ’åˆ—çš„ä½æ•°ç»„ï¼Œè€Œè¡¨çš„å€¼åˆ™æ˜¯ç›¸åº”ä½æ•°ç»„ä¸­ï¼Œå€¼ä¸º1çš„äºŒè¿›åˆ¶ä½çš„æ•°é‡ã€‚</p>
<p>åˆ›å»ºäº†è¿™ç§è¡¨ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ ¹æ®è¾“å…¥çš„ä½æ•°ç»„è¿›è¡ŒæŸ¥è¡¨ï¼Œåœ¨æ— é¡»å¯¹ä½æ•°ç»„çš„æ¯ä¸ªä½è¿›è¡Œæ£€æŸ¥çš„æƒ…å†µä¸‹ï¼Œç›´æ¥çŸ¥é“è¿™ä¸ªä½æ•°ç»„åŒ…å«äº†å¤šå°‘ä¸ªå€¼ä¸º1çš„äºŒè¿›åˆ¶ä½ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œå¯¹äº8ä½é•¿çš„ä½æ•°ç»„æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºè¡¨æ ¼22-1ï¼Œé€šè¿‡è¿™ä¸ªè¡¨æ ¼ï¼Œæˆ‘ä»¬å¯ä»¥ä¸€æ¬¡ä»ä½æ•°ç»„ä¸­è¯»å…¥8ä¸ªä½ï¼Œç„¶åæ ¹æ®è¿™8ä¸ªä½çš„å€¼è¿›è¡ŒæŸ¥è¡¨ï¼Œç›´æ¥çŸ¥é“è¿™ä¸ªå€¼åŒ…å«äº†å¤šå°‘ä¸ªå€¼ä¸º1çš„ä½ã€‚</p>
<p><img src="/..%5Cimg%5CRedis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%5C%E5%85%AB%E4%BD%8D%E4%BD%8D%E6%95%B0%E7%BB%84%E5%BB%BA%E8%A1%A8.png" alt="å…«ä½ä½æ•°ç»„å»ºè¡¨"></p>
<p>é€šè¿‡ä½¿ç”¨è¡¨22-1ï¼Œæˆ‘ä»¬åªéœ€æ‰§è¡Œä¸€æ¬¡æŸ¥è¡¨æ“ä½œï¼Œå°±å¯ä»¥æ£€æŸ¥8ä¸ªäºŒè¿›åˆ¶ä½ï¼Œå’Œä¹‹å‰ä»‹ç»çš„éå†ç®—æ³•ç›¸æ¯”,æŸ¥è¡¨æ³•çš„æ•ˆç‡æå‡äº†8å€ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ›´å¤§çš„è¡¨çš„è¯ï¼Œé‚£ä¹ˆæ¯æ¬¡æŸ¥è¡¨æ‰€èƒ½å¤„ç†çš„ä½å°±ä¼šæ›´å¤šï¼Œä»è€Œå‡å°‘æŸ¥è¡¨æ“ä½œæ‰§è¡Œçš„æ¬¡æ•°ã€‚</p>
<p>åˆçœ‹èµ·æ¥ï¼Œåªè¦æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªè¶³å¤Ÿå¤§çš„è¡¨ï¼Œé‚£ä¹ˆç»Ÿè®¡å·¥ä½œå°±å¯ä»¥è½»æ˜“åœ°å®Œæˆï¼Œä½†è¿™ä¸ªé—®é¢˜å®é™…ä¸Šå¹¶æ²¡æœ‰é‚£ä¹ˆç®€å•ï¼Œå› ä¸ºæŸ¥è¡¨æ³•çš„å®é™…æ•ˆæœä¼šå—åˆ°å†…å­˜å’Œç¼“å­˜ä¸¤æ–¹é¢å› ç´ çš„é™åˆ¶ï¼š</p>
<ul>
<li>å› ä¸ºæŸ¥è¡¨æ³•æ˜¯å…¸å‹çš„ç©ºé—´æ¢æ—¶é—´ç­–ç•¥ï¼Œç®—æ³•åœ¨è®¡ç®—æ–¹é¢èŠ‚çº¦çš„æ—¶é—´æ˜¯é€šè¿‡èŠ±è´¹é¢å¤–çš„å†…å­˜æ¢å–è€Œæ¥çš„ï¼ŒèŠ‚çº¦çš„æ—¶é—´è¶Šå¤šï¼ŒèŠ±è´¹çš„å†…å­˜å°±è¶Šå¤§ã€‚å¯¹äºæˆ‘ä»¬è¿™é‡Œè®¨è®ºçš„ç»Ÿè®¡äºŒè¿›åˆ¶ä½çš„é—®é¢˜æ¥è¯´ï¼Œåˆ›å»ºé”®é•¿ä¸º8ä½çš„è¡¨ä»…éœ€æ•°ç™¾ä¸ªå­—èŠ‚ï¼Œåˆ›å»ºé”®é•¿ä¸º16ä½çš„è¡¨ä¹Ÿä»…éœ€æ•°ç™¾ä¸ªKBï¼Œä½†åˆ›å»ºé”®é•¿ä¸º32ä½çš„è¡¨å´éœ€è¦åå¤šä¸ªGBã€‚åœ¨å®é™…ä¸­ï¼ŒæœåŠ¡å™¨åªå¯èƒ½æ¥å—æ•°ç™¾ä¸ªå­—èŠ‚æˆ–è€…æ•°ç™¾KBçš„å†…å­˜æ¶ˆè€—ã€‚</li>
<li>é™¤äº†å†…å­˜å¤§å°çš„é—®é¢˜ä¹‹å¤–ï¼ŒæŸ¥è¡¨æ³•çš„æ•ˆæœè¿˜ä¼šå—åˆ°CPUç¼“å­˜çš„é™åˆ¶ï¼šå¯¹äºå›ºå®šå¤§å°çš„CPUç¼“å­˜æ¥è¯´ï¼Œåˆ›å»ºçš„è¡¨æ ¼è¶Šå¤§ï¼ŒCPUç¼“å­˜æ‰€èƒ½ä¿å­˜çš„å†…å®¹ç›¸æ¯”æ•´ä¸ªè¡¨æ ¼çš„æ¯”ä¾‹å°±è¶Šå°‘ï¼ŒæŸ¥è¡¨æ—¶å‡ºç°ç¼“å­˜ä¸å‘½ä¸­ï¼ˆcache missï¼‰çš„æƒ…å†µå°±ä¼šè¶Šé«˜ï¼Œç¼“å­˜çš„æ¢å…¥å’Œæ¢å‡ºæ“ä½œå°±ä¼šè¶Šé¢‘ç¹ï¼Œæœ€ç»ˆå½±å“æŸ¥è¡¨æ³•çš„å®é™…æ•ˆç‡ã€‚</li>
</ul>
<p>ç”±äºä»¥ä¸Šåˆ—ä¸¾çš„ä¸¤ä¸ªåŸå› ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºï¼ŒæŸ¥è¡¨æ³•æ˜¯ä¸€ç§æ¯”éå†ç®—æ³•æ›´å¥½çš„ç»Ÿè®¡åŠæ³•ï¼Œä½†å—é™äºæŸ¥è¡¨æ³•å¸¦æ¥çš„å†…å­˜å‹åŠ›ï¼Œä»¥åŠç¼“å­˜ä¸å‘½ä¸­å¯èƒ½å¸¦æ¥çš„å½±å“ï¼Œæˆ‘ä»¬åªèƒ½è€ƒè™‘åˆ›å»ºé”®é•¿ä¸º8ä½æˆ–è€…é”®é•¿ä¸º16ä½çš„è¡¨ï¼Œè€Œè¿™ä¸¤ç§è¡¨å¸¦æ¥çš„æ•ˆç‡æå‡ï¼Œå¯¹äºå¤„ç†éå¸¸é•¿çš„ä½æ•°ç»„æ¥è¯´ä»ç„¶è¿œè¿œä¸å¤Ÿã€‚</p>
<p>ä¸ºäº†é«˜æ•ˆåœ°å®ç°BITCOUNTå‘½ä»¤ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§ä¸ä¼šå¸¦æ¥å†…å­˜å‹åŠ›ã€å¹¶ä¸”å¯ä»¥åœ¨ä¸€æ¬¡æ£€æŸ¥ä¸­ç»Ÿè®¡å¤šä¸ªäºŒè¿›åˆ¶ä½çš„ç®—æ³•ï¼Œæ¥ä¸‹æ¥è¦ä»‹ç»çš„variable-precision SWARç®—æ³•å°±æ˜¯è¿™æ ·ä¸€ç§ç®—æ³•ã€‚</p>
<h4 id="äºŒè¿›åˆ¶ä½ç»Ÿè®¡ç®—æ³•ï¼ˆ3ï¼‰ï¼švariable-precision-SWARç®—æ³•"><a href="#äºŒè¿›åˆ¶ä½ç»Ÿè®¡ç®—æ³•ï¼ˆ3ï¼‰ï¼švariable-precision-SWARç®—æ³•" class="headerlink" title="äºŒè¿›åˆ¶ä½ç»Ÿè®¡ç®—æ³•ï¼ˆ3ï¼‰ï¼švariable-precision SWARç®—æ³•"></a>äºŒè¿›åˆ¶ä½ç»Ÿè®¡ç®—æ³•ï¼ˆ3ï¼‰ï¼švariable-precision SWARç®—æ³•</h4><p>BITCOUNTå‘½ä»¤è¦è§£å†³çš„é—®é¢˜â€”â€”ç»Ÿè®¡ä¸€ä¸ªä½æ•°ç»„ä¸­é0äºŒè¿›åˆ¶ä½çš„æ•°é‡ï¼Œåœ¨æ•°å­¦ä¸Šè¢«ç§°ä¸ºâ€œè®¡ç®—æ±‰æ˜é‡é‡ï¼ˆHamming Weightï¼‰â€ã€‚</p>
<p>å› ä¸ºæ±‰æ˜é‡é‡ç»å¸¸è¢«ç”¨äºä¿¡æ¯è®ºã€ç¼–ç ç†è®ºå’Œå¯†ç å­¦ï¼Œæ‰€ä»¥ç ”ç©¶äººå‘˜é’ˆå¯¹è®¡ç®—æ±‰æ˜é‡é‡å¼€å‘äº†å¤šç§ä¸åŒçš„ç®—æ³•ï¼Œä¸€äº›å¤„ç†å™¨ç”šè‡³ç›´æ¥å¸¦æœ‰è®¡ç®—æ±‰æ˜é‡é‡çš„æŒ‡ä»¤ï¼Œè€Œå¯¹äºä¸å…·å¤‡è¿™ç§ç‰¹æ®ŠæŒ‡ä»¤çš„æ™®é€šå¤„ç†å™¨æ¥è¯´ï¼Œç›®å‰å·²çŸ¥æ•ˆç‡æœ€å¥½çš„é€šç”¨ç®—æ³•ä¸ºvariable-precision SWARç®—æ³•ï¼Œè¯¥ç®—æ³•é€šè¿‡ä¸€ç³»åˆ—ä½ç§»å’Œä½è¿ç®—æ“ä½œï¼Œå¯ä»¥åœ¨å¸¸æ•°æ—¶é—´å†…è®¡ç®—å¤šä¸ªå­—èŠ‚çš„æ±‰æ˜é‡é‡ï¼Œå¹¶ä¸”ä¸éœ€è¦ä½¿ç”¨ä»»ä½•é¢å¤–çš„å†…å­˜ã€‚</p>
<p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªå¤„ç†32ä½é•¿åº¦ä½æ•°ç»„çš„variable-precision SWARç®—æ³•çš„å®ç°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint32_t</span> <span class="title function_">swar</span><span class="params">(<span class="type">uint32_t</span> i)</span> &#123;</span><br><span class="line">	<span class="comment">//æ­¥éª¤1</span></span><br><span class="line">	i = (i &amp; <span class="number">0x55555555</span>) + ((i &gt;&gt; <span class="number">1</span>) &amp; <span class="number">0x55555555</span>);</span><br><span class="line">	<span class="comment">//æ­¥éª¤2</span></span><br><span class="line">	i = (i &amp; <span class="number">0x33333333</span>) + ((i &gt;&gt; <span class="number">2</span>) &amp; <span class="number">0x33333333</span>);</span><br><span class="line">	<span class="comment">//æ­¥éª¤3</span></span><br><span class="line">	i = (i &amp; <span class="number">0x0F0F0F0F</span>) + ((i &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0x0F0F0F0F</span>);</span><br><span class="line">	<span class="comment">//æ­¥éª¤4</span></span><br><span class="line">	i = (i * (<span class="number">0x01010101</span>) &gt;&gt; <span class="number">24</span>);</span><br><span class="line">	<span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸‹æ˜¯è°ƒç”¨swar (bitarray)çš„æ‰§è¡Œæ­¥éª¤ï¼š</p>
<ul>
<li>æ­¥éª¤1è®¡ç®—å‡ºçš„å€¼içš„äºŒè¿›åˆ¶è¡¨ç¤ºå¯ä»¥æŒ‰æ¯ä¸¤ä¸ªäºŒè¿›åˆ¶ä½ä¸ºä¸€ç»„è¿›è¡Œåˆ†ç»„ï¼Œå„ç»„çš„åè¿›åˆ¶è¡¨ç¤ºå°±æ˜¯è¯¥ç»„çš„æ±‰æ˜é‡é‡ã€‚</li>
<li>æ­¥éª¤2è®¡ç®—å‡ºçš„å€¼içš„äºŒè¿›åˆ¶è¡¨ç¤ºå¯ä»¥æŒ‰æ¯å››ä¸ªäºŒè¿›åˆ¶ä½ä¸ºä¸€ç»„è¿›è¡Œåˆ†ç»„ï¼Œå„ç»„çš„åè¿›åˆ¶è¡¨ç¤ºå°±æ˜¯è¯¥ç»„çš„æ±‰æ˜é‡é‡ã€‚</li>
<li>æ­¥éª¤3è®¡ç®—å‡ºçš„å€¼içš„äºŒè¿›åˆ¶è¡¨ç¤ºå¯ä»¥æŒ‰æ¯å…«ä¸ªäºŒè¿›åˆ¶ä½ä¸ºä¸€ç»„è¿›è¡Œåˆ†ç»„ï¼Œå„ç»„çš„åè¿›åˆ¶è¡¨ç¤ºå°±æ˜¯è¯¥ç»„çš„æ±‰æ˜é‡é‡ã€‚</li>
<li>æ­¥éª¤4çš„i * 0x01010101è¯­å¥è®¡ç®—å‡ºbitarrayçš„æ±‰æ˜é‡é‡å¹¶è®°å½•åœ¨äºŒè¿›åˆ¶ä½çš„æœ€é«˜å…«ä½ï¼Œè€Œ&gt;&gt;24è¯­å¥åˆ™é€šè¿‡å³ç§»è¿ç®—ï¼Œå°†bitarrayçš„æ±‰æ˜é‡é‡ç§»åŠ¨åˆ°æœ€ä½å…«ä½ï¼Œå¾—å‡ºçš„ç»“æœå°±æ˜¯bitarrayçš„æ±‰æ˜é‡é‡ã€‚</li>
</ul>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œå¯¹äºè°ƒç”¨swar(0x3A70F21B)ï¼Œç¨‹åºåœ¨ç¬¬ä¸€æ­¥å°†è®¡ç®—å‡ºå€¼0x2560A116ï¼Œè¿™ä¸ªå€¼çš„æ¯ä¸¤ä¸ªäºŒè¿›åˆ¶ä½çš„åè¿›åˆ¶è¡¨ç¤ºè®°å½•äº†0x3A70F21Bæ¯ä¸¤ä¸ªäºŒè¿›åˆ¶ä½çš„æ±‰æ˜é‡é‡ï¼Œå¦‚è¡¨22-2æ‰€ç¤ºã€‚</p>
<p><img src="/..%5Cimg%5CRedis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%5C%E4%BA%8C%E8%BF%9B%E5%88%B6%E4%B8%A4%E4%BD%8D%E5%88%86%E7%BB%84%E4%B8%8B%E7%9A%84%E6%B1%89%E6%98%8E%E9%87%8D%E9%87%8F.png" alt="äºŒè¿›åˆ¶ä¸¤ä½åˆ†ç»„ä¸‹çš„æ±‰æ˜é‡é‡.png"></p>
<p>ä¹‹åï¼Œç¨‹åºåœ¨ç¬¬äºŒæ­¥å°†è®¡ç®—å‡ºå€¼0x22304113ï¼Œè¿™ä¸ªå€¼çš„æ¯å››ä¸ªäºŒè¿›åˆ¶ä½çš„åè¿›åˆ¶è¡¨ç¤ºè®°å½•äº†0x3A70F21Bæ¯å››ä¸ªäºŒè¿›åˆ¶ä½çš„æ±‰æ˜é‡é‡ï¼Œå¦‚è¡¨22-3æ‰€ç¤ºã€‚</p>
<p><img src="/..%5Cimg%5CRedis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%5C%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%9B%9B%E4%BD%8D%E5%88%86%E7%BB%84%E4%B8%8B%E7%9A%84%E6%B1%89%E6%98%8E%E9%87%8D%E9%87%8F.png" alt="äºŒè¿›åˆ¶å››ä½åˆ†ç»„ä¸‹çš„æ±‰æ˜é‡é‡.png"></p>
<p>æ¥ä¸‹æ¥ï¼Œç¨‹åºåœ¨ç¬¬ä¸‰æ­¥å°†è®¡ç®—å‡ºå€¼0x4030504ï¼Œè¿™ä¸ªå€¼çš„æ¯å…«ä¸ªäºŒè¿›åˆ¶ä½çš„åè¿›åˆ¶è¡¨ç¤ºè®°å½•äº†0x3A70F21Bæ¯å…«ä¸ªäºŒè¿›åˆ¶ä½çš„æ±‰æ˜é‡é‡ï¼Œå¦‚è¡¨22-4æ‰€ç¤ºã€‚</p>
<p><img src="/..%5Cimg%5CRedis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%5C%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%85%AB%E4%BD%8D%E5%88%86%E7%BB%84%E4%B8%8B%E7%9A%84%E6%B1%89%E6%98%8E%E9%87%8D%E9%87%8F.png" alt="äºŒè¿›åˆ¶å…«ä½åˆ†ç»„ä¸‹çš„æ±‰æ˜é‡é‡.png"></p>
<p>åœ¨ç¬¬å››æ­¥ï¼Œç¨‹åºé¦–å…ˆè®¡ç®—0x4030504 * 0x01010101 &#x3D; 0x100c0904ï¼Œå°†æ±‰æ˜é‡é‡èšé›†åˆ°äºŒè¿›åˆ¶ä½çš„æœ€é«˜å…«ä½ã€‚ä¹‹åç¨‹åºè®¡ç®—0x100c0904 &gt;&gt; 24ï¼Œå°†æ±‰æ˜é‡é‡ç§»åŠ¨åˆ°ä½å…«ä½ï¼Œæœ€ç»ˆå¾—å‡ºå€¼0x10ï¼Œä¹Ÿå³æ˜¯åè¿›åˆ¶å€¼16ï¼Œè¿™ä¸ªå€¼å°±æ˜¯0x3A70F21Bçš„æ±‰æ˜é‡é‡ï¼Œå¦‚è¡¨22-6æ‰€ç¤ºã€‚</p>
<p><img src="/..%5Cimg%5CRedis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%5C%E4%BA%8C%E8%BF%9B%E5%88%B6%E7%A7%BB%E4%BD%8D%E5%90%8E%E7%9A%84%E6%B1%89%E6%98%8E%E9%87%8D%E9%87%8F.png" alt="äºŒè¿›åˆ¶ç§»ä½åçš„æ±‰æ˜é‡é‡.png"></p>
<p>swarå‡½æ•°æ¯æ¬¡æ‰§è¡Œå¯ä»¥è®¡ç®—32ä¸ªäºŒè¿›åˆ¶ä½çš„æ±‰æ˜é‡é‡ï¼Œå®ƒæ¯”ä¹‹å‰ä»‹ç»çš„éå†ç®—æ³•è¦å¿«32å€ï¼Œæ¯”é”®é•¿ä¸º8ä½çš„æŸ¥è¡¨æ³•å¿«4å€ï¼Œæ¯”é”®é•¿ä¸º16ä½çš„æŸ¥è¡¨æ³•å¿«2å€ï¼Œå¹¶ä¸”å› ä¸ºswarå‡½æ•°æ˜¯å•çº¯çš„è®¡ç®—æ“ä½œï¼Œæ‰€ä»¥å®ƒæ— é¡»åƒæŸ¥è¡¨æ³•é‚£æ ·ï¼Œä½¿ç”¨é¢å¤–çš„å†…å­˜ã€‚</p>
<p>å¦å¤–ï¼Œå› ä¸ºswarå‡½æ•°æ˜¯ä¸€ä¸ªå¸¸æ•°å¤æ‚åº¦çš„æ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŒ‰ç…§è‡ªå·±çš„éœ€è¦ï¼Œåœ¨ä¸€æ¬¡å¾ªç¯ä¸­å¤šæ¬¡æ‰§è¡Œswarï¼Œä»è€ŒæŒ‰å€æ•°æå‡è®¡ç®—æ±‰æ˜é‡é‡çš„æ•ˆç‡ï¼š</p>
<ul>
<li>ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬åœ¨ä¸€æ¬¡å¾ªç¯ä¸­è°ƒç”¨ä¸¤æ¬¡swarå‡½æ•°ï¼Œé‚£ä¹ˆè®¡ç®—æ±‰æ˜é‡é‡çš„æ•ˆç‡å°±ä»ä¹‹å‰çš„ä¸€æ¬¡å¾ªç¯è®¡ç®—32ä½æå‡åˆ°äº†ä¸€æ¬¡å¾ªç¯è®¡ç®—64ä½ã€‚</li>
<li>åˆä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬åœ¨ä¸€æ¬¡å¾ªç¯ä¸­è°ƒç”¨å››æ¬¡swarå‡½æ•°ï¼Œé‚£ä¹ˆä¸€æ¬¡å¾ªç¯å°±å¯ä»¥è®¡ç®—128ä¸ªäºŒè¿›åˆ¶ä½çš„æ±‰æ˜é‡é‡ï¼Œè¿™æ¯”æ¯æ¬¡å¾ªç¯åªè°ƒç”¨ä¸€æ¬¡swarå‡½æ•°è¦å¿«å››å€ï¼</li>
</ul>
<p>å½“ç„¶ï¼Œåœ¨ä¸€ä¸ªå¾ªç¯é‡Œæ‰§è¡Œå¤šä¸ªswarè°ƒç”¨è¿™ç§ä¼˜åŒ–æ–¹å¼æ˜¯æœ‰æé™çš„ï¼šä¸€æ—¦å¾ªç¯ä¸­å¤„ç†çš„ä½æ•°ç»„çš„å¤§å°è¶…è¿‡äº†ç¼“å­˜çš„å¤§å°ï¼Œè¿™ç§ä¼˜åŒ–çš„æ•ˆæœå°±ä¼šé™ä½å¹¶æœ€ç»ˆæ¶ˆå¤±ã€‚</p>
<h4 id="äºŒè¿›åˆ¶ä½ç»Ÿè®¡ç®—æ³•ï¼ˆ4ï¼‰ï¼šRedisçš„å®ç°"><a href="#äºŒè¿›åˆ¶ä½ç»Ÿè®¡ç®—æ³•ï¼ˆ4ï¼‰ï¼šRedisçš„å®ç°" class="headerlink" title="äºŒè¿›åˆ¶ä½ç»Ÿè®¡ç®—æ³•ï¼ˆ4ï¼‰ï¼šRedisçš„å®ç°"></a>äºŒè¿›åˆ¶ä½ç»Ÿè®¡ç®—æ³•ï¼ˆ4ï¼‰ï¼šRedisçš„å®ç°</h4><p>BITCOUNTå‘½ä»¤çš„å®ç°ç”¨åˆ°äº†æŸ¥è¡¨å’Œvariable-precision SWARä¸¤ç§ç®—æ³•ï¼š</p>
<ul>
<li>æŸ¥è¡¨ç®—æ³•ä½¿ç”¨é”®é•¿ä¸º8ä½çš„è¡¨ï¼Œè¡¨ä¸­è®°å½•äº†ä»0000 0000åˆ°1111 1111åœ¨å†…çš„æ‰€æœ‰äºŒè¿›åˆ¶ä½çš„æ±‰æ˜é‡é‡ã€‚</li>
<li>è‡³äºvariable-precision SWARç®—æ³•æ–¹é¢ï¼ŒBITCOUNTå‘½ä»¤åœ¨æ¯æ¬¡å¾ªç¯ä¸­è½½å…¥128ä¸ªäºŒè¿›åˆ¶ä½ï¼Œç„¶åè°ƒç”¨å››æ¬¡32ä½variable-precision SWARç®—æ³•æ¥è®¡ç®—è¿™128ä¸ªäºŒè¿›åˆ¶ä½çš„æ±‰æ˜é‡é‡ã€‚</li>
</ul>
<p>åœ¨æ‰§è¡ŒBITCOUNTå‘½ä»¤æ—¶ï¼Œç¨‹åºä¼šæ ¹æ®æœªå¤„ç†çš„äºŒè¿›åˆ¶ä½çš„æ•°é‡æ¥å†³å®šä½¿ç”¨é‚£ç§ç®—æ³•ï¼š</p>
<ul>
<li>å¦‚æœæœªå¤„ç†çš„äºŒè¿›åˆ¶ä½çš„æ•°é‡å¤§äºç­‰äº128ä½ï¼Œé‚£ä¹ˆç¨‹åºä½¿ç”¨variable-precision SWARç®—æ³•æ¥è®¡ç®—äºŒè¿›åˆ¶ä½çš„æ±‰æ˜é‡é‡ã€‚</li>
<li>å¦‚æœæœªå¤„ç†çš„äºŒè¿›åˆ¶ä½çš„æ•°é‡å°äº128ä½ï¼Œé‚£ä¹ˆç¨‹åºä½¿ç”¨æŸ¥è¡¨ç®—æ³•æ¥è®¡ç®—äºŒè¿›åˆ¶ä½çš„æ±‰æ˜é‡é‡ã€‚</li>
</ul>
<p>ä»¥ä¸‹ä¼ªä»£ç å±•ç¤ºäº†BITCOUNTå‘½ä»¤çš„å®ç°åŸç†ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"># ä¸€ä¸ªè¡¨ï¼Œè®°å½•äº†æ‰€æœ‰å…«ä½é•¿ä½æ•°ç»„çš„æ±‰æ˜é‡é‡</span><br><span class="line"># ç¨‹åºå°†8ä½é•¿çš„ä½æ•°ç»„è½¬æ¢æˆæ— ç¬¦å·æ•´æ•°ï¼Œå¹¶åœ¨è¡¨ä¸­è¿›è¡Œç´¢å¼•</span><br><span class="line"># ä¾‹å¦‚ï¼Œå¯¹äºè¾“å…¥0000 0011ï¼Œç¨‹åºå°†äºŒè¿›åˆ¶è½¬æ¢ä¸ºæ— ç¬¦å·æ•´æ•°3</span><br><span class="line"># ç„¶åå–å‡ºweight_in_byte[3]çš„å€¼2</span><br><span class="line"># 2å°±æ˜¯0000 0011çš„æ±‰æ˜é‡é‡</span><br><span class="line">weight_in_byte = [0,1,1,2,1,2,2,/*...*/,7,7,8]</span><br><span class="line"></span><br><span class="line">def BITCOUNT(bits):</span><br><span class="line">	# è®¡ç®—ä½æ•°ç»„åŒ…å«äº†å¤šå°‘ä¸ªäºŒè¿›åˆ¶ä½</span><br><span class="line">	count = count_bit(bits)</span><br><span class="line">	# åˆå§‹åŒ–æ±‰æ˜é‡é‡ä¸ºé›¶</span><br><span class="line">	weight = 0</span><br><span class="line">	# å¦‚æœæœªå¤„ç†çš„äºŒè¿›åˆ¶ä½å¤§äºç­‰äº128ä½</span><br><span class="line">	# é‚£ä¹ˆä½¿ç”¨variable-precision SWARç®—æ³•æ¥å¤„ç†</span><br><span class="line">	while count &gt;= 128:</span><br><span class="line">		# å››ä¸ªswarè°ƒç”¨ï¼Œæ¯ä¸ªè°ƒç”¨è®¡ç®—32ä¸ªäºŒè¿›åˆ¶ä½çš„æ±‰æ˜é‡é‡</span><br><span class="line">		# æ³¨æ„:bits[i:j]ä¸­çš„ç´¢å¼•jæ˜¯ä¸åŒ…å«åœ¨å–å€¼èŒƒå›´ä¹‹å†…çš„</span><br><span class="line">		weight += swar(bits[0:32])</span><br><span class="line">		weight += swar(bits[32:64])</span><br><span class="line">		weight += swar(bits[64:96])</span><br><span class="line">		weight += swar(bits[96:128])</span><br><span class="line"></span><br><span class="line">		# ç§»åŠ¨æŒ‡é’ˆï¼Œç•¥è¿‡å·²å¤„ç†çš„ä½ï¼ŒæŒ‡å‘æœªå¤„ç†çš„ä½</span><br><span class="line">		bits = bits [128:]</span><br><span class="line">		# å‡å°‘æœªå¤„ç†ä½çš„é•¿åº¦</span><br><span class="line">		count -= 128</span><br><span class="line">	# å¦‚æœæ‰§è¡Œåˆ°è¿™é‡Œ,è¯´æ˜æœªå¤„ç†çš„ä½æ•°é‡ä¸è¶³128ä½</span><br><span class="line">	# é‚£ä¹ˆä½¿ç”¨æŸ¥è¡¨æ³•æ¥è®¡ç®—æ±‰æ˜é‡é‡</span><br><span class="line">	while count:</span><br><span class="line">		# å°†8ä¸ªä½è½¬æ¢æˆæ— ç¬¦å·æ•´æ•°ï¼Œä½œä¸ºæŸ¥è¡¨çš„ç´¢å¼•(é”®)</span><br><span class="line">		index = bits_to_unsigned_int(bits[0:8])</span><br><span class="line">		weight += weight_in_byte[index]</span><br><span class="line"></span><br><span class="line">		# ç§»åŠ¨æŒ‡é’ˆï¼Œç•¥è¿‡å·²å¤„ç†çš„ä½ï¼ŒæŒ‡å‘æœªå¤„ç†çš„ä½</span><br><span class="line">		bits = bits[8:]</span><br><span class="line">		#å‡å°‘æœªå¤„ç†ä½çš„é•¿åº¦</span><br><span class="line">		count -= 8</span><br><span class="line">	# è®¡ç®—å®Œæ¯•ï¼Œè¿”å›è¾“å…¥äºŒè¿›åˆ¶ä½çš„æ±‰æ˜é‡é‡</span><br><span class="line">	return weight</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªBITCOUNTå®ç°çš„ç®—æ³•å¤æ‚åº¦ä¸ºO(n)ï¼Œå…¶ä¸­nä¸ºè¾“äººäºŒè¿›åˆ¶ä½çš„æ•°é‡ã€‚</p>
<p>æ›´å…·ä½“ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä»¥ä¸‹å…¬å¼æ¥è®¡ç®—BITCOUNTå‘½ä»¤åœ¨å¤„ç†é•¿åº¦ä¸ºnçš„äºŒè¿›åˆ¶ä½è¾“å…¥æ—¶ï¼Œå‘½ä»¤ä¸­çš„ä¸¤ä¸ªå¾ªç¯éœ€è¦æ‰§è¡Œçš„æ¬¡æ•°ï¼š</p>
<ul>
<li>ç¬¬ä¸€ä¸ªå¾ªç¯çš„æ‰§è¡Œæ¬¡æ•°å¯ä»¥ç”¨å…¬å¼loop1 &#x3D; âŒŠn Ã· 128âŒ‹è®¡ç®—å¾—å‡ºã€‚</li>
<li>ç¬¬äºŒä¸ªå¾ªç¯çš„æ‰§è¡Œæ¬¡æ•°å¯ä»¥ç”¨å…¬å¼loop2 &#x3D; n mod 128è®¡ç®—å¾—å‡ºã€‚</li>
</ul>
<p>ä»¥100 MB &#x3D; 800 000 000 bitæ¥è®¡ç®—ï¼ŒBITCOUNTå‘½ä»¤å¤„ç†ä¸€ä¸ª100 MBé•¿çš„ä½æ•°ç»„å…±éœ€è¦æ‰§è¡Œç¬¬ä¸€ä¸ªå¾ªç¯å…­ç™¾äºŒåäº”ä¸‡æ¬¡ï¼Œç¬¬äºŒä¸ªå¾ªç¯é›¶æ¬¡ã€‚ä»¥500 MB &#x3D; 4 000 000 000 bitæ¥è®¡ç®—ï¼ŒBITCOUNTå‘½ä»¤å¤„ç†ä¸€ä¸ª500 MBé•¿çš„ä½æ•°ç»„å…±éœ€è¦æ‰§è¡Œç¬¬ä¸€ä¸ªå¾ªç¯ä¸‰åƒä¸€ç™¾äºŒåäº”ä¸‡æ¬¡ï¼Œç¬¬äºŒä¸ªå¾ªç¯é›¶æ¬¡ã€‚</p>
<p>é€šè¿‡ä½¿ç”¨æ›´å¥½çš„ç®—æ³•ï¼Œæˆ‘ä»¬å°†è®¡ç®—100 MBå’Œ500 MBé•¿çš„äºŒè¿›åˆ¶ä½æ‰€éœ€çš„å¾ªç¯æ¬¡æ•°ä»æœ€å¼€å§‹ä½¿ç”¨éå†ç®—æ³•æ—¶çš„æ•°äº¿ç”šè‡³æ•°åäº¿æ¬¡å‡å°‘åˆ°äº†æ•°ç™¾ä¸‡æ¬¡å’Œæ•°åƒä¸‡æ¬¡ã€‚</p>
<h3 id="BITOPå‘½ä»¤çš„å®ç°"><a href="#BITOPå‘½ä»¤çš„å®ç°" class="headerlink" title="BITOPå‘½ä»¤çš„å®ç°"></a>BITOPå‘½ä»¤çš„å®ç°</h3><p>å› ä¸ºCè¯­è¨€ç›´æ¥æ”¯æŒå¯¹å­—èŠ‚æ‰§è¡Œé€»è¾‘ä¸(&amp;)ã€é€»è¾‘æˆ–(|)ã€é€»è¾‘å¼‚æˆ–(^)å’Œé€»è¾‘é(~)æ“ä½œï¼Œæ‰€ä»¥BITOPå‘½ä»¤çš„ANDã€ORã€XORå’ŒNOTå››ä¸ªæ“ä½œéƒ½æ˜¯ç›´æ¥åŸºäºè¿™äº›é€»è¾‘æ“ä½œå®ç°çš„ï¼š</p>
<ul>
<li>åœ¨æ‰§è¡ŒBITOP ANDå‘½ä»¤æ—¶ï¼Œç¨‹åºç”¨&amp;æ“ä½œè®¡ç®—å‡ºæ‰€æœ‰è¾“äººäºŒè¿›åˆ¶ä½çš„é€»è¾‘ä¸ç»“æœï¼Œç„¶åä¿å­˜åœ¨æŒ‡å®šçš„é”®ä¸Šé¢ã€‚</li>
<li>åœ¨æ‰§è¡ŒBITOP ORå‘½ä»¤æ—¶ï¼Œç¨‹åºç”¨|æ“ä½œè®¡ç®—å‡ºæ‰€æœ‰è¾“å…¥äºŒè¿›åˆ¶ä½çš„é€»è¾‘æˆ–ç»“æœï¼Œç„¶åä¿å­˜åœ¨æŒ‡å®šçš„é”®ä¸Šé¢ã€‚</li>
<li>åœ¨æ‰§è¡ŒBITOP XORå‘½ä»¤æ—¶ï¼Œç¨‹åºç”¨^æ“ä½œè®¡ç®—å‡ºæ‰€æœ‰è¾“äººäºŒè¿›åˆ¶ä½çš„é€»è¾‘å¼‚æˆ–ç»“æœï¼Œç„¶åä¿å­˜åœ¨æŒ‡å®šçš„é”®ä¸Šé¢ã€‚</li>
<li>åœ¨æ‰§è¡ŒBITOP NOTå‘½ä»¤æ—¶ï¼Œç¨‹åºç”¨ï½æ“ä½œè®¡ç®—å‡ºè¾“äººäºŒè¿›åˆ¶ä½çš„é€»è¾‘éç»“æœï¼Œç„¶åä¿å­˜åœ¨æŒ‡å®šçš„é”®ä¸Šé¢ã€‚</li>
</ul>
<p>å› ä¸ºBITOP ANDã€BITOP ORã€BITOP XORä¸‰ä¸ªå‘½ä»¤å¯ä»¥æ¥å—å¤šä¸ªä½æ•°ç»„ä½œä¸ºè¾“äººï¼Œç¨‹åºéœ€è¦éå†è¾“äººçš„æ¯ä¸ªä½æ•°ç»„çš„æ¯ä¸ªå­—èŠ‚æ¥è¿›è¡Œè®¡ç®—ï¼Œæ‰€ä»¥è¿™äº›å‘½ä»¤çš„å¤æ‚åº¦ä¸ºo(n^2)ï¼›ä¸æ­¤ç›¸åï¼Œå› ä¸ºBITOP NOTå‘½ä»¤åªæ¥å—ä¸€ä¸ªä½æ•°ç»„è¾“å…¥ï¼Œæ‰€ä»¥å®ƒçš„å¤æ‚åº¦ä¸ºO(n)ã€‚</p>
<h2 id="æ…¢æŸ¥è¯¢æ—¥å¿—"><a href="#æ…¢æŸ¥è¯¢æ—¥å¿—" class="headerlink" title="æ…¢æŸ¥è¯¢æ—¥å¿—"></a>æ…¢æŸ¥è¯¢æ—¥å¿—</h2><p>Redisçš„æ…¢æŸ¥è¯¢æ—¥å¿—åŠŸèƒ½ç”¨äºè®°å½•æ‰§è¡Œæ—¶é—´è¶…è¿‡ç»™å®šæ—¶é•¿çš„å‘½ä»¤è¯·æ±‚ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡è¿™ä¸ªåŠŸèƒ½äº§ç”Ÿçš„æ—¥å¿—æ¥ç›‘è§†å’Œä¼˜åŒ–æŸ¥è¯¢é€Ÿåº¦ã€‚</p>
<p>æœåŠ¡å™¨é…ç½®æœ‰ä¸¤ä¸ªå’Œæ…¢æŸ¥è¯¢æ—¥å¿—ç›¸å…³çš„é€‰é¡¹ï¼š</p>
<ul>
<li>slowlog-log-slower-thané€‰é¡¹æŒ‡å®šæ‰§è¡Œæ—¶é—´è¶…è¿‡å¤šå°‘å¾®ç§’ï¼ˆ1ç§’ç­‰äº1 000 000å¾®ç§’ï¼‰çš„å‘½ä»¤è¯·æ±‚ä¼šè¢«è®°å½•åˆ°æ—¥å¿—ä¸Šã€‚</li>
<li>slowlog-max-lené€‰é¡¹æŒ‡å®šæœåŠ¡å™¨æœ€å¤šä¿å­˜å¤šå°‘æ¡æ…¢æŸ¥è¯¢æ—¥å¿—ã€‚æœåŠ¡å™¨ä½¿ç”¨å…ˆè¿›å…ˆå‡ºçš„æ–¹å¼ä¿å­˜å¤šæ¡æ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œå½“æœåŠ¡å™¨å­˜å‚¨çš„æ…¢æŸ¥è¯¢æ—¥å¿—æ•°é‡ç­‰äºslowlog-max-lené€‰é¡¹çš„å€¼æ—¶ï¼ŒæœåŠ¡å™¨åœ¨æ·»åŠ ä¸€æ¡æ–°çš„æ…¢æŸ¥è¯¢æ—¥å¿—ä¹‹å‰ï¼Œä¼šå…ˆå°†æœ€æ—§çš„ä¸€æ¡æ…¢æŸ¥è¯¢æ—¥å¿—åˆ é™¤ã€‚</li>
</ul>
<h3 id="æ…¢æŸ¥è¯¢è®°å½•çš„ä¿å­˜"><a href="#æ…¢æŸ¥è¯¢è®°å½•çš„ä¿å­˜" class="headerlink" title="æ…¢æŸ¥è¯¢è®°å½•çš„ä¿å­˜"></a>æ…¢æŸ¥è¯¢è®°å½•çš„ä¿å­˜</h3><p>æœåŠ¡å™¨çŠ¶æ€ä¸­åŒ…å«äº†å‡ ä¸ªå’Œæ…¢æŸ¥è¯¢æ—¥å¿—åŠŸèƒ½æœ‰å…³çš„å±æ€§ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">redisServer</span> &#123;</span></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	</span><br><span class="line">    <span class="comment">//ä¸‹ä¸€æ¡æ…¢æŸ¥è¯¢æ—¥å¿—çš„ID</span></span><br><span class="line">	<span class="type">long</span> <span class="type">long</span> slowlog_entry_id;</span><br><span class="line">    <span class="comment">//ä¿å­˜äº†æ‰€æœ‰æ…¢æŸ¥è¯¢æ—¥å¿—çš„é“¾è¡¨</span></span><br><span class="line">    <span class="built_in">list</span> *slowlog;</span><br><span class="line">	<span class="comment">//æœåŠ¡å™¨é…ç½®slowlog-log-slower-thané€‰é¡¹çš„å€¼</span></span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> slowlog_log_slower_than;</span><br><span class="line">	<span class="comment">//æœåŠ¡å™¨é…ç½®slowlog-max-lené€‰é¡¹çš„å€¼</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> slowlog_max_len;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


<p>slowlog_entry_idå±æ€§çš„åˆå§‹å€¼ä¸º0ï¼Œæ¯å½“åˆ›å»ºä¸€æ¡æ–°çš„æ…¢æŸ¥è¯¢æ—¥å¿—æ—¶ï¼Œè¿™ä¸ªå±æ€§çš„å€¼å°±ä¼šç”¨ä½œæ–°æ—¥å¿—çš„idå€¼ï¼Œä¹‹åç¨‹åºä¼šå¯¹è¿™ä¸ªå±æ€§çš„å€¼å¢ä¸€ã€‚</p>
<p>ä¾‹å¦‚ï¼Œåœ¨åˆ›å»ºç¬¬ä¸€æ¡æ…¢æŸ¥è¯¢æ—¥å¿—æ—¶ï¼Œslowlog_entry_idçš„å€¼0ä¼šæˆä¸ºç¬¬ä¸€æ¡æ…¢æŸ¥è¯¢æ—¥å¿—çš„IDï¼Œè€Œä¹‹åæœåŠ¡å™¨ä¼šå¯¹è¿™ä¸ªå±æ€§çš„å€¼å¢ä¸€ï¼›å½“æœåŠ¡å™¨å†åˆ›å»ºæ–°çš„æ…¢æŸ¥è¯¢æ—¥å¿—çš„æ—¶å€™ï¼Œslowlog_entry_idçš„å€¼1å°±ä¼šæˆä¸ºç¬¬äºŒæ¡æ…¢æŸ¥æ¶¦æ—¥å¿—çš„IDï¼Œç„¶çŸ³æœåŠ¡å™¨å†æ¬¡å¯¹è¿™ä¸ªå±æ€§çš„å€¼å¢ä¸€ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p>
<p>slowlogé“¾è¡¨ä¿å­˜äº†æœåŠ¡å™¨ä¸­çš„æ‰€æœ‰æ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œé“¾è¡¨ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¿å­˜äº†ä¸€ä¸ªslowlogEntryç»“æ„ï¼Œæ¯ä¸ªslowlogEntryç»“æ„ä»£è¡¨ä¸€æ¡æ…¢æŸ¥è¯¢æ—¥å¿—ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">slowlogEntry</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//å”¯ä¸€æ ‡è¯†ç¬¦</span></span><br><span class="line">	<span class="type">long</span> <span class="type">long</span> id;</span><br><span class="line">	<span class="comment">//å‘½ä»¤æ‰§è¡Œæ—¶çš„æ—¶é—´ï¼Œæ ¼å¼ä¸ºUNIXæ—¶é—´æˆ³</span></span><br><span class="line">    <span class="type">time_t</span> time;</span><br><span class="line">	<span class="comment">//æ‰§è¡Œå‘½ä»¤æ¶ˆè€—çš„æ—¶é—´ï¼Œä»¥å¾®ç§’ä¸ºå•ä½</span></span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> duration;</span><br><span class="line">	<span class="comment">//å‘½ä»¤ä¸å‘½ä»¤å‚æ•°</span></span><br><span class="line">	robj **argv;</span><br><span class="line">	<span class="comment">//å‘½ä»¤ä¸å‘½ä»¤å‚æ•°çš„æ•°é‡</span></span><br><span class="line">    <span class="type">int</span> argc;</span><br><span class="line">    </span><br><span class="line">&#125; slowlogEntry;</span><br></pre></td></tr></table></figure>

<p><img src="/..%5Cimg%5CRedis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%5C%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97%E7%BB%93%E6%9E%84%E7%A4%BA%E4%BE%8B.png" alt="æ…¢æŸ¥è¯¢æ—¥å¿—ç»“æ„ç¤ºä¾‹"></p>
<h3 id="æ…¢æŸ¥è¯¢æ—¥å¿—çš„é˜…è§ˆå’Œåˆ é™¤"><a href="#æ…¢æŸ¥è¯¢æ—¥å¿—çš„é˜…è§ˆå’Œåˆ é™¤" class="headerlink" title="æ…¢æŸ¥è¯¢æ—¥å¿—çš„é˜…è§ˆå’Œåˆ é™¤"></a>æ…¢æŸ¥è¯¢æ—¥å¿—çš„é˜…è§ˆå’Œåˆ é™¤</h3><p>å¼„æ¸…æ¥šäº†æœåŠ¡å™¨çŠ¶æ€çš„slowlogé“¾è¡¨çš„ä½œç”¨ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä»¥ä¸‹ä¼ªä»£ç æ¥å®šä¹‰æŸ¥çœ‹æ—¥å¿—çš„SLOWLOG GETå‘½ä»¤ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">def SLOWLOG_GET(number=None):</span><br><span class="line"></span><br><span class="line">	# ç”¨æˆ·æ²¡æœ‰ç»™å®šnumberå‚æ•°</span><br><span class="line">	# é‚£ä¹ˆæ‰“å°æœåŠ¡å™¨åŒ…å«çš„å…¨éƒ¨æ…¢æŸ¥è¯¢æ—¥å¿—</span><br><span class="line">	if number is None:</span><br><span class="line">		number = SLOWLOG_LEN()</span><br><span class="line"></span><br><span class="line">	# éå†æœåŠ¡å™¨ä¸­çš„æ…¢æŸ¥è¯¢æ—¥å¿—</span><br><span class="line">	for log in redisServer.slowlog:</span><br><span class="line">		if number &lt;= 0:</span><br><span class="line">			# æ‰“å°çš„æ—¥å¿—æ•°é‡å·²ç»è¶³å¤Ÿï¼Œè·³å‡ºå¾ªç¯</span><br><span class="line">			break</span><br><span class="line">		else:</span><br><span class="line">			# ç»§ç»­æ‰“å°ï¼Œå°†è®¡æ•°å™¨çš„å€¼å‡ä¸€</span><br><span class="line">			number -= 1</span><br><span class="line">			# æ‰“å°æ—¥å¿—</span><br><span class="line">			printLog(log)</span><br></pre></td></tr></table></figure>


<p>æŸ¥çœ‹æ—¥å¿—æ•°é‡çš„SLOWLOG LENå‘½ä»¤å¯ä»¥ç”¨ä»¥ä¸‹ä¼ªä»£ç æ¥å®šä¹‰ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">def SLOWLOG_LEN():</span><br><span class="line">	# slowlogé“¾è¡¨çš„é•¿åº¦å°±æ˜¯æ…¢æŸ¥è¯¢æ—¥å¿—çš„æ¡ç›®æ•°é‡</span><br><span class="line">	return len(redisServer.slowlog)</span><br></pre></td></tr></table></figure>


<p>å¦å¤–ï¼Œç”¨äºæ¸…é™¤æ‰€æœ‰æ…¢æŸ¥è¯¢æ—¥å¿—çš„SLOWLOG RESETå‘½ä»¤å¯ä»¥ç”¨ä»¥ä¸‹ä¼ªä»£ç æ¥å®šä¹‰ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">def SLOWLOG_RESET():</span><br><span class="line">	# éå†æœåŠ¡å™¨ä¸­çš„æ‰€æœ‰æ…¢æŸ¥è¯¢æ—¥å¿—</span><br><span class="line">	for log in redisServer.slowlog:</span><br><span class="line">		# åˆ é™¤æ—¥å¿—</span><br><span class="line">		deleteLog(log)</span><br></pre></td></tr></table></figure>

<h3 id="æ·»åŠ æ–°æ—¥å¿—"><a href="#æ·»åŠ æ–°æ—¥å¿—" class="headerlink" title="æ·»åŠ æ–°æ—¥å¿—"></a>æ·»åŠ æ–°æ—¥å¿—</h3><p>åœ¨æ¯æ¬¡æ‰§è¡Œå‘½ä»¤çš„ä¹‹å‰å’Œä¹‹åï¼Œç¨‹åºéƒ½ä¼šè®°å½•å¾®ç§’æ ¼å¼çš„å½“å‰UNIXæ—¶é—´æˆ³ï¼Œè¿™ä¸¤ä¸ªæ—¶é—´æˆ³ä¹‹é—´çš„å·®å°±æ˜¯æœåŠ¡å™¨æ‰§è¡Œå‘½ä»¤æ‰€è€—è´¹çš„æ—¶é•¿ï¼ŒæœåŠ¡å™¨ä¼šå°†è¿™ä¸ªæ—¶é•¿ä½œä¸ºå‚æ•°ä¹‹ä¸€ä¼ ç»™slowlogPushEntryIfNeededå‡½æ•°ï¼Œè€ŒslowlogPushEntryIfNeededå‡½æ•°åˆ™è´Ÿè´£æ£€æŸ¥æ˜¯å¦éœ€è¦ä¸ºè¿™æ¬¡æ‰§è¡Œçš„å‘½ä»¤åˆ›å»ºæ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œä»¥ä¸‹ä¼ªä»£ç å±•ç¤ºäº†è¿™ä¸€è¿‡ç¨‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># è®°å½•æ‰§è¡Œå‘½ä»¤å‰çš„æ—¶é—´</span><br><span class="line">before = unixtime_now_in_us()</span><br><span class="line"># æ‰§è¡Œå‘½ä»¤</span><br><span class="line">execute_command(argv, argc, client)</span><br><span class="line"># è®°å½•æ‰§è¡Œå‘½ä»¤åçš„æ—¶é—´</span><br><span class="line">after = unixtime_now_in_us()</span><br><span class="line"># æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ›å»ºæ–°çš„æ…¢æŸ¥è¯¢æ—¥å¿—</span><br><span class="line">slowlogPushEntryIfNeeded(argv, argc, before-after)</span><br></pre></td></tr></table></figure>


<p>slowlogPushEntryIfNeededå‡½æ•°çš„ä½œç”¨æœ‰ä¸¤ä¸ªï¼š</p>
<ol>
<li>æ£€æŸ¥å‘½ä»¤çš„æ‰§è¡Œæ—¶é•¿æ˜¯å¦è¶…è¿‡slowlog-log-slower-thané€‰é¡¹æ‰€è®¾ç½®çš„æ—¶é—´ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œå°±ä¸ºå‘½ä»¤åˆ›å»ºä¸€ä¸ªæ–°çš„æ—¥å¿—ï¼Œå¹¶å°†æ–°æ—¥å¿—æ·»åŠ åˆ°slowlogé“¾è¡¨çš„è¡¨å¤´ã€‚</li>
<li>æ£€æŸ¥æ…¢æŸ¥è¯¢æ—¥å¿—çš„é•¿åº¦æ˜¯å¦è¶…è¿‡slowlog-max-lené€‰é¡¹æ‰€è®¾ç½®çš„é•¿åº¦ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œé‚£ä¹ˆå°†å¤šå‡ºæ¥çš„æ—¥å¿—ä»slowlogé“¾è¡¨ä¸­åˆ é™¤æ‰ã€‚</li>
</ol>
<p>ä»¥ä¸‹æ˜¯slowlogPushEntryIfNeededå‡½æ•°çš„å®ç°ä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">slowlogPushEntryIfNeeded</span><span class="params">(robj **argv, <span class="type">int</span> argc, <span class="type">long</span> <span class="type">long</span> duration)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ…¢æŸ¥è¯¢åŠŸèƒ½æœªå¼€å¯ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">	<span class="keyword">if</span> (server.slowlog_log_slower_than &lt; <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">//å¦‚æœæ‰§è¡Œæ—¶é—´è¶…è¿‡æœåŠ¡å™¨è®¾ç½®çš„ä¸Šé™ï¼Œé‚£ä¹ˆå°†å‘½ä»¤æ·»åŠ åˆ°æ…¢æŸ¥è¯¢æ—¥å¿—</span></span><br><span class="line">    <span class="keyword">if</span> (duration &gt;= server.slowlog_log_slower_than)</span><br><span class="line">		<span class="comment">//æ–°æ—¥å¿—æ·»åŠ åˆ°é“¾è¡¨è¡¨å¤´</span></span><br><span class="line">		listAddNodeHead(server.slowlog, slowlogCreateEntry(argv, argc, duration));</span><br><span class="line">	<span class="comment">//å¦‚æœæ—¥å¿—æ•°é‡è¿‡å¤šï¼Œé‚£ä¹ˆè¿›è¡Œåˆ é™¤</span></span><br><span class="line">	<span class="keyword">while</span> (listLength(server.slowlog) &gt; server.slowlog_max_len)</span><br><span class="line">		listDelNode(server.slowlog, listLast(server.slowlog));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ç›‘è§†å™¨"><a href="#ç›‘è§†å™¨" class="headerlink" title="ç›‘è§†å™¨"></a>ç›‘è§†å™¨</h2><p>é€šè¿‡æ‰§è¡ŒMONITORå‘½ä»¤ï¼Œå®¢æˆ·ç«¯å¯ä»¥å°†è‡ªå·±å˜ä¸ºä¸€ä¸ªç›‘è§†å™¨ï¼Œå®æ—¶åœ°æ¥æ”¶å¹¶æ‰“å°å‡ºæœåŠ¡å™¨å½“å‰å¤„ç†çš„å‘½ä»¤è¯·æ±‚çš„ç›¸å…³ä¿¡æ¯ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">redis&gt; MONITOR</span><br><span class="line">OK</span><br><span class="line">1378822099.421623 [0 127.0.0.1:56604] &quot;ING&quot;</span><br><span class="line">1378822105.089572 [0 127.0.0.1:56604] &quot;SET&quot; &quot;msg&quot; &quot;hello world&quot;</span><br><span class="line">1378822109.036925 [0 127.0.0.1:56604] &quot;SET&quot; &quot;number&quot; &quot;123&quot;</span><br><span class="line">1378822140.649496 [0 127.0.0.1:56604] &quot;SADD&quot; &quot;fruits&quot; &quot;Apple&quot; &quot;Banana&quot; &quot;Cherry&quot;</span><br><span class="line">1378822154.117160 [0 127.0.0.1:56604] &quot;EXPIRE&quot; &quot;msg&quot; &quot;10086&quot;</span><br><span class="line">1378822257.329412 [0 127.0.0.1:56604] &quot;KEYS&quot; &quot;*&quot;</span><br><span class="line">1378822258.690131 [0 127.0.0.1:56604] &quot;DBSIZE&quot;</span><br></pre></td></tr></table></figure>


<p>æ¯å½“ä¸€ä¸ªå®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€ä¸€æ¡å‘½ä»¤è¯·æ±‚æ—¶ï¼ŒæœåŠ¡å™¨é™¤äº†ä¼šå¤„ç†è¿™æ¡å‘½ä»¤è¯·æ±‚ä¹‹å¤–ï¼Œè¿˜ä¼šå°†å…³äºè¿™æ¡å‘½ä»¤è¯·æ±‚çš„ä¿¡æ¯å‘é€ç»™æ‰€æœ‰ç›‘è§†å™¨ã€‚</p>
<p><img src="/..%5Cimg%5CRedis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%5C%E5%8F%91%E9%80%81%E4%BF%A1%E6%81%AF%E7%BB%99%E7%9B%91%E8%A7%86%E5%99%A8.png" alt="å‘é€ä¿¡æ¯ç»™ç›‘è§†å™¨"></p>
<h3 id="æˆä¸ºç›‘è§†å™¨"><a href="#æˆä¸ºç›‘è§†å™¨" class="headerlink" title="æˆä¸ºç›‘è§†å™¨"></a>æˆä¸ºç›‘è§†å™¨</h3><p>å‘é€MONITORå‘½ä»¤å¯ä»¥è®©ä¸€ä¸ªæ™®é€šå®¢æˆ·ç«¯å˜ä¸ºä¸€ä¸ªç›‘è§†å™¨ï¼Œè¯¥å‘½ä»¤çš„å®ç°åŸç†å¯ä»¥ç”¨ä»¥ä¸‹ä¼ªä»£ç æ¥å®ç°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">def MONITOR()âˆ¶</span><br><span class="line">	# æ‰“å¼€å®¢æˆ·ç«¯çš„ç›‘è§†å™¨æ ‡å¿—</span><br><span class="line">	client.flags |= REDIS_MONITOR</span><br><span class="line">	# å°†å®¢æˆ·ç«¯æ·»åŠ åˆ°æœåŠ¡å™¨çŠ¶æ€çš„monitorsé“¾è¡¨çš„æœ«å°¾</span><br><span class="line">	server.monitors.append(client)</span><br><span class="line">	# å‘å®¢æˆ·ç«¯è¿”å›OK</span><br><span class="line">	send_reply(&quot;OK&quot;)</span><br></pre></td></tr></table></figure>

<h3 id="å‘ç›‘è§†å™¨å‘é€å‘½ä»¤ä¿¡æ¯"><a href="#å‘ç›‘è§†å™¨å‘é€å‘½ä»¤ä¿¡æ¯" class="headerlink" title="å‘ç›‘è§†å™¨å‘é€å‘½ä»¤ä¿¡æ¯"></a>å‘ç›‘è§†å™¨å‘é€å‘½ä»¤ä¿¡æ¯</h3><p>æœåŠ¡å™¨åœ¨æ¯æ¬¡å¤„ç†å‘½ä»¤è¯·æ±‚ä¹‹å‰ï¼Œéƒ½ä¼šè°ƒç”¨replicationFeedMonitorså‡½æ•°ï¼Œç”±è¿™ä¸ªå‡½æ•°å°†è¢«å¤„ç†çš„å‘½ä»¤è¯·æ±‚çš„ç›¸å…³ä¿¡æ¯å‘é€ç»™å„ä¸ªç›‘è§†å™¨ã€‚</p>
<p>ä»¥ä¸‹æ˜¯replicationFeedMonitorså‡½æ•°çš„ä¼ªä»£ç å®šä¹‰ï¼Œå‡½æ•°é¦–å…ˆæ ¹æ®ä¼ å…¥çš„å‚æ•°åˆ›å»ºä¿¡æ¯ï¼Œç„¶åå°†ä¿¡æ¯å‘é€ç»™æ‰€æœ‰ç›‘è§†å™¨ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">def replicationFeedMonitors(client, monitors, dbid, argv, argc):</span><br><span class="line">	# æ ¹æ®æ‰§è¡Œå‘½ä»¤çš„å®¢æˆ·ç«¯ã€å½“å‰æ•°æ®åº“çš„å·ç ã€å‘½ä»¤å‚æ•°ã€å‘½ä»¤å‚æ•°ä¸ªæ•°ç­‰å‚æ•°</span><br><span class="line">	# åˆ›å»ºè¦å‘é€ç»™å„ä¸ªç›‘è§†å™¨çš„ä¿¡æ¯</span><br><span class="line">	msg = create_message(client, dbid, argv, argc)</span><br><span class="line">	# éå†æ‰€æœ‰ç›‘è§†å™¨</span><br><span class="line">	for monitor in monitors:</span><br><span class="line">		# å°†ä¿¡æ¯å‘é€ç»™ç›‘è§†å™¨</span><br><span class="line">		send_message(monitor, msg)</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="http://example.com">lzl121373</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="http://example.com/2022/09/25/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86/">http://example.com/2022/09/25/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="http://example.com" target="_blank">ğŸ˜Š</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Redis/">Redis</a><a class="post-meta__tags" href="/tags/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/">Redisè®¾è®¡ä¸å®ç°</a><a class="post-meta__tags" href="/tags/%E7%8B%AC%E7%AB%8B%E5%8A%9F%E8%83%BD%E7%9A%84%E5%AE%9E%E7%8E%B0/">ç‹¬ç«‹åŠŸèƒ½çš„å®ç°</a><a class="post-meta__tags" href="/tags/%E5%8F%91%E5%B8%83%E4%B8%8E%E8%AE%A2%E9%98%85/">å‘å¸ƒä¸è®¢é˜…</a><a class="post-meta__tags" href="/tags/%E4%BA%8B%E5%8A%A1/">äº‹åŠ¡</a><a class="post-meta__tags" href="/tags/Lua%E8%84%9A%E6%9C%AC/">Luaè„šæœ¬</a><a class="post-meta__tags" href="/tags/%E6%8E%92%E5%BA%8F/">æ’åº</a><a class="post-meta__tags" href="/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6%E4%BD%8D%E6%95%B0%E7%BB%84/">äºŒè¿›åˆ¶ä½æ•°ç»„</a><a class="post-meta__tags" href="/tags/%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97/">æ…¢æŸ¥è¯¢æ—¥å¿—</a><a class="post-meta__tags" href="/tags/%E7%9B%91%E8%A7%86%E5%99%A8/">ç›‘è§†å™¨</a></div><div class="post_share"><div class="social-share" data-image="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/gh/overtrue/share.js@master/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2022/08/28/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86/"><img class="next-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">&lt;Redisè®¾è®¡ä¸å®ç°&gt;ç¬¬ä¸‰éƒ¨åˆ†</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><div><a href="/2022/05/13/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86/" title="&lt;Redisè®¾è®¡ä¸å®ç°&gt;ç¬¬ä¸€éƒ¨åˆ†"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-05-13</div><div class="title">&lt;Redisè®¾è®¡ä¸å®ç°&gt;ç¬¬ä¸€éƒ¨åˆ†</div></div></a></div><div><a href="/2022/08/28/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86/" title="&lt;Redisè®¾è®¡ä¸å®ç°&gt;ç¬¬ä¸‰éƒ¨åˆ†"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-28</div><div class="title">&lt;Redisè®¾è®¡ä¸å®ç°&gt;ç¬¬ä¸‰éƒ¨åˆ†</div></div></a></div><div><a href="/2022/05/29/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86/" title="&lt;Redisè®¾è®¡ä¸å®ç°&gt;ç¬¬äºŒéƒ¨åˆ†"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-05-29</div><div class="title">&lt;Redisè®¾è®¡ä¸å®ç°&gt;ç¬¬äºŒéƒ¨åˆ†</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">lzl121373</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">11</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">51</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">2</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/lzl121373" target="_blank" title="Github"><i class="fab fa-github"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>å…¬å‘Š</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%8B%AC%E7%AB%8B%E5%8A%9F%E8%83%BD%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.</span> <span class="toc-text">ç‹¬ç«‹åŠŸèƒ½çš„å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%91%E5%B8%83%E4%B8%8E%E8%AE%A2%E9%98%85"><span class="toc-number">1.1.</span> <span class="toc-text">å‘å¸ƒä¸è®¢é˜…</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%91%E9%81%93%E7%9A%84%E8%AE%A2%E9%98%85%E4%B8%8E%E9%80%80%E8%AE%A2"><span class="toc-number">1.1.1.</span> <span class="toc-text">é¢‘é“çš„è®¢é˜…ä¸é€€è®¢</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%A2%E9%98%85%E9%A2%91%E9%81%93"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">è®¢é˜…é¢‘é“</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%80%E8%AE%A2%E9%A2%91%E9%81%93"><span class="toc-number">1.1.1.2.</span> <span class="toc-text">é€€è®¢é¢‘é“</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E5%BC%8F%E7%9A%84%E8%AE%A2%E9%98%85%E4%B8%8E%E9%80%80%E8%AE%A2"><span class="toc-number">1.1.2.</span> <span class="toc-text">æ¨¡å¼çš„è®¢é˜…ä¸é€€è®¢</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">è®¢é˜…æ¨¡å¼</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%80%E8%AE%A2%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">é€€è®¢æ¨¡å¼</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF"><span class="toc-number">1.1.3.</span> <span class="toc-text">å‘é€æ¶ˆæ¯</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81%E7%BB%99%E9%A2%91%E9%81%93%E8%AE%A2%E9%98%85%E8%80%85"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">å°†æ¶ˆæ¯å‘é€ç»™é¢‘é“è®¢é˜…è€…</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81%E7%BB%99%E6%A8%A1%E5%BC%8F%E8%AE%A2%E9%98%85%E8%80%85"><span class="toc-number">1.1.3.2.</span> <span class="toc-text">å°†æ¶ˆæ¯å‘é€ç»™æ¨¡å¼è®¢é˜…è€…</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E8%AE%A2%E9%98%85%E6%B6%88%E6%81%AF"><span class="toc-number">1.1.4.</span> <span class="toc-text">æŸ¥çœ‹è®¢é˜…æ¶ˆæ¯</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#PUBSUB-CHANNELS"><span class="toc-number">1.1.4.1.</span> <span class="toc-text">PUBSUB CHANNELS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PUBSUB-NUMSUB"><span class="toc-number">1.1.4.2.</span> <span class="toc-text">PUBSUB NUMSUB</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PUBSUB-NUMPAT"><span class="toc-number">1.1.4.3.</span> <span class="toc-text">PUBSUB NUMPAT</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1"><span class="toc-number">1.2.</span> <span class="toc-text">äº‹åŠ¡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.2.1.</span> <span class="toc-text">äº‹åŠ¡çš„å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E5%BC%80%E5%A7%8B"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">äº‹åŠ¡å¼€å§‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E5%85%A5%E9%98%9F"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">å‘½ä»¤å…¥é˜Ÿ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E9%98%9F%E5%88%97"><span class="toc-number">1.2.1.3.</span> <span class="toc-text">äº‹åŠ¡é˜Ÿåˆ—</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E4%BA%8B%E5%8A%A1"><span class="toc-number">1.2.1.4.</span> <span class="toc-text">æ‰§è¡Œäº‹åŠ¡</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WATCH%E5%91%BD%E4%BB%A4%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.2.2.</span> <span class="toc-text">WATCHå‘½ä»¤çš„å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8WATCH%E5%91%BD%E4%BB%A4%E7%9B%91%E8%A7%86%E6%95%B0%E6%8D%AE%E5%BA%93%E9%94%AE"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">ä½¿ç”¨WATCHå‘½ä»¤ç›‘è§†æ•°æ®åº“é”®</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%91%E8%A7%86%E6%9C%BA%E5%88%B6%E7%9A%84%E8%A7%A6%E5%8F%91"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">ç›‘è§†æœºåˆ¶çš„è§¦å‘</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A4%E6%96%AD%E4%BA%8B%E5%8A%A1%E6%98%AF%E5%90%A6%E5%AE%89%E5%85%A8"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">åˆ¤æ–­äº‹åŠ¡æ˜¯å¦å®‰å…¨</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E7%9A%84ACID%E6%80%A7%E8%B4%A8"><span class="toc-number">1.2.3.</span> <span class="toc-text">äº‹åŠ¡çš„ACIDæ€§è´¨</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E5%AD%90%E6%80%A7"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">åŸå­æ€§</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">ä¸€è‡´æ€§</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%85%A5%E9%98%9F%E9%94%99%E8%AF%AF"><span class="toc-number">1.2.3.2.1.</span> <span class="toc-text">å…¥é˜Ÿé”™è¯¯</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E9%94%99%E8%AF%AF"><span class="toc-number">1.2.3.2.2.</span> <span class="toc-text">æ‰§è¡Œé”™è¯¯</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%81%9C%E6%9C%BA"><span class="toc-number">1.2.3.2.3.</span> <span class="toc-text">æœåŠ¡å™¨åœæœº</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9A%94%E7%A6%BB%E6%80%A7"><span class="toc-number">1.2.3.3.</span> <span class="toc-text">éš”ç¦»æ€§</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%80%90%E4%B9%85%E6%80%A7"><span class="toc-number">1.2.3.4.</span> <span class="toc-text">è€ä¹…æ€§</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lua%E8%84%9A%E6%9C%AC"><span class="toc-number">1.3.</span> <span class="toc-text">Luaè„šæœ¬</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%B9%B6%E4%BF%AE%E6%94%B9Lua%E7%8E%AF%E5%A2%83"><span class="toc-number">1.3.1.</span> <span class="toc-text">åˆ›å»ºå¹¶ä¿®æ”¹Luaç¯å¢ƒ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BALua%E7%8E%AF%E5%A2%83"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">åˆ›å»ºLuaç¯å¢ƒ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BD%BD%E5%85%A5%E5%87%BD%E6%95%B0%E5%BA%93"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">è½½å…¥å‡½æ•°åº“</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAredis%E5%85%A8%E5%B1%80%E8%A1%A8%E6%A0%BC"><span class="toc-number">1.3.1.3.</span> <span class="toc-text">åˆ›å»ºrediså…¨å±€è¡¨æ ¼</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Redis%E8%87%AA%E5%88%B6%E7%9A%84%E9%9A%8F%E6%9C%BA%E5%87%BD%E6%95%B0%E6%9D%A5%E6%9B%BF%E6%8D%A2Lua%E5%8E%9F%E6%9C%89%E7%9A%84%E9%9A%8F%E6%9C%BA%E5%87%BD%E6%95%B0"><span class="toc-number">1.3.1.4.</span> <span class="toc-text">ä½¿ç”¨Redisè‡ªåˆ¶çš„éšæœºå‡½æ•°æ¥æ›¿æ¢LuaåŸæœ‰çš„éšæœºå‡½æ•°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%8E%92%E5%BA%8F%E8%BE%85%E5%8A%A9%E5%87%BD%E6%95%B0"><span class="toc-number">1.3.1.5.</span> <span class="toc-text">åˆ›å»ºæ’åºè¾…åŠ©å‡½æ•°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAredis-pcall%E5%87%BD%E6%95%B0%E7%9A%84%E9%94%99%E8%AF%AF%E6%8A%A5%E5%91%8A%E8%BE%85%E5%8A%A9%E5%87%BD%E6%95%B0"><span class="toc-number">1.3.1.6.</span> <span class="toc-text">åˆ›å»ºredis.pcallå‡½æ•°çš„é”™è¯¯æŠ¥å‘Šè¾…åŠ©å‡½æ•°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%9D%E6%8A%A4Lua%E7%9A%84%E5%85%A8%E5%B1%80%E7%8E%AF%E5%A2%83"><span class="toc-number">1.3.1.7.</span> <span class="toc-text">ä¿æŠ¤Luaçš„å…¨å±€ç¯å¢ƒ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86Lua%E7%8E%AF%E5%A2%83%E4%BF%9D%E5%AD%98%E5%88%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%8A%B6%E6%80%81%E7%9A%84lua%E5%B1%9E%E6%80%A7%E9%87%8C%E9%9D%A2"><span class="toc-number">1.3.1.8.</span> <span class="toc-text">å°†Luaç¯å¢ƒä¿å­˜åˆ°æœåŠ¡å™¨çŠ¶æ€çš„luaå±æ€§é‡Œé¢</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Lua%E7%8E%AF%E5%A2%83%E5%8D%8F%E4%BD%9C%E7%BB%84%E4%BB%B6"><span class="toc-number">1.3.2.</span> <span class="toc-text">Luaç¯å¢ƒåä½œç»„ä»¶</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%AA%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">ä¼ªå®¢æˆ·ç«¯</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#lua-scripts%E5%AD%97%E5%85%B8"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">lua_scriptså­—å…¸</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EVAL%E5%91%BD%E4%BB%A4%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.3.3.</span> <span class="toc-text">EVALå‘½ä»¤çš„å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E8%84%9A%E6%9C%AC%E5%87%BD%E6%95%B0"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">å®šä¹‰è„šæœ¬å‡½æ•°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86%E8%84%9A%E6%9C%AC%E4%BF%9D%E5%AD%98%E5%88%B0lua-scripts%E5%AD%97%E5%85%B8"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">å°†è„šæœ¬ä¿å­˜åˆ°lua_scriptså­—å…¸</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E8%84%9A%E6%9C%AC%E5%87%BD%E6%95%B0"><span class="toc-number">1.3.3.3.</span> <span class="toc-text">æ‰§è¡Œè„šæœ¬å‡½æ•°</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EVALSHA%E5%91%BD%E4%BB%A4%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.3.4.</span> <span class="toc-text">EVALSHAå‘½ä»¤çš„å®ç°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%84%9A%E6%9C%AC%E7%AE%A1%E7%90%86%E5%91%BD%E4%BB%A4%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.3.5.</span> <span class="toc-text">è„šæœ¬ç®¡ç†å‘½ä»¤çš„å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SCRIPT-FLUSH"><span class="toc-number">1.3.5.1.</span> <span class="toc-text">SCRIPT FLUSH</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SCRIPT-EXISTS"><span class="toc-number">1.3.5.2.</span> <span class="toc-text">SCRIPT EXISTS</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SCRIPT-LOAD"><span class="toc-number">1.3.5.3.</span> <span class="toc-text">SCRIPT LOAD</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SCRIPT-KILL"><span class="toc-number">1.3.5.4.</span> <span class="toc-text">SCRIPT KILL</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%84%9A%E6%9C%AC%E5%A4%8D%E5%88%B6"><span class="toc-number">1.3.6.</span> <span class="toc-text">è„šæœ¬å¤åˆ¶</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%8D%E5%88%B6EVAL%E5%91%BD%E4%BB%A4%E3%80%81SCRIPT-FLUSH%E5%91%BD%E4%BB%A4%E5%92%8CSCRIPT-LOAD%E5%91%BD%E4%BB%A4"><span class="toc-number">1.3.6.1.</span> <span class="toc-text">å¤åˆ¶EVALå‘½ä»¤ã€SCRIPT FLUSHå‘½ä»¤å’ŒSCRIPT LOADå‘½ä»¤</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#EVAL"><span class="toc-number">1.3.6.1.1.</span> <span class="toc-text">EVAL</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SCRIPT-FLUSH-1"><span class="toc-number">1.3.6.1.2.</span> <span class="toc-text">SCRIPT FLUSH</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SCRIPT-LOAD-1"><span class="toc-number">1.3.6.1.3.</span> <span class="toc-text">SCRIPT LOAD</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%8D%E5%88%B6EVALSHA%E5%91%BD%E4%BB%A4"><span class="toc-number">1.3.6.2.</span> <span class="toc-text">å¤åˆ¶EVALSHAå‘½ä»¤</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%A4%E6%96%AD%E4%BC%A0%E6%92%ADEVALSHA%E5%91%BD%E4%BB%A4%E6%98%AF%E5%90%A6%E5%AE%89%E5%85%A8%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">1.3.6.2.1.</span> <span class="toc-text">åˆ¤æ–­ä¼ æ’­EVALSHAå‘½ä»¤æ˜¯å¦å®‰å…¨çš„æ–¹æ³•</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B8%85%E7%A9%BArepl-scriptcache-dict%E5%AD%97%E5%85%B8"><span class="toc-number">1.3.6.2.2.</span> <span class="toc-text">æ¸…ç©ºrepl_scriptcache_dictå­—å…¸</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#EVALSHA%E5%91%BD%E4%BB%A4%E8%BD%AC%E6%8D%A2%E6%88%90EVAL%E5%91%BD%E4%BB%A4%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">1.3.6.2.3.</span> <span class="toc-text">EVALSHAå‘½ä»¤è½¬æ¢æˆEVALå‘½ä»¤çš„æ–¹æ³•</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BC%A0%E6%92%ADEVALSHA%E5%91%BD%E4%BB%A4%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">1.3.6.2.4.</span> <span class="toc-text">ä¼ æ’­EVALSHAå‘½ä»¤çš„æ–¹æ³•</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%92%E5%BA%8F"><span class="toc-number">1.4.</span> <span class="toc-text">æ’åº</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SORT-lt-key-gt-%E5%91%BD%E4%BB%A4%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.4.1.</span> <span class="toc-text">SORT &lt;key&gt;å‘½ä»¤çš„å®ç°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ALPHA%E9%80%89%E9%A1%B9%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.4.2.</span> <span class="toc-text">ALPHAé€‰é¡¹çš„å®ç°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ASC%E9%80%89%E9%A1%B9%E5%92%8CDESC%E9%80%89%E9%A1%B9"><span class="toc-number">1.4.3.</span> <span class="toc-text">ASCé€‰é¡¹å’ŒDESCé€‰é¡¹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BY%E9%80%89%E9%A1%B9%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.4.4.</span> <span class="toc-text">BYé€‰é¡¹çš„å®ç°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%A6%E6%9C%89ALPHA%E9%80%89%E9%A1%B9%E7%9A%84BY%E9%80%89%E9%A1%B9%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.4.5.</span> <span class="toc-text">å¸¦æœ‰ALPHAé€‰é¡¹çš„BYé€‰é¡¹çš„å®ç°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LIMIT%E9%80%89%E9%A1%B9%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.4.6.</span> <span class="toc-text">LIMITé€‰é¡¹çš„å®ç°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GET%E9%80%89%E9%A1%B9%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.4.7.</span> <span class="toc-text">GETé€‰é¡¹çš„å®ç°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#STORE%E9%80%89%E9%A1%B9%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.4.8.</span> <span class="toc-text">STOREé€‰é¡¹çš„å®ç°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E4%B8%AA%E9%80%89%E9%A1%B9%E7%9A%84%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"><span class="toc-number">1.4.9.</span> <span class="toc-text">å¤šä¸ªé€‰é¡¹çš„æ‰§è¡Œé¡ºåº</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%89%E9%A1%B9%E7%9A%84%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"><span class="toc-number">1.4.9.1.</span> <span class="toc-text">é€‰é¡¹çš„æ‰§è¡Œé¡ºåº</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%89%E9%A1%B9%E7%9A%84%E6%91%86%E6%94%BE%E9%A1%BA%E5%BA%8F"><span class="toc-number">1.4.9.2.</span> <span class="toc-text">é€‰é¡¹çš„æ‘†æ”¾é¡ºåº</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E4%BD%8D%E6%95%B0%E7%BB%84"><span class="toc-number">1.5.</span> <span class="toc-text">äºŒè¿›åˆ¶ä½æ•°ç»„</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%8D%E6%95%B0%E7%BB%84%E7%9A%84%E8%A1%A8%E7%A4%BA"><span class="toc-number">1.5.1.</span> <span class="toc-text">ä½æ•°ç»„çš„è¡¨ç¤º</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GETBIT%E5%91%BD%E4%BB%A4%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.5.2.</span> <span class="toc-text">GETBITå‘½ä»¤çš„å®ç°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SETBIT%E5%91%BD%E4%BB%A4%E7%9A%84%E5%AE%8C%E6%88%90"><span class="toc-number">1.5.3.</span> <span class="toc-text">SETBITå‘½ä»¤çš„å®Œæˆ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%A6%E6%89%A9%E5%B1%95%E6%93%8D%E4%BD%9C%E7%9A%84SETBIT%E5%91%BD%E4%BB%A4%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.5.3.1.</span> <span class="toc-text">å¸¦æ‰©å±•æ“ä½œçš„SETBITå‘½ä»¤ç¤ºä¾‹</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BITCOUNT%E5%91%BD%E4%BB%A4%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.5.4.</span> <span class="toc-text">BITCOUNTå‘½ä»¤çš„å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E4%BD%8D%E7%BB%9F%E8%AE%A1%E7%AE%97%E6%B3%95%EF%BC%881%EF%BC%89%EF%BC%9A%E9%81%8D%E5%8E%86%E7%AE%97%E6%B3%95"><span class="toc-number">1.5.4.1.</span> <span class="toc-text">äºŒè¿›åˆ¶ä½ç»Ÿè®¡ç®—æ³•ï¼ˆ1ï¼‰ï¼šéå†ç®—æ³•</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E4%BD%8D%E7%BB%9F%E8%AE%A1%E7%AE%97%E6%B3%95%EF%BC%882%EF%BC%89%EF%BC%9A%E6%9F%A5%E8%A1%A8%E7%AE%97%E6%B3%95"><span class="toc-number">1.5.4.2.</span> <span class="toc-text">äºŒè¿›åˆ¶ä½ç»Ÿè®¡ç®—æ³•ï¼ˆ2ï¼‰ï¼šæŸ¥è¡¨ç®—æ³•</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E4%BD%8D%E7%BB%9F%E8%AE%A1%E7%AE%97%E6%B3%95%EF%BC%883%EF%BC%89%EF%BC%9Avariable-precision-SWAR%E7%AE%97%E6%B3%95"><span class="toc-number">1.5.4.3.</span> <span class="toc-text">äºŒè¿›åˆ¶ä½ç»Ÿè®¡ç®—æ³•ï¼ˆ3ï¼‰ï¼švariable-precision SWARç®—æ³•</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E4%BD%8D%E7%BB%9F%E8%AE%A1%E7%AE%97%E6%B3%95%EF%BC%884%EF%BC%89%EF%BC%9ARedis%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.5.4.4.</span> <span class="toc-text">äºŒè¿›åˆ¶ä½ç»Ÿè®¡ç®—æ³•ï¼ˆ4ï¼‰ï¼šRedisçš„å®ç°</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BITOP%E5%91%BD%E4%BB%A4%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.5.5.</span> <span class="toc-text">BITOPå‘½ä»¤çš„å®ç°</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97"><span class="toc-number">1.6.</span> <span class="toc-text">æ…¢æŸ¥è¯¢æ—¥å¿—</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%85%A2%E6%9F%A5%E8%AF%A2%E8%AE%B0%E5%BD%95%E7%9A%84%E4%BF%9D%E5%AD%98"><span class="toc-number">1.6.1.</span> <span class="toc-text">æ…¢æŸ¥è¯¢è®°å½•çš„ä¿å­˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97%E7%9A%84%E9%98%85%E8%A7%88%E5%92%8C%E5%88%A0%E9%99%A4"><span class="toc-number">1.6.2.</span> <span class="toc-text">æ…¢æŸ¥è¯¢æ—¥å¿—çš„é˜…è§ˆå’Œåˆ é™¤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E6%96%B0%E6%97%A5%E5%BF%97"><span class="toc-number">1.6.3.</span> <span class="toc-text">æ·»åŠ æ–°æ—¥å¿—</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%91%E8%A7%86%E5%99%A8"><span class="toc-number">1.7.</span> <span class="toc-text">ç›‘è§†å™¨</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%88%90%E4%B8%BA%E7%9B%91%E8%A7%86%E5%99%A8"><span class="toc-number">1.7.1.</span> <span class="toc-text">æˆä¸ºç›‘è§†å™¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%91%E7%9B%91%E8%A7%86%E5%99%A8%E5%8F%91%E9%80%81%E5%91%BD%E4%BB%A4%E4%BF%A1%E6%81%AF"><span class="toc-number">1.7.2.</span> <span class="toc-text">å‘ç›‘è§†å™¨å‘é€å‘½ä»¤ä¿¡æ¯</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/09/25/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86/" title="&lt;Redisè®¾è®¡ä¸å®ç°&gt;ç¬¬å››éƒ¨åˆ†"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="&lt;Redisè®¾è®¡ä¸å®ç°&gt;ç¬¬å››éƒ¨åˆ†"/></a><div class="content"><a class="title" href="/2022/09/25/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E7%AC%AC%E5%9B%9B%E9%83%A8%E5%88%86/" title="&lt;Redisè®¾è®¡ä¸å®ç°&gt;ç¬¬å››éƒ¨åˆ†">&lt;Redisè®¾è®¡ä¸å®ç°&gt;ç¬¬å››éƒ¨åˆ†</a><time datetime="2022-09-24T16:00:00.000Z" title="å‘è¡¨äº 2022-09-25 00:00:00">2022-09-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/08/28/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86/" title="&lt;Redisè®¾è®¡ä¸å®ç°&gt;ç¬¬ä¸‰éƒ¨åˆ†"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="&lt;Redisè®¾è®¡ä¸å®ç°&gt;ç¬¬ä¸‰éƒ¨åˆ†"/></a><div class="content"><a class="title" href="/2022/08/28/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86/" title="&lt;Redisè®¾è®¡ä¸å®ç°&gt;ç¬¬ä¸‰éƒ¨åˆ†">&lt;Redisè®¾è®¡ä¸å®ç°&gt;ç¬¬ä¸‰éƒ¨åˆ†</a><time datetime="2022-08-27T16:00:00.000Z" title="å‘è¡¨äº 2022-08-28 00:00:00">2022-08-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/05/29/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86/" title="&lt;Redisè®¾è®¡ä¸å®ç°&gt;ç¬¬äºŒéƒ¨åˆ†"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="&lt;Redisè®¾è®¡ä¸å®ç°&gt;ç¬¬äºŒéƒ¨åˆ†"/></a><div class="content"><a class="title" href="/2022/05/29/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86/" title="&lt;Redisè®¾è®¡ä¸å®ç°&gt;ç¬¬äºŒéƒ¨åˆ†">&lt;Redisè®¾è®¡ä¸å®ç°&gt;ç¬¬äºŒéƒ¨åˆ†</a><time datetime="2022-05-28T16:00:00.000Z" title="å‘è¡¨äº 2022-05-29 00:00:00">2022-05-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/05/13/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86/" title="&lt;Redisè®¾è®¡ä¸å®ç°&gt;ç¬¬ä¸€éƒ¨åˆ†"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="&lt;Redisè®¾è®¡ä¸å®ç°&gt;ç¬¬ä¸€éƒ¨åˆ†"/></a><div class="content"><a class="title" href="/2022/05/13/Redis%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86/" title="&lt;Redisè®¾è®¡ä¸å®ç°&gt;ç¬¬ä¸€éƒ¨åˆ†">&lt;Redisè®¾è®¡ä¸å®ç°&gt;ç¬¬ä¸€éƒ¨åˆ†</a><time datetime="2022-05-12T16:00:00.000Z" title="å‘è¡¨äº 2022-05-13 00:00:00">2022-05-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/05/09/STL%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E7%AC%AC%E4%B8%83%E7%AB%A0/" title="&lt;STLæºç å‰–æ&gt;ç¬¬ä¸ƒç« â€”â€”ä»¿å‡½æ•°"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="&lt;STLæºç å‰–æ&gt;ç¬¬ä¸ƒç« â€”â€”ä»¿å‡½æ•°"/></a><div class="content"><a class="title" href="/2022/05/09/STL%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90%E7%AC%AC%E4%B8%83%E7%AB%A0/" title="&lt;STLæºç å‰–æ&gt;ç¬¬ä¸ƒç« â€”â€”ä»¿å‡½æ•°">&lt;STLæºç å‰–æ&gt;ç¬¬ä¸ƒç« â€”â€”ä»¿å‡½æ•°</a><time datetime="2022-05-08T16:00:00.000Z" title="å‘è¡¨äº 2022-05-09 00:00:00">2022-05-09</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By lzl121373</div><div class="framework-info"><span>æ¡†æ¶ </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>ä¸»é¢˜ </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>